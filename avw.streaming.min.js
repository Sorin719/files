!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).avw={})}(this,(function(e){"use strict";class t{constructor(e,t){return this.layer=e.layer||"",this.name=e.name||"",this.type=e.type||"",this._x=0,this._y=0,this.zOrder=e.zOrder||0,this._z=0,t&&t(1),this}}var n={_feedbackUrl:"",_appId:"",randomString:function(e){e=e||32;for(var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678",i=t.length,n="",r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*i));return n},colorToRGBAObject:e=>"string"!=typeof(e=""+e)?{r:1,g:1,b:1,a:1}:("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:1}:/^[0-9a-fA-F]{8}$/.test(e)?{r:parseInt(e.substr(0,2),16)/255,g:parseInt(e.substr(2,2),16)/255,b:parseInt(e.substr(4,2),16)/255,a:parseInt(e.substr(6,2),16)/255}:void 0),colorToRGBAString:e=>"string"!=typeof(e=""+e)?"rgba (1, 1, 1, 1)":("#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),/^[0-9a-fA-F]{6}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, 1)`:/^[0-9a-fA-F]{8}$/.test(e)?`rgba (${parseInt(e.substr(0,2),16)/255}, ${parseInt(e.substr(2,2),16)/255}, ${parseInt(e.substr(4,2),16)/255}, ${parseInt(e.substr(6,2),16)/255})`:void 0),randomRGBAObject:()=>({r:Math.random(),g:Math.random(),b:Math.random(),a:.5+.5*Math.random()}),randomRGBAString:()=>`rgba (${Math.random()}, ${Math.random()}, ${Math.random()}, ${.5+.5*Math.random()})`,addDegrees:(e,t)=>e&&t&&e.lon&&e.lat&&t.lon&&t.lat?{lon:e.lon+t.lon,lat:e.lat+t.lat,alt:e.alt?t.alt?e.alt+t.alt:e.alt:t.alt?t.alt:0}:{lon:0,lat:0,alt:0},unifyCoordinates(e,t){if(t){switch("surface"===e.type.toLowerCase()&&(e.type="Surface"),"ecef"===e.type.toLowerCase()&&(e.type="ECEF"),"planarglobal"===e.type.toLowerCase()&&(e.type="PlanarGlobal"),"planarlocal"===e.type.toLowerCase()&&(e.type="PlanarLocal"),"default"===e.type.toLowerCase()&&(e.type="default"),e.type.toLowerCase()){case"surface":let i=t({X:e.lon,Y:e.lat,Z:e.alt},"Surface");e.x=i.x,e.y=0-i.z,e.z=0-i.y}return e}},fetchJSON(e,t,i,n,r){switch(t.toLowerCase()){case"get":case"delete":case"post":t="POST";break;case"put":break;default:t="GET"}let o=this;return new Promise((function(s,a){let l=new XMLHttpRequest;if(l.onreadystatechange=function(){4==l.readyState&&(200==l.status||204==l.status?(s(l.responseText),r&&r(1,JSON.parse(l.responseText),"成功！")):(a(new Error(l.statusText)),r&&r(0,JSON.parse(l.responseText),"失败！")))},l.open(t,o._feedbackUrl+e,!0),i instanceof Array)for(header of i)l.setRequestHeader(header.key,header.value);l.send(JSON.stringify(n))}))}};class r{constructor(e,t){this._drawables=[],this.name=e.name||"",this.show="boolean"!=typeof e.show||e.show,this.tags=e.tags||[],this.zLevel=e.zLevel||0,t&&t(1)}action(e,t){return t&&t(1),this}addDrawable(e,t){return e.name&&""!==e.name||(e.name=n.randomString(8)),this.getDrawable(e.name)?(t&&t(0,`已存在同名绘制物（${e.name}) 。`),this):(e.parent=this.name,this._drawables.push(e),t(1,"成功。"),this)}addDrawables(e,t){for(let i=0;i<e.length;i++){if(e[i].name&&""!==e[i].name||(e[i].name=n.randomString(8)),this.getDrawable(e[i].name))return t&&t(0,`已存在同名绘制物（${e[i].name}) 。`),this;e[i].parent=this.name,this._drawables.push(e[i])}return t(1,"成功。"),this}clearDrawables(e){return this._drawables=[],e&&e(1,"成功。"),this}hide(){return this}getDrawables(){return this._drawables}getDrawable(e){for(let t of this._drawables)if(t.name===e)return t}removeDrawable(e,t){for(let i=0;i<this._drawables.length;i++)if(this._drawables[i].name===e)return this._drawables.splice(i,1),t&&t(1),this;return t&&t(0,`未找到名为 ${e} 的绘制物。`),this}resetAction(){return callback&&callback(1),this}show(){return this}tag(e,t){return this.tags.push(""),this}toString(){return""}toJson(){return JSON.stringify(this._drawables)}updateDrawable(e,t){for(let i=0;i<this._drawables.length;i++)if(this._drawables[i].name===e)return void(this._drawables[i]=t)}}class o extends t{constructor(e,t){super(e),this.farFactor=e.farFactor||.5,this.func=e.func||!1,this.guid=e.guid,this.icon=e.icon||"default",this.iconHorizontalTranslation=e.iconHorizontalTranslation||0,this.iconVerticalTranslation=e.iconVerticalTranslation||0,this.initShowTooltip=e.initShowTooltip||!1,this.iconScale=e.iconScale||1,this.largeIconMinDistance=e.largeIconMinDistance||0,this.labelFontSize=e.labelFontSize||12,this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.middleIconMinDistance=e.middleIconMinDistance||1e3,this.markerType=e.markerType||"icon",this.nearFactor=e.nearFactor||1,this.position=e.position,this.parent=e.parent,this.pointColor=e.pointColor||"#FFFFFF",this.pointSize=e.pointSize||10,this.pointMaxDistance=e.pointMaxDistance||1e5,this.pointMinDistance=e.pointMinDistance||1e4,this.smallIconMinDistance=e.smallIconMinDistance||3e3,this.show="boolean"!=typeof e.show||e.show,this.tooltipEnabled="boolean"!=typeof e.tooltipEnabled||e.tooltipEnabled,this.tooltipText=e.tooltipText||"",this.tooltipBackground=e.tooltipBackground||"rgb(0 0 0 / 0.6)",this.tooltipBackgroundBorderColor=e.tooltipBackgroundBorderColor||"#000",this.tooltipBackgroundBorderThickness=e.tooltipBackgroundBorderThickness||"0",this.tooltipShadowEnabled="boolean"!=typeof e.tooltipShadowEnabled||e.tooltipShadowEnabled,this.tooltipHorOffset=e.tooltipHorOffset||0,this.tooltipVerOffset=e.tooltipVerOffset||0,this.tooltipForeground=e.tooltipForeground||"#fff",this.tooltipFontSize=e.tooltipFontSize||18,this.tooltipFontBold=!0===e.tooltipFontBold?"bold":"normal",this.tooltipFontItalic=!0===e.tooltipFontItalic?"italic":"normal",this.tooltipTriggerEvent=e.tooltipTriggerEvent||"click",this.textInfo=e.textInfo=e.textInfo||"",this.animationType=e.animationType||"无",this.animationDuration=e.animationDuration||1,this.tooltip=!1,this.tag=e.tag,t&&t(1)}generateLabelCanvas(){let e=document.createElement("canvas"),t=e.getContext("2d");return t.font=`${this.labelFontSize}px ${this.fontfamily}`,t.textAlign="center",t.textBaseline="middle",e.width=2*(t.measureText(this.labelText).width+this.labelFontSize),e.height=3.6*this.labelFontSize,t.fillStyle=this.labelBackground,t.fillRect(0,0,e.width,e.height),t.font=`${2*this.labelFontSize}px ${this.fontfamily}`,t.fillStyle=this.labelForeground,t.textAlign="center",t.textBaseline="middle",t.fillText(this.labelText,e.width/2,e.height/2),console.log(`canvas created: ${e.width} x ${e.height}`),e}generateTooltipCanvas(){let e=document.createElement("canvas").getContext("2d");return e.width=w,e.height=h,e.fillStyle="#fff",e.fillRect(0,0,w,h),e.strokeStyle="#c00",e.shadowBlur=20,e.shadowColor="#c99",e.strokeWidth=30,e.beginPath(),e.moveTo(w/2,0),e.lineTo(0,h),e.lineTo(w,h),e.closePath(),e.stroke(),e}getRequsetParams(){return{name:this.guid,layer:this.layer,type:this.type,position:this.position,icon:this.icon,pointColor:this.pointColor,pointSize:this.pointSize,pointMapMaxHeight:this.pointMaxDistance,pointMapHeight:this.pointMinDistance,maxVisibleDistance:this.smallIconMinDistance,middleIconMin:this.middleIconMinDistance,minVisibleDistance:this.largeIconMinDistance,farFactor:this.farFactor,nearFactor:this.nearFactor,markerType:this.markerType,textInfo:this.textInfo,textSize:this.labelFontSize,textHorizontalTranslation:this.labelXOffset,textVerticalTranslation:this.labelYOffset,iconHorizontalTranslation:this.iconHorizontalTranslation,iconVerticalTranslation:this.iconVerticalTranslation,iconScale:this.iconScale,billboardAnimationType:this.setAnimationType(this.animationType),billboardAnimationDuration:this.animationDuration,textVisible:!0,show:this.show}}setAnimationType(e){let t=0;switch(e){case"闪烁":t=1;break;case"缩放":t=2;break;case"渐显":t=3;break;case"从上方飞入":t=4;break;case"从下方飞入":t=5;break;case"从左方飞入":t=6;break;case"从右方飞入":t=7;break;default:t=0}return t}toString(){return JSON.stringify(this)}}class s{constructor(e){this.alt=0,this.lat=0,this.lon=0,!e||"xyz"!==e.toLowerCase()&&"lla"!==e.toLowerCase()&&"surface"!==e.toLowerCase()&&"ecef"!==e.toLowerCase()&&"planarglobal"!==e.toLowerCase()&&"planarlocal"!==e.toLowerCase()?e&&"default"===e.toLowerCase()&&(this.type=e):this.type=e,this.x=0,this.y=0,this.z=0}set(e,t,i){switch(this.type.toLowerCase()){case"surface":case"ecef":case"planarglobal":case"lla":case"planarlocal":this.lon=Number(e),this.lat=Number(t),this.alt=Number(i);break;default:this.x=Number(e),this.y=Number(t),this.z=Number(i)}return this}toString(){return JSON.stringify(this)}}const a="_sys_layer_info_panel_";class l extends t{constructor(e,t,i){if(super(e),this.content=e.content||"",this.exclusive=e.exclusive||!1,e.exclusive&&document.querySelectorAll("._sys_layer_info_panel_").forEach((function(e){e.remove()})),this.height=e.height||"",this.offsetX=e.offset?e.offset[0]:0,this.offsetY=e.offset?e.offset[1]:0,this.position=e.position,this.tooltipBackground=e.tooltipBackground||"rgb(0 0 0 / 0.6)",this.tooltipBackgroundBorderColor=e.tooltipBackgroundBorderColor||"#000000",this.tooltipBackgroundBorderThickness=e.tooltipBackgroundBorderThickness||"0",this.tooltipShadowEnabled="boolean"==typeof e.tooltipShadowEnabled&&e.tooltipShadowEnabled,this.tooltipForeground=e.tooltipForeground||"#ffffff",this.tooltipFontSize=e.tooltipFontSize||18,this.tooltipFontBold=!0===e.tooltipFontBold?"bold":"normal",this.tooltipFontItalic=!0===e.tooltipFontItalic?"italic":"normal",this.width=e.width||"",this.content){let i=document.createElement("div");i.setAttribute("id","_sys_layer_info_panel_"+e.name),i.className=a,i.innerHTML=e.content.substring(0,4194304),i.style=`position: absolute; overflow: auto; background:${this.tooltipBackground}; margin-top:${this.offsetY}px;\n                        border:${this.tooltipBackgroundBorderThickness}px solid ${this.tooltipBackgroundBorderColor};\n                        box-shadow:${this.tooltipShadowEnabled?"2px 3px 2px "+this.tooltipBackground+" ;":"none;"};\n                        font-size:${this.tooltipFontSize}px;font-weight:${this.tooltipFontBold};\n                        font-style:${this.tooltipFontItalic};color:${this.tooltipForeground};\n                        margin-left:${this.offsetX}px; width: ${this.width}px; pointer-events: none;\n                        height: ${this.height}${"auto"===this.height?"":"px"}; display: none;`,this.infoPanel=i;let r=e.position,o={position:{}};switch(o.position.srs=r.type,r.type.toLowerCase()){case"lla":case"surface":o.position.coords=[r.lon,r.lat,r.alt];break;case"default":default:o.position.coords=[r.x,r.y,r.z]}let s=t,l=s.appendChild(i);"lla"===o.position.srs?n.fetchJSON("getPositionByLLA","post","",o,((e,t)=>{t=JSON.parse(t.message),this.xyzPos={srs:"xyz",coords:[t.x,t.y,t.z]},n.fetchJSON("pickGetPosition2D","post","",{position:this.xyzPos},((e,t)=>{if(1===e){let e=c(l,s,t.message);i.style.bottom=e.y,i.style.left=e.x,i.style.display="block"}}))})):(this.xyzPos=o.position,n.fetchJSON("pickGetPosition2D","post","",o,((e,t)=>{if(1===e){let e=c(l,s,t.message);i.style.bottom=e.y,i.style.left=e.x,i.style.display="block"}})))}i&&i(1)}}function c(e,t,i){i=JSON.parse(i);let n=parseInt(!(!e.style.width||"auto"===e.style.width)&&e.style.width||e.offsetWidth);n||(n=e.firstElementChild&&"number"==typeof parseInt(e.firstElementChild.style.width)?parseInt(e.firstElementChild.style.width):0);let r=parseInt(t.style.width),o=parseInt(t.style.height);return{x:r*i.ratioX-n/2+"px",y:o-o*i.ratioY+"px"}}class u extends t{constructor(e,t,i){switch(super(e),this.animationSpeed=1/e.animationSpeed||1,this.bubbleColor=e.bubbleColor||"#FFFFFF",this.bubbleBrightness=e.bubbleBrightness||1,this.decimalNumber=e.decimalNumber||0,this.position=e.position||"",this.guid=e.guid,this.maxVisibleDistance=e.maxVisibleDistance||1e8,this.position.srs=this.position.type,this.position.type.toLowerCase()){case"lla":case"surface":this.position.coords=[this.position.lon,this.position.lat,this.position.alt];break;case"default":default:this.position.coords=[this.position.x,this.position.y,this.position.z]}this.parent=e.parent,this.repeatMode=e.repeatMode||"repeat",this.show="boolean"!=typeof e.show||e.show,this.sizeRatio=e.sizeRatio||1,this.value=e.value||1,i||n.fetchJSON("addBubble","post","",[this.getRequsetParams()],t),t&&t(1)}getRequsetParams(){return{layer:this.guid,name:this.name,position:this.position,color:this.bubbleColor,frequency:this.animationSpeed,size:this.value,bubbleBrightness:this.bubbleBrightness,repeatMode:this.repeatMode,maxVisibleDistance:this.maxVisibleDistance,decimalNumber:this.decimalNumber,sizeRatio:this.sizeRatio,show:this.show}}hideBubble(){this.show?n.fetchJSON("removeBubble","post","",{name:this.guid},((e,t)=>{1===e&&(this.show=!1)})):console.log("已显示！")}removeBubble(e){n.fetchJSON("removeBubble","post","",{name:this.guid},e)}showBubble(){this.show||n.fetchJSON("addBubble","post","",[this.getRequsetParams()],((e,t)=>{1===e&&(this.show=!0)}))}toString(){return JSON.stringify(this)}}class p extends t{constructor(e){super(e),this.allData=e.data,this.clusterDensity=e.clusterDensity||1,this.min=e.min||new s("lla").set(-180,-90,0),this.max=e.max||new s("lla").set(180,90,0),this.name=e.name||"",this.type=e.type||"",this.viewLevel=e.viewLevel||[{MinHeight:20641912,Level:0},{MinHeight:13111863,Level:1},{MinHeight:8501379,Level:2},{MinHeight:3411280,Level:3},{MinHeight:1886213,Level:4},{MinHeight:1064957,Level:5},{MinHeight:725327,Level:6},{MinHeight:243940,Level:7},{MinHeight:77722,Level:8},{MinHeight:30307,Level:9},{MinHeight:12e3,Level:10},{MinHeight:1947,Level:11},{MinHeight:719,Level:12},{MinHeight:153,Level:13},{MinHeight:-1e9,Level:14}],this.viewDistance=e.viewDistance||5e3,this.clusterIcon=e.clusterIcon||"Defaulet.png",this.iconScale=e.iconScale||1,this.labelFontSize=e.labelFontSize||12,this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||0,this.cellSize()}cellSize(){for(let e=0;e<this.viewLevel.length;e++){let t=this.viewLevel[e];t.rowCount=t.columnCount=Math.pow(2,e),t.cellCount=t.rowCount*t.columnCount;let i=(this.max.lat-this.min.lat)/(t.columnCount*this.clusterDensity),n=(this.max.lon-this.min.lon)/(t.rowCount*this.clusterDensity);this.SetPointIntoGrid(t,t.rowCount,t.columnCount,n,i)}}getCurViewLevel(e){for(let t=0;t<this.viewLevel.length;t++)if(e>=this.viewLevel[t].MinHeight)return this.viewLevel[t].Level}SetPointIntoGrid(e,t,i,n,r){e.grids={};for(let o=0;o<this.allData.length;o++){let s=this.allData[o],a=s.latitude,l=s.longitude;if(l<this.min.lon)continue;if(l>this.max.lon)continue;if(a<this.min.lat)continue;if(a>this.max.lat)continue;let c=Math.floor((l-this.min.lon)/n),h=Math.floor((a-this.min.lat)/r);h==t&&(h-=1),c==i&&(c-=1);let u=`x${c}_y${h}`;if(e.grids[u])e.grids[u].count++,e.grids[u].innerData.push(s);else{let t=this.min.lon+c*n,i=this.min.lat+h*r;e.grids[u]={maxXY:{x:t+n,y:i+r},minXY:{x:t,y:i},count:1,centerXY:{x:t+.5*n,y:i+.5*r},innerData:[s]},d({lon:t+.5*n,lat:i+.5*r,alt:0},e.grids[u])}}}}function d(e,t){let i={position:{srs:"lla",coords:[e.lon,e.lat,e.alt]}};return n.fetchJSON("getPositionByLLA","post","",i,((e,i)=>{t.centerScreen=[JSON.parse(i.message).x,JSON.parse(i.message).z]}))}class f extends t{constructor(e,t){super(e),this.brightness=e.brightness||1,this.color=e.color||"#FFFFFF",this.enableDynamicCalc=e.enableDynamicCalc||!1,this.guid=e.guid||"",this.horizontalOffset=e.horizontalOffset||0,this.heightRatio=e.heightRatio||20,this.isShow="boolean"!=typeof e.isShow||e.isShow,this.labelFontSize=e.labelFontSize||8,this.label="boolean"!=typeof e.label||e.label,this.labelValue=e.labelValue||"",this.minValueColor=e.minValueColor||"#FFFF0000",this.maxValueColor=e.maxValueColor||"#FFFF0000",this.minValue=e.minValue||1,this.maxValue=e.maxValue||100,this.parent=e.parent,this.position=e.position,this.textColor=e.textColor||"#FFFFFF",this.verticalOffset=e.verticalOffset||0,this.values=e.values||1,this.widthRatio=e.widthRatio||0,this.histogramType=e.histogramType||"cylinder",t&&t(1)}getRequsetParams(){return{layer:this.guid,horizontalOffset:this.horizontalOffset,verticalOffset:this.verticalOffset,heightScaleFactor:this.heightRatio,bottomScaleFactor:this.widthRatio,textSize:this.labelFontSize,textColor:this.textColor,histogramDefaultColor:this.color,isShowLable:this.label,enableDynamicCalc:this.enableDynamicCalc,minValueColor:this.minValueColor,maxValueColor:this.maxValueColor,minValue:this.minValue,maxValue:this.maxValue,textureLight:this.brightness,measure:this.values,label:this.labelValue,position:this.position,isShowLayer:this.isShow,histogramType:this.histogramType}}toString(){return JSON.stringify(this)}}class g extends t{constructor(e,t){super(e),this.animationStyle=e.animationStyle||"Attack",this.animationSpeed=e.animationSpeed||1,this.animationDurationTime=e.animationDurationTime||1,this.brightness=e.brightness||1,this.color=e.color||"#FFFFFF",this.curvatureCoefficient=e.curvatureCoefficient||5e3,this.endPos=e.endPos,this.guid=e.guid||"",this.isShow="boolean"!=typeof e.isShow||e.isShow,this.linkImagePath=e.linkImagePath||null,this.lineWidth=e.lineWidth||20,this.parent=e.parent,this.startPos=e.startPos,t&&t(1)}getRequsetParams(){return{type:this.type,layer:this.guid,animationStyle:this.animationStyle,linkImagePath:this.linkImagePath,lineWidth:this.lineWidth,animationSpeed:this.animationSpeed,animationDurationTime:this.animationDurationTime,lineColor:this.color,curvatureRatio:this.curvatureCoefficient,isShowLayer:this.isShow,startPosition:this.startPos,endPosition:this.endPos,lineColorBrightness:this.brightness}}toString(){return JSON.stringify(this)}}class y extends t{constructor(e,t){super(e),this.animationSpeed=e.animationSpeed||1,this.color=e.color||"#FFFFFFFF",this.duration=e.duration||1,this.farFactor=e.farFactor||.5,this.guid=e.guid||"",this.guidName=e.guidName||"",this.icon=e.icon||"",this.isShow="boolean"!=typeof e.isShow||e.isShow,this.labelValue=e.labelValue||"",this.labelXOffset=e.labelXOffset||0,this.labelYOffset=e.labelYOffset||30,this.labelSize=e.labelSize||1,this.lineWidth=e.lineWidth||20,this.largeIconMinDistance=e.largeIconMinDistance||0,this.middleIconMinDistance=e.middleIconMinDistance||1e3,this.nearFactor=e.nearFactor||1,this.parent=e.parent,this.pointColor=e.pointColor||"#FFFFFFFF",this.pointSize=e.pointSize||10,this.pointMaxDistance=e.pointMaxDistance||1e5,this.pointMinDistance=e.pointMinDistance||1e5,this.position=e.position,this.smallIconMinDistance=e.smallIconMinDistance||3e3,this.animationType=e.animationType||"无",this.animationDuration=e.animationDuration||1,this.zOrder=e.zOrder||1,t&&t(1)}getRequsetParams(){return{layer:this.guid,name:this.guidName,lineWidth:this.lineWidth,animationSpeed:this.animationSpeed,animationDurationTime:this.duration,lineColor:this.color,billBoardImagePath:this.icon,label:this.labelValue,zOrder:this.zOrder,labelHorizontalTranslation:this.labelXOffset,labelVerticalTranslation:this.labelYOffset,labelSize:this.labelSize,pointColor:this.pointColor,pointSize:this.pointSize,pointMapMaxHeight:this.pointMaxDistance,pointMapHeight:this.pointMinDistance,maxVisibleDistance:this.smallIconMinDistance,middleIconMin:this.middleIconMinDistance,minVisibleDistance:this.largeIconMinDistance,farFactor:this.farFactor,nearFactor:this.nearFactor,isShowLayer:this.isShow,position:this.position,billboardAnimationType:this.setAnimationType(this.animationType),billboardAnimationDuration:this.animationDuration}}setAnimationType(e){let t=0;switch(e){case"闪烁":t=1;break;case"缩放":t=2;break;case"渐显":t=3;break;case"从上方飞入":t=4;break;case"从下方飞入":t=5;break;case"从左方飞入":t=6;break;case"从右方飞入":t=7;break;default:t=0}return t}toString(){return JSON.stringify(this)}}class m extends t{constructor(e,t){super(e),this.animationType=e.animationType||"无",this.animationInterval=e.animationInterval||5,this.animationDuration=e.animationDuration||1,this.color=e.color||"#FFFFFF00",this.duration=e.duration||5,this.decimalDigits=e.decimalDigits||-1,this.descriptionHorizontalAlignment=e.descriptionHorizontalAlignment||"middle",this.flyDistance=e.flyDistance||500,this.farFactor=e.farFactor||.5,this.guid=e.guid,this.iconTransparency=e.iconTransparency||1,this.isShow="boolean"!=typeof e.isShow||e.isShow,this.initShowTooltip=e.initShowTooltip||!1,this.isAnimation=e.isAnimation||!0,this.isRandom=e.isRandom||!1,this.isOverlapShine="boolean"!=typeof e.isOverlapShine||e.isOverlapShine,this.iconXOffset=e.iconXOffset||0,this.iconYOffset=e.iconYOffset||0,this.icon=e.icon||"",this.labelForeground=e.labelForeground||"#FFFFFFFF",this.labelHorOffset=e.labelHorOffset||0,this.labelVerOffset=e.labelVerOffset||50,this.labelAutoHiddenByDistance="boolean"!=typeof e.labelAutoHiddenByDistance||e.labelAutoHiddenByDistance,this.largeIconMinDistance=e.largeIconMinDistance||0,this.labelFontFamily=e.labelFontFamily||"MSYaHei_GBK",this.labelFontSize=e.labelFontSize||12,this.labelBackground=e.labelBackground||"#00FFFFFF",this.lineShowHidden="boolean"!=typeof e.lineShowHidden||e.lineShowHidden,this.lineWidth=e.lineWidth||20,this.label="boolean"!=typeof e.label||e.label,this.lableValue=e.lableValue||"",this.middleIconMinDistance=e.middleIconMinDistance||1e3,this.nearFactor=e.nearFactor||1.5,this.pointColor=e.pointColor||"#FFFFFFFF",this.pointSize=e.pointSize||5,this.pointMaxDistance=e.pointMaxDistance||1e5,this.pointMinDistance=e.pointMinDistance||1e4,this.position=e.position,this.parent=e.parent,this.randomAddedDuration=e.randomAddedDuration||5,this.scaleMin=e.scaleMin||.5,this.smallIconMinDistance=e.smallIconMinDistance||3e3,this.tooltipEnabled=e.tooltipEnabled||!1,this.tooltipTriggerEvent=e.tooltipTriggerEvent||"click",this.tooltipText=e.tooltipText||"",this.tooltipBackground=e.tooltipBackground||"rgb(0 0 0 / 0.6)",this.tooltipBackgroundBorderColor=e.tooltipBackgroundBorderColor||"#000",this.tooltipBackgroundBorderThickness=e.tooltipBackgroundBorderThickness||"0",this.tooltipShadowEnabled="boolean"!=typeof e.tooltipShadowEnabled||e.tooltipShadowEnabled,this.tooltipHorOffset=e.tooltipHorOffset||0,this.tooltipVerOffset=e.tooltipVerOffset||0,this.tooltipForeground=e.tooltipForeground||"#fff",this.tooltipFontSize=e.tooltipFontSize||18,this.tooltipFontBold=!0===e.tooltipFontBold?"bold":"normal",this.tooltipFontItalic=!0===e.tooltipFontItalic?"italic":"normal",this.tooltipIndicatorLineEnabled=e.tooltipIndicatorLineEnabled||"",this.tooltip=e.tooltip||!1,this.upDownOffset=e.upDownOffset||0,t&&t(1)}getRequsetParams(){return{layer:this.guid,id:this.name,showLabel:this.label,lable:this.lableValue,iconTransparency:this.iconTransparency,showLayer:this.isShow,isAnimation:this.isAnimation,animationType:this.animationType,animationInterval:this.animationInterval,animationDuration:this.animationDuration,flyDistance:this.flyDistance,scaleMin:this.scaleMin,isRandom:this.isRandom,randomAddedDuration:this.randomAddedDuration,labelForeground:this.labelForeground,labelHorOffset:this.labelHorOffset,labelVerOffset:this.labelVerOffset,labelAutoHiddenByDistance:this.labelAutoHiddenByDistance,descriptionHorizontalAlignment:this.descriptionHorizontalAlignment,pointColor:this.pointColor,pointSize:this.pointSize,pointMapMaxHeight:this.pointMaxDistance,pointMapHeight:this.pointMinDistance,maxVisibleDistance:this.smallIconMinDistance,middleIconMin:this.middleIconMinDistance,minVisibleDistance:this.largeIconMinDistance,nearFactor:this.nearFactor,farFactor:this.farFactor,labelFontFamily:this.labelFontFamily,labelFontSize:this.labelFontSize,labelBackground:this.labelBackground,decimalDigits:this.decimalDigits,isOverlapShine:this.isOverlapShine,enableTrackingPoint:this.lineShowHidden,trailDuration:this.duration,trailWidth:this.lineWidth,trailColor:this.color,eastWestOffset:this.iconXOffset,northSouthOffset:this.iconYOffset,upDownOffset:this.upDownOffset,iconPath:this.icon,position:this.position}}toString(){return JSON.stringify(this)}}class b extends t{constructor(e,t){super(e),this.color=e.color||"#FFFFFF",this.depth=e.depth||10,this.guid=e.guid||"",this.isShow="boolean"!=typeof e.isShow||e.isShow,this.legend=e.legend||"图例1",this.parent=e.parent,this.positionType=e.positionType||"lla",this.points=e.points,t&&t(1)}getRequsetParams(){return{layer:this.guid,name:this.name,legend:this.legend,color:this.color,positionType:this.positionType,thickness:this.depth,isShowLayer:this.isShow,position:this.points,type:this.type}}toString(){return JSON.stringify(this)}}class v extends t{constructor(e,t){super(e),this.colorBrightness=e.colorBrightness||1,this.color=e.color||"#FFFFFF",this.guid=e.guid||"",this.height=e.height||20,this.isShowLayer="boolean"!=typeof e.isShowLayer||e.isShowLayer,this.name=e.name,this.parent=e.parent,this.positionType=e.positionType||"lla",this.position=e.position,this.radius=e.radius||100,this.speed=e.speed||.1,this.style=e.style||"none",t&&t(1)}getRequsetParams(){return{layer:this.guid,name:this.name,height:this.height,radius:this.radius,speed:this.speed,color:this.color,style:this.style,positionType:this.positionType,isShowLayer:this.isShowLayer,position:this.position,colorBrightness:this.colorBrightness,type:this.type}}toString(){return JSON.stringify(this)}}class S extends t{constructor(e,t){super(e),this.color=e.color||"#00ff00",this.colorBrightness=e.colorBrightness||1,this.guid=e.guid||"",this.isShowLayer="boolean"!=typeof e.isShowLayer||e.isShowLayer,this.positionType=e.positionType||"lla",this.position=e.position,this.parent=e.parent,this.trafficJamLevel=e.trafficJamLevel||"正常",this.width=e.width||20,t&&t(1)}getRequsetParams(){return{layer:this.guid,Name:this.name,width:this.width,trafficJamLevel:this.trafficJamLevel,color:this.color,positionType:this.positionType,isShowLayer:this.isShowLayer,position:this.position,colorBrightness:this.colorBrightness,type:this.type}}toString(){return JSON.stringify(this)}}class k extends t{constructor(e,t){super(e),this.guid=e.guid||"",this.isShow="boolean"!=typeof e.isShow||e.isShow,this.isEdit="boolean"!=typeof e.isEdit||e.isEdit,this.minDistance=e.minDistance||0,this.maxDistance=e.maxDistance||1e4,this.opacity=e.opacity||1,this.parent=e.parent,this.position=e.position||{x:0,y:0,z:0},this.percentageModels=e.percentageModels,this.positionType=e.positionType||"lla",this.rotation=e.rotation||{x:90,y:0,z:0},this.radius=e.radius||10,this.scale=e.scale||{x:1,y:1,z:1},t&&t(1)}getRequsetParams(){return{ID:this.guid,Name:this.name,Opacity:this.opacity,LayerVisibleMin:this.minDistance,LayerVisibleMax:this.maxDistance,ScaleCoefficient:this.radius,TranslationX:this.position.x,TranslationY:this.position.y,TranslationZ:this.position.z,RotationX:this.rotation.x,RotationY:this.rotation.y,RotationZ:this.rotation.z,ScaleX:this.scale.x,ScaleY:this.scale.y,ScaleZ:this.scale.z,IsEdit:this.isEdit,positionType:this.positionType,LayerVisible:this.isShow,PercentageModels:this.percentageModels,type:this.type}}toString(){return JSON.stringify(this)}}class _ extends t{constructor(e,t){super(e),this.autoHideByDistance="boolean"==typeof e.autoHideByDistance&&e.autoHideByDistance,this.brightness=e.brightness||1,this.emittedTimeOffset=e.emittedTimeOffset||2,this.lifeTimeOffset=e.lifeTimeOffset||1,this.lifeTimeRadio=e.lifeTimeRadio||1,this.maxVisibleDistance=e.maxVisibleDistance||500,this.minVisibleDistance=e.minVisibleDistance||100,this.parent=e.parent,this.offSet_X=e.offSet_X||0,this.offSet_Y=e.offSet_Y||0,this.offSet_Z=e.offSet_Z||0,this.radius=e.radius||50,this.xRange=e.xRange||100,this.yRange=e.yRange||100,this.zRange=e.zRange||100,this.sizeRadio=e.sizeRadio||1,this.speedRadio=e.speedRadio||1,this.guid=e.guid||"",t&&t(1)}getRequsetParams(){return{Name:this.guid,offSet_X:this.offSet_X,offSet_Y:this.offSet_Y,offSet_Z:this.offSet_Z,xRange:this.xRange,yRange:this.yRange,zRange:this.zRange,radius:this.radius,autoHideByDistance:this.autoHideByDistance,brightness:this.brightness,emittedTimeOffset:this.emittedTimeOffset,lifeTimeOffset:this.lifeTimeOffset,lifeTimeRadio:this.lifeTimeRadio,maxVisibleDistance:this.maxVisibleDistance,minVisibleDistance:this.minVisibleDistance,sizeRadio:this.sizeRadio,speedRadio:this.speedRadio}}toString(){return JSON.stringify(this)}}class T extends t{constructor(e,t){super(e),this.beginHeight=e.beginHeight||0,this.color=e.color||"#FFFFFFFF",this.colorBrightness=e.colorBrightness||1,this.density=e.density||100,this.endHeight=e.endHeight||1e3,this.guid=e.guid||"",this.isVisible="boolean"!=typeof e.isVisible||e.isVisible,this.isShowCenterPoint="boolean"==typeof e.isShowCenterPoint&&e.isShowCenterPoint,this.offSet_X=e.offSet_X||0,this.offSet_Y=e.offSet_Y||0,this.offSet_Z=e.offSet_Z||0,this.parent=e.parent,this.pointSizeFactor=e.pointSizeFactor||1,this.radius=e.radius||500,this.size=e.size||1,this.speed=e.speed||1,this.texturePath=e.texturePath||"",t&&t(1)}getRequsetParams(){return{Name:this.guid,offSet_X:this.offSet_X,offSet_Y:this.offSet_Y,offSet_Z:this.offSet_Z,radius:this.radius,beginHeight:this.beginHeight,endHeight:this.endHeight,density:this.density,isShowCenterPoint:this.isShowCenterPoint,color:this.color,colorBrightness:this.colorBrightness,size:this.size,speed:this.speed,texturePath:this.texturePath,isVisible:this.isVisible,pointSizeFactor:this.pointSizeFactor}}toString(){return JSON.stringify(this)}}class C extends t{constructor(e,t){super(e),this.beginHeight=e.beginHeight||0,this.color=e.color||"#FFFFFFFF",this.colorBrightness=e.colorBrightness||1,this.density=e.density||100,this.detailTexture=e.detailTexture||"",this.endHeight=e.endHeight||1e3,this.guid=e.guid||"",this.isShowCenterPoint="boolean"==typeof e.isShowCenterPoint&&e.isShowCenterPoint,this.isVisible="boolean"!=typeof e.isVisible||e.isVisible,this.isReversePlay="boolean"==typeof e.isReversePlay&&e.isReversePlay,this.lineTexture=e.lineTexture||"",this.lineWidth=e.lineWidth||1,this.offSet_X=e.offSet_X||0,this.offSet_Y=e.offSet_Y||0,this.offSet_Z=e.offSet_Z||0,this.parent=e.parent,this.pointSizeFactor=e.pointSizeFactor||1,this.radius=e.radius||500,this.speed=e.speed||1,t&&t(1)}getRequsetParams(){return{Name:this.guid,offSet_X:this.offSet_X,offSet_Y:this.offSet_Y,offSet_Z:this.offSet_Z,radius:this.radius,beginHeight:this.beginHeight,endHeight:this.endHeight,density:this.density,isShowCenterPoint:this.isShowCenterPoint,color:this.color,colorBrightness:this.colorBrightness,speed:this.speed,detailTexture:this.detailTexture,lineTexture:this.lineTexture,lineWidth:this.lineWidth,isReversePlay:this.isReversePlay,isVisible:this.isVisible,pointSizeFactor:this.pointSizeFactor}}toString(){return JSON.stringify(this)}}
/*! Hammer.JS - v2.0.8 - 2016-04-23
   * http://hammerjs.github.io/
   *
   * Copyright (c) 2016 Jorik Tangelder;
   * Licensed under the MIT license */
!function(e){var t={exports:{}};e(t,t.exports)}((function(e){!function(t,i,n,r){var o,s=["","webkit","Moz","MS","ms","o"],a=i.createElement("div"),l=Math.round,c=Math.abs,h=Date.now;function u(e,t,i){return setTimeout(b(e,i),t)}function p(e,t,i){return!!Array.isArray(e)&&(d(e,i[t],i),!0)}function d(e,t,i){var n;if(e)if(e.forEach)e.forEach(t,i);else if(e.length!==r)for(n=0;n<e.length;)t.call(i,e[n],n,e),n++;else for(n in e)e.hasOwnProperty(n)&&t.call(i,e[n],n,e)}function f(e,i,n){var r="DEPRECATED METHOD: "+i+"\n"+n+" AT \n";return function(){var i=new Error("get-stack-trace"),n=i&&i.stack?i.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",o=t.console&&(t.console.warn||t.console.log);return o&&o.call(t.console,r,n),e.apply(this,arguments)}}o="function"!=typeof Object.assign?function(e){if(e===r||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var n=arguments[i];if(n!==r&&null!==n)for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o])}return t}:Object.assign;var g=f((function(e,t,i){for(var n=Object.keys(t),o=0;o<n.length;)(!i||i&&e[n[o]]===r)&&(e[n[o]]=t[n[o]]),o++;return e}),"extend","Use `assign`."),y=f((function(e,t){return g(e,t,!0)}),"merge","Use `assign`.");function m(e,t,i){var n,r=t.prototype;(n=e.prototype=Object.create(r)).constructor=e,n._super=r,i&&o(n,i)}function b(e,t){return function(){return e.apply(t,arguments)}}function w(e,t){return"function"==typeof e?e.apply(t&&t[0]||r,t):e}function v(e,t){return e===r?t:e}function S(e,t,i){d(C(t),(function(t){e.addEventListener(t,i,!1)}))}function k(e,t,i){d(C(t),(function(t){e.removeEventListener(t,i,!1)}))}function _(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function T(e,t){return e.indexOf(t)>-1}function C(e){return e.trim().split(/\s+/g)}function D(e,t,i){if(e.indexOf&&!i)return e.indexOf(t);for(var n=0;n<e.length;){if(i&&e[n][i]==t||!i&&e[n]===t)return n;n++}return-1}function E(e){return Array.prototype.slice.call(e,0)}function P(e,t,i){for(var n=[],r=[],o=0;o<e.length;){var s=t?e[o][t]:e[o];D(r,s)<0&&n.push(e[o]),r[o]=s,o++}return i&&(n=t?n.sort((function(e,i){return e[t]>i[t]})):n.sort()),n}function x(e,t){for(var i,n,o=t[0].toUpperCase()+t.slice(1),a=0;a<s.length;){if((n=(i=s[a])?i+o:t)in e)return n;a++}return r}var R=1;function L(e){var i=e.ownerDocument||e;return i.defaultView||i.parentWindow||t}var I="ontouchstart"in t,H=x(t,"PointerEvent")!==r,O=I&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),F="touch",M="mouse",N=24,q=["x","y"],z=["clientX","clientY"];function A(e,t){var i=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){w(e.options.enable,[e])&&i.handler(t)},this.init()}function V(e,t,i){var n=i.pointers.length,o=i.changedPointers.length,s=1&t&&n-o==0,a=12&t&&n-o==0;i.isFirst=!!s,i.isFinal=!!a,s&&(e.session={}),i.eventType=t,function(e,t){var i=e.session,n=t.pointers,o=n.length;i.firstInput||(i.firstInput=B(t));o>1&&!i.firstMultiple?i.firstMultiple=B(t):1===o&&(i.firstMultiple=!1);var s=i.firstInput,a=i.firstMultiple,l=a?a.center:s.center,u=t.center=$(n);t.timeStamp=h(),t.deltaTime=t.timeStamp-s.timeStamp,t.angle=J(l,u),t.distance=Y(l,u),function(e,t){var i=t.center,n=e.offsetDelta||{},r=e.prevDelta||{},o=e.prevInput||{};1!==t.eventType&&4!==o.eventType||(r=e.prevDelta={x:o.deltaX||0,y:o.deltaY||0},n=e.offsetDelta={x:i.x,y:i.y});t.deltaX=r.x+(i.x-n.x),t.deltaY=r.y+(i.y-n.y)}(i,t),t.offsetDirection=W(t.deltaX,t.deltaY);var p=X(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=p.x,t.overallVelocityY=p.y,t.overallVelocity=c(p.x)>c(p.y)?p.x:p.y,t.scale=a?(d=a.pointers,f=n,Y(f[0],f[1],z)/Y(d[0],d[1],z)):1,t.rotation=a?function(e,t){return J(t[1],t[0],z)+J(e[1],e[0],z)}(a.pointers,n):0,t.maxPointers=i.prevInput?t.pointers.length>i.prevInput.maxPointers?t.pointers.length:i.prevInput.maxPointers:t.pointers.length,function(e,t){var i,n,o,s,a=e.lastInterval||t,l=t.timeStamp-a.timeStamp;if(8!=t.eventType&&(l>25||a.velocity===r)){var h=t.deltaX-a.deltaX,u=t.deltaY-a.deltaY,p=X(l,h,u);n=p.x,o=p.y,i=c(p.x)>c(p.y)?p.x:p.y,s=W(h,u),e.lastInterval=t}else i=a.velocity,n=a.velocityX,o=a.velocityY,s=a.direction;t.velocity=i,t.velocityX=n,t.velocityY=o,t.direction=s}(i,t);var d,f;var g=e.element;_(t.srcEvent.target,g)&&(g=t.srcEvent.target);t.target=g}(e,i),e.emit("hammer.input",i),e.recognize(i),e.session.prevInput=i}function B(e){for(var t=[],i=0;i<e.pointers.length;)t[i]={clientX:l(e.pointers[i].clientX),clientY:l(e.pointers[i].clientY)},i++;return{timeStamp:h(),pointers:t,center:$(t),deltaX:e.deltaX,deltaY:e.deltaY}}function $(e){var t=e.length;if(1===t)return{x:l(e[0].clientX),y:l(e[0].clientY)};for(var i=0,n=0,r=0;r<t;)i+=e[r].clientX,n+=e[r].clientY,r++;return{x:l(i/t),y:l(n/t)}}function X(e,t,i){return{x:t/e||0,y:i/e||0}}function W(e,t){return e===t?1:c(e)>=c(t)?e<0?2:4:t<0?8:16}function Y(e,t,i){i||(i=q);var n=t[i[0]]-e[i[0]],r=t[i[1]]-e[i[1]];return Math.sqrt(n*n+r*r)}function J(e,t,i){i||(i=q);var n=t[i[0]]-e[i[0]],r=t[i[1]]-e[i[1]];return 180*Math.atan2(r,n)/Math.PI}A.prototype={handler:function(){},init:function(){this.evEl&&S(this.element,this.evEl,this.domHandler),this.evTarget&&S(this.target,this.evTarget,this.domHandler),this.evWin&&S(L(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&k(this.element,this.evEl,this.domHandler),this.evTarget&&k(this.target,this.evTarget,this.domHandler),this.evWin&&k(L(this.element),this.evWin,this.domHandler)}};var j={mousedown:1,mousemove:2,mouseup:4},U="mousedown",G="mousemove mouseup";function Z(){this.evEl=U,this.evWin=G,this.pressed=!1,A.apply(this,arguments)}m(Z,A,{handler:function(e){var t=j[e.type];1&t&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=4),this.pressed&&(4&t&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:M,srcEvent:e}))}});var K={pointerdown:1,pointermove:2,pointerup:4,pointercancel:8,pointerout:8},Q={2:F,3:"pen",4:M,5:"kinect"},ee="pointerdown",te="pointermove pointerup pointercancel";function ie(){this.evEl=ee,this.evWin=te,A.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}t.MSPointerEvent&&!t.PointerEvent&&(ee="MSPointerDown",te="MSPointerMove MSPointerUp MSPointerCancel"),m(ie,A,{handler:function(e){var t=this.store,i=!1,n=e.type.toLowerCase().replace("ms",""),r=K[n],o=Q[e.pointerType]||e.pointerType,s=o==F,a=D(t,e.pointerId,"pointerId");1&r&&(0===e.button||s)?a<0&&(t.push(e),a=t.length-1):12&r&&(i=!0),a<0||(t[a]=e,this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:o,srcEvent:e}),i&&t.splice(a,1))}});var ne={touchstart:1,touchmove:2,touchend:4,touchcancel:8},re="touchstart",oe="touchstart touchmove touchend touchcancel";function se(){this.evTarget=re,this.evWin=oe,this.started=!1,A.apply(this,arguments)}function ae(e,t){var i=E(e.touches),n=E(e.changedTouches);return 12&t&&(i=P(i.concat(n),"identifier",!0)),[i,n]}m(se,A,{handler:function(e){var t=ne[e.type];if(1===t&&(this.started=!0),this.started){var i=ae.call(this,e,t);12&t&&i[0].length-i[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:F,srcEvent:e})}}});var le={touchstart:1,touchmove:2,touchend:4,touchcancel:8},ce="touchstart touchmove touchend touchcancel";function he(){this.evTarget=ce,this.targetIds={},A.apply(this,arguments)}function ue(e,t){var i=E(e.touches),n=this.targetIds;if(3&t&&1===i.length)return n[i[0].identifier]=!0,[i,i];var r,o,s=E(e.changedTouches),a=[],l=this.target;if(o=i.filter((function(e){return _(e.target,l)})),1===t)for(r=0;r<o.length;)n[o[r].identifier]=!0,r++;for(r=0;r<s.length;)n[s[r].identifier]&&a.push(s[r]),12&t&&delete n[s[r].identifier],r++;return a.length?[P(o.concat(a),"identifier",!0),a]:void 0}m(he,A,{handler:function(e){var t=le[e.type],i=ue.call(this,e,t);i&&this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:F,srcEvent:e})}});function pe(){A.apply(this,arguments);var e=b(this.handler,this);this.touch=new he(this.manager,e),this.mouse=new Z(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function de(e,t){1&e?(this.primaryTouch=t.changedPointers[0].identifier,fe.call(this,t)):12&e&&fe.call(this,t)}function fe(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var i={x:t.clientX,y:t.clientY};this.lastTouches.push(i);var n=this.lastTouches;setTimeout((function(){var e=n.indexOf(i);e>-1&&n.splice(e,1)}),2500)}}function ge(e){for(var t=e.srcEvent.clientX,i=e.srcEvent.clientY,n=0;n<this.lastTouches.length;n++){var r=this.lastTouches[n],o=Math.abs(t-r.x),s=Math.abs(i-r.y);if(o<=25&&s<=25)return!0}return!1}m(pe,A,{handler:function(e,t,i){var n=i.pointerType==F,r=i.pointerType==M;if(!(r&&i.sourceCapabilities&&i.sourceCapabilities.firesTouchEvents)){if(n)de.call(this,t,i);else if(r&&ge.call(this,i))return;this.callback(e,t,i)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var ye=x(a.style,"touchAction"),me=ye!==r,be="compute",we="auto",ve="manipulation",Se="none",ke="pan-x",_e="pan-y",Te=function(){if(!me)return!1;var e={},i=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach((function(n){e[n]=!i||t.CSS.supports("touch-action",n)})),e}();function Ce(e,t){this.manager=e,this.set(t)}Ce.prototype={set:function(e){e==be&&(e=this.compute()),me&&this.manager.element.style&&Te[e]&&(this.manager.element.style[ye]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return d(this.manager.recognizers,(function(t){w(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))})),function(e){if(T(e,Se))return Se;var t=T(e,ke),i=T(e,_e);if(t&&i)return Se;if(t||i)return t?ke:_e;if(T(e,ve))return ve;return we}(e.join(" "))},preventDefaults:function(e){var t=e.srcEvent,i=e.offsetDirection;if(this.manager.session.prevented)t.preventDefault();else{var n=this.actions,r=T(n,Se)&&!Te.none,o=T(n,_e)&&!Te["pan-y"],s=T(n,ke)&&!Te["pan-x"];if(r){var a=1===e.pointers.length,l=e.distance<2,c=e.deltaTime<250;if(a&&l&&c)return}if(!s||!o)return r||o&&6&i||s&&i&N?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var De=32;function Ee(e){this.options=o({},this.defaults,e||{}),this.id=R++,this.manager=null,this.options.enable=v(this.options.enable,!0),this.state=1,this.simultaneous={},this.requireFail=[]}function Pe(e){return 16&e?"cancel":8&e?"end":4&e?"move":2&e?"start":""}function xe(e){return 16==e?"down":8==e?"up":2==e?"left":4==e?"right":""}function Re(e,t){var i=t.manager;return i?i.get(e):e}function Le(){Ee.apply(this,arguments)}function Ie(){Le.apply(this,arguments),this.pX=null,this.pY=null}function He(){Le.apply(this,arguments)}function Oe(){Ee.apply(this,arguments),this._timer=null,this._input=null}function Fe(){Le.apply(this,arguments)}function Me(){Le.apply(this,arguments)}function Ne(){Ee.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function qe(e,t){return(t=t||{}).recognizers=v(t.recognizers,qe.defaults.preset),new ze(e,t)}Ee.prototype={defaults:{},set:function(e){return o(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(p(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=Re(e,this)).id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return p(e,"dropRecognizeWith",this)||(e=Re(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(p(e,"requireFailure",this))return this;var t=this.requireFail;return-1===D(t,e=Re(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(p(e,"dropRequireFailure",this))return this;e=Re(e,this);var t=D(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){var t=this,i=this.state;function n(i){t.manager.emit(i,e)}i<8&&n(t.options.event+Pe(i)),n(t.options.event),e.additionalEvent&&n(e.additionalEvent),i>=8&&n(t.options.event+Pe(i))},tryEmit:function(e){if(this.canEmit())return this.emit(e);this.state=De},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(33&this.requireFail[e].state))return!1;e++}return!0},recognize:function(e){var t=o({},e);if(!w(this.options.enable,[this,t]))return this.reset(),void(this.state=De);56&this.state&&(this.state=1),this.state=this.process(t),30&this.state&&this.tryEmit(t)},process:function(e){},getTouchAction:function(){},reset:function(){}},m(Le,Ee,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,i=e.eventType,n=6&t,r=this.attrTest(e);return n&&(8&i||!r)?16|t:n||r?4&i?8|t:2&t?4|t:2:De}}),m(Ie,Le,{defaults:{event:"pan",threshold:10,pointers:1,direction:30},getTouchAction:function(){var e=this.options.direction,t=[];return 6&e&&t.push(_e),e&N&&t.push(ke),t},directionTest:function(e){var t=this.options,i=!0,n=e.distance,r=e.direction,o=e.deltaX,s=e.deltaY;return r&t.direction||(6&t.direction?(r=0===o?1:o<0?2:4,i=o!=this.pX,n=Math.abs(e.deltaX)):(r=0===s?1:s<0?8:16,i=s!=this.pY,n=Math.abs(e.deltaY))),e.direction=r,i&&n>t.threshold&&r&t.direction},attrTest:function(e){return Le.prototype.attrTest.call(this,e)&&(2&this.state||!(2&this.state)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=xe(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),m(He,Le,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Se]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||2&this.state)},emit:function(e){if(1!==e.scale){var t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}this._super.emit.call(this,e)}}),m(Oe,Ee,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[we]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,r=e.deltaTime>t.time;if(this._input=e,!n||!i||12&e.eventType&&!r)this.reset();else if(1&e.eventType)this.reset(),this._timer=u((function(){this.state=8,this.tryEmit()}),t.time,this);else if(4&e.eventType)return 8;return De},reset:function(){clearTimeout(this._timer)},emit:function(e){8===this.state&&(e&&4&e.eventType?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=h(),this.manager.emit(this.options.event,this._input)))}}),m(Fe,Le,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Se]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||2&this.state)}}),m(Me,Le,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:30,pointers:1},getTouchAction:function(){return Ie.prototype.getTouchAction.call(this)},attrTest:function(e){var t,i=this.options.direction;return 30&i?t=e.overallVelocity:6&i?t=e.overallVelocityX:i&N&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&i&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&c(t)>this.options.velocity&&4&e.eventType},emit:function(e){var t=xe(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),m(Ne,Ee,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ve]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,r=e.deltaTime<t.time;if(this.reset(),1&e.eventType&&0===this.count)return this.failTimeout();if(n&&r&&i){if(4!=e.eventType)return this.failTimeout();var o=!this.pTime||e.timeStamp-this.pTime<t.interval,s=!this.pCenter||Y(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,s&&o?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=u((function(){this.state=8,this.tryEmit()}),t.interval,this),2):8}return De},failTimeout:function(){return this._timer=u((function(){this.state=De}),this.options.interval,this),De},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),qe.VERSION="2.0.8",qe.defaults={domEvents:!1,touchAction:be,enable:!0,inputTarget:null,inputClass:null,preset:[[Fe,{enable:!1}],[He,{enable:!1},["rotate"]],[Me,{direction:6}],[Ie,{direction:6},["swipe"]],[Ne],[Ne,{event:"doubletap",taps:2},["tap"]],[Oe]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};function ze(e,t){var i;this.options=o({},qe.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new((i=this).options.inputClass||(H?ie:O?he:I?pe:Z))(i,V),this.touchAction=new Ce(this,this.options.touchAction),Ae(this,!0),d(this.options.recognizers,(function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])}),this)}function Ae(e,t){var i,n=e.element;n.style&&(d(e.options.cssProps,(function(r,o){i=x(n.style,o),t?(e.oldCssProps[i]=n.style[i],n.style[i]=r):n.style[i]=e.oldCssProps[i]||""})),t||(e.oldCssProps={}))}ze.prototype={set:function(e){return o(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){var i;this.touchAction.preventDefaults(e);var n=this.recognizers,r=t.curRecognizer;(!r||r&&8&r.state)&&(r=t.curRecognizer=null);for(var o=0;o<n.length;)i=n[o],2===t.stopped||r&&i!=r&&!i.canRecognizeWith(r)?i.reset():i.recognize(e),!r&&14&i.state&&(r=t.curRecognizer=i),o++}},get:function(e){if(e instanceof Ee)return e;for(var t=this.recognizers,i=0;i<t.length;i++)if(t[i].options.event==e)return t[i];return null},add:function(e){if(p(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(p(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,i=D(t,e);-1!==i&&(t.splice(i,1),this.touchAction.update())}return this},on:function(e,t){if(e!==r&&t!==r){var i=this.handlers;return d(C(e),(function(e){i[e]=i[e]||[],i[e].push(t)})),this}},off:function(e,t){if(e!==r){var i=this.handlers;return d(C(e),(function(e){t?i[e]&&i[e].splice(D(i[e],t),1):delete i[e]})),this}},emit:function(e,t){this.options.domEvents&&function(e,t){var n=i.createEvent("Event");n.initEvent(e,!0,!0),n.gesture=t,t.target.dispatchEvent(n)}(e,t);var n=this.handlers[e]&&this.handlers[e].slice();if(n&&n.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var r=0;r<n.length;)n[r](t),r++}},destroy:function(){this.element&&Ae(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},o(qe,{INPUT_START:1,INPUT_MOVE:2,INPUT_END:4,INPUT_CANCEL:8,STATE_POSSIBLE:1,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:De,DIRECTION_NONE:1,DIRECTION_LEFT:2,DIRECTION_RIGHT:4,DIRECTION_UP:8,DIRECTION_DOWN:16,DIRECTION_HORIZONTAL:6,DIRECTION_VERTICAL:N,DIRECTION_ALL:30,Manager:ze,Input:A,TouchAction:Ce,TouchInput:he,MouseInput:Z,PointerEventInput:ie,TouchMouseInput:pe,SingleTouchInput:se,Recognizer:Ee,AttrRecognizer:Le,Tap:Ne,Pan:Ie,Swipe:Me,Pinch:He,Rotate:Fe,Press:Oe,on:S,off:k,each:d,merge:y,extend:g,assign:o,inherit:m,bindFn:b,prefixed:x}),(void 0!==t?t:"undefined"!=typeof self?self:{}).Hammer=qe,e.exports?e.exports=qe:t.Hammer=qe}(window,document)}));var D,E,P=(D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function i(){this.constructor=e}D(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),x=function(e){function t(t,i){var n=this,r=this.constructor.prototype;return(n=e.call(this,t)||this).statusCode=i,n.__proto__=r,n}return P(t,e),t}(Error),R=function(e){function t(t){void 0===t&&(t="A timeout occurred.");var i=this,n=this.constructor.prototype;return(i=e.call(this,t)||this).__proto__=n,i}return P(t,e),t}(Error),L=function(e){function t(t){void 0===t&&(t="An abort occurred.");var i=this,n=this.constructor.prototype;return(i=e.call(this,t)||this).__proto__=n,i}return P(t,e),t}(Error),I=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},H=function(e,t,i){this.statusCode=e,this.statusText=t,this.content=i},O=function(){function e(){}return e.prototype.get=function(e,t){return this.send(I({},t,{method:"GET",url:e}))},e.prototype.post=function(e,t){return this.send(I({},t,{method:"POST",url:e}))},e.prototype.delete=function(e,t){return this.send(I({},t,{method:"DELETE",url:e}))},e.prototype.getCookieString=function(e){return""},e}();!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(E||(E={}));var F=function(){function e(){}return e.prototype.log=function(e,t){},e.instance=new e,e}(),M=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},N=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},q=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},z=function(){function e(){}return e.isRequired=function(e,t){if(null==e)throw new Error("The '"+t+"' argument is required.")},e.isNotEmpty=function(e,t){if(!e||e.match(/^\s*$/))throw new Error("The '"+t+"' argument should not be empty.")},e.isIn=function(e,t,i){if(!(e in t))throw new Error("Unknown "+i+" value: "+e+".")},e}(),A=function(){function e(){}return Object.defineProperty(e,"isBrowser",{get:function(){return"object"==typeof window},enumerable:!0,configurable:!0}),Object.defineProperty(e,"isWebWorker",{get:function(){return"object"==typeof self&&"importScripts"in self},enumerable:!0,configurable:!0}),Object.defineProperty(e,"isNode",{get:function(){return!this.isBrowser&&!this.isWebWorker},enumerable:!0,configurable:!0}),e}();function V(e,t){var i="";return B(e)?(i="Binary data of length "+e.byteLength,t&&(i+=". Content: '"+function(e){var t=new Uint8Array(e),i="";return t.forEach((function(e){i+="0x"+(e<16?"0":"")+e.toString(16)+" "})),i.substr(0,i.length-1)}(e)+"'")):"string"==typeof e&&(i="String data of length "+e.length,t&&(i+=". Content: '"+e+"'")),i}function B(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function $(e,t,i,n,r,o,s,a,l){return N(this,void 0,void 0,(function(){var c,h,u,p,d,f,g,y;return q(this,(function(m){switch(m.label){case 0:return h={},r?[4,r()]:[3,2];case 1:(u=m.sent())&&((c={}).Authorization="Bearer "+u,h=c),m.label=2;case 2:return p=Y(),d=p[0],f=p[1],h[d]=f,e.log(E.Trace,"("+t+" transport) sending data. "+V(o,s)+"."),g=B(o)?"arraybuffer":"text",[4,i.post(n,{content:o,headers:M({},h,l),responseType:g,withCredentials:a})];case 3:return y=m.sent(),e.log(E.Trace,"("+t+" transport) request complete. Response status: "+y.statusCode+"."),[2]}}))}))}var X=function(){function e(e,t){this.subject=e,this.observer=t}return e.prototype.dispose=function(){var e=this.subject.observers.indexOf(this.observer);e>-1&&this.subject.observers.splice(e,1),0===this.subject.observers.length&&this.subject.cancelCallback&&this.subject.cancelCallback().catch((function(e){}))},e}(),W=function(){function e(e){this.minimumLogLevel=e,this.outputConsole=console}return e.prototype.log=function(e,t){if(e>=this.minimumLogLevel)switch(e){case E.Critical:case E.Error:this.outputConsole.error("["+(new Date).toISOString()+"] "+E[e]+": "+t);break;case E.Warning:this.outputConsole.warn("["+(new Date).toISOString()+"] "+E[e]+": "+t);break;case E.Information:this.outputConsole.info("["+(new Date).toISOString()+"] "+E[e]+": "+t);break;default:this.outputConsole.log("["+(new Date).toISOString()+"] "+E[e]+": "+t)}},e}();function Y(){var e="X-SignalR-User-Agent";return A.isNode&&(e="User-Agent"),[e,J("5.0.5",j(),G(),U())]}function J(e,t,i,n){var r="Microsoft SignalR/",o=e.split(".");return r+=o[0]+"."+o[1],r+=" ("+e+"; ",r+=t&&""!==t?t+"; ":"Unknown OS; ",r+=""+i,r+=n?"; "+n:"; Unknown Runtime Version",r+=")"}function j(){if(!A.isNode)return"";switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}}function U(){if(A.isNode)return process.versions.node}function G(){return A.isNode?"NodeJS":"Browser"}var Z=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),K=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Q=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},ee=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},te=function(e){function t(t){var i=e.call(this)||this;if(i.logger=t,"undefined"==typeof fetch){var n="function"==typeof __webpack_require__?__non_webpack_require__:require;i.jar=new(n("tough-cookie").CookieJar),i.fetchType=n("node-fetch"),i.fetchType=n("fetch-cookie")(i.fetchType,i.jar),i.abortControllerType=n("abort-controller")}else i.fetchType=fetch.bind(self),i.abortControllerType=AbortController;return i}return Z(t,e),t.prototype.send=function(e){return Q(this,void 0,void 0,(function(){var t,i,n,r,o,s,a,l=this;return ee(this,(function(c){switch(c.label){case 0:if(e.abortSignal&&e.abortSignal.aborted)throw new L;if(!e.method)throw new Error("No method defined.");if(!e.url)throw new Error("No url defined.");t=new this.abortControllerType,e.abortSignal&&(e.abortSignal.onabort=function(){t.abort(),i=new L}),n=null,e.timeout&&(r=e.timeout,n=setTimeout((function(){t.abort(),l.logger.log(E.Warning,"Timeout from HTTP request."),i=new R}),r)),c.label=1;case 1:return c.trys.push([1,3,4,5]),[4,this.fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:K({"Content-Type":"text/plain;charset=UTF-8","X-Requested-With":"XMLHttpRequest"},e.headers),method:e.method,mode:"cors",redirect:"manual",signal:t.signal})];case 2:return o=c.sent(),[3,5];case 3:if(s=c.sent(),i)throw i;throw this.logger.log(E.Warning,"Error from HTTP request. "+s+"."),s;case 4:return n&&clearTimeout(n),e.abortSignal&&(e.abortSignal.onabort=null),[7];case 5:if(!o.ok)throw new x(o.statusText,o.status);return[4,function(e,t){var i;switch(t){case"arraybuffer":i=e.arrayBuffer();break;case"text":i=e.text();break;case"blob":case"document":case"json":throw new Error(t+" is not supported.");default:i=e.text()}return i}(o,e.responseType)];case 6:return a=c.sent(),[2,new H(o.status,o.statusText,a)]}}))}))},t.prototype.getCookieString=function(e){var t="";return A.isNode&&this.jar&&this.jar.getCookies(e,(function(e,i){return t=i.join("; ")})),t},t}(O);var ie,ne=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),re=function(e){function t(t){var i=e.call(this)||this;return i.logger=t,i}return ne(t,e),t.prototype.send=function(e){var t=this;return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new L):e.method?e.url?new Promise((function(i,n){var r=new XMLHttpRequest;r.open(e.method,e.url,!0),r.withCredentials=void 0===e.withCredentials||e.withCredentials,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","text/plain;charset=UTF-8");var o=e.headers;o&&Object.keys(o).forEach((function(e){r.setRequestHeader(e,o[e])})),e.responseType&&(r.responseType=e.responseType),e.abortSignal&&(e.abortSignal.onabort=function(){r.abort(),n(new L)}),e.timeout&&(r.timeout=e.timeout),r.onload=function(){e.abortSignal&&(e.abortSignal.onabort=null),r.status>=200&&r.status<300?i(new H(r.status,r.statusText,r.response||r.responseText)):n(new x(r.statusText,r.status))},r.onerror=function(){t.logger.log(E.Warning,"Error from HTTP request. "+r.status+": "+r.statusText+"."),n(new x(r.statusText,r.status))},r.ontimeout=function(){t.logger.log(E.Warning,"Timeout from HTTP request."),n(new R)},r.send(e.content||"")})):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))},t}(O),oe=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),se=function(e){function t(t){var i=e.call(this)||this;if("undefined"!=typeof fetch||A.isNode)i.httpClient=new te(t);else{if("undefined"==typeof XMLHttpRequest)throw new Error("No usable HttpClient found.");i.httpClient=new re(t)}return i}return oe(t,e),t.prototype.send=function(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new L):e.method?e.url?this.httpClient.send(e):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))},t.prototype.getCookieString=function(e){return this.httpClient.getCookieString(e)},t}(O),ae=function(){function e(){}return e.write=function(t){return""+t+e.RecordSeparator},e.parse=function(t){if(t[t.length-1]!==e.RecordSeparator)throw new Error("Message is incomplete.");var i=t.split(e.RecordSeparator);return i.pop(),i},e.RecordSeparatorCode=30,e.RecordSeparator=String.fromCharCode(e.RecordSeparatorCode),e}(),le=function(){function e(){}return e.prototype.writeHandshakeRequest=function(e){return ae.write(JSON.stringify(e))},e.prototype.parseHandshakeResponse=function(e){var t,i;if(B(e)||"undefined"!=typeof Buffer&&e instanceof Buffer){var n=new Uint8Array(e);if(-1===(o=n.indexOf(ae.RecordSeparatorCode)))throw new Error("Message is incomplete.");var r=o+1;t=String.fromCharCode.apply(null,n.slice(0,r)),i=n.byteLength>r?n.slice(r).buffer:null}else{var o,s=e;if(-1===(o=s.indexOf(ae.RecordSeparator)))throw new Error("Message is incomplete.");r=o+1;t=s.substring(0,r),i=s.length>r?s.substring(r):null}var a=ae.parse(t),l=JSON.parse(a[0]);if(l.type)throw new Error("Expected a handshake response from the server.");return[i,l]},e}();!function(e){e[e.Invocation=1]="Invocation",e[e.StreamItem=2]="StreamItem",e[e.Completion=3]="Completion",e[e.StreamInvocation=4]="StreamInvocation",e[e.CancelInvocation=5]="CancelInvocation",e[e.Ping=6]="Ping",e[e.Close=7]="Close"}(ie||(ie={}));var ce,he=function(){function e(){this.observers=[]}return e.prototype.next=function(e){for(var t=0,i=this.observers;t<i.length;t++){i[t].next(e)}},e.prototype.error=function(e){for(var t=0,i=this.observers;t<i.length;t++){var n=i[t];n.error&&n.error(e)}},e.prototype.complete=function(){for(var e=0,t=this.observers;e<t.length;e++){var i=t[e];i.complete&&i.complete()}},e.prototype.subscribe=function(e){return this.observers.push(e),new X(this,e)},e}(),ue=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},pe=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};!function(e){e.Disconnected="Disconnected",e.Connecting="Connecting",e.Connected="Connected",e.Disconnecting="Disconnecting",e.Reconnecting="Reconnecting"}(ce||(ce={}));var de,fe,ge=function(){function e(e,t,i,n){var r=this;z.isRequired(e,"connection"),z.isRequired(t,"logger"),z.isRequired(i,"protocol"),this.serverTimeoutInMilliseconds=3e4,this.keepAliveIntervalInMilliseconds=15e3,this.logger=t,this.protocol=i,this.connection=e,this.reconnectPolicy=n,this.handshakeProtocol=new le,this.connection.onreceive=function(e){return r.processIncomingData(e)},this.connection.onclose=function(e){return r.connectionClosed(e)},this.callbacks={},this.methods={},this.closedCallbacks=[],this.reconnectingCallbacks=[],this.reconnectedCallbacks=[],this.invocationId=0,this.receivedHandshakeResponse=!1,this.connectionState=ce.Disconnected,this.connectionStarted=!1,this.cachedPingMessage=this.protocol.writeMessage({type:ie.Ping})}return e.create=function(t,i,n,r){return new e(t,i,n,r)},Object.defineProperty(e.prototype,"state",{get:function(){return this.connectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connectionId",{get:function(){return this.connection&&this.connection.connectionId||null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseUrl",{get:function(){return this.connection.baseUrl||""},set:function(e){if(this.connectionState!==ce.Disconnected&&this.connectionState!==ce.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e},enumerable:!0,configurable:!0}),e.prototype.start=function(){return this.startPromise=this.startWithStateTransitions(),this.startPromise},e.prototype.startWithStateTransitions=function(){return ue(this,void 0,void 0,(function(){var e;return pe(this,(function(t){switch(t.label){case 0:if(this.connectionState!==ce.Disconnected)return[2,Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."))];this.connectionState=ce.Connecting,this.logger.log(E.Debug,"Starting HubConnection."),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.startInternal()];case 2:return t.sent(),this.connectionState=ce.Connected,this.connectionStarted=!0,this.logger.log(E.Debug,"HubConnection connected successfully."),[3,4];case 3:return e=t.sent(),this.connectionState=ce.Disconnected,this.logger.log(E.Debug,"HubConnection failed to start successfully because of error '"+e+"'."),[2,Promise.reject(e)];case 4:return[2]}}))}))},e.prototype.startInternal=function(){return ue(this,void 0,void 0,(function(){var e,t,i,n=this;return pe(this,(function(r){switch(r.label){case 0:return this.stopDuringStartError=void 0,this.receivedHandshakeResponse=!1,e=new Promise((function(e,t){n.handshakeResolver=e,n.handshakeRejecter=t})),[4,this.connection.start(this.protocol.transferFormat)];case 1:r.sent(),r.label=2;case 2:return r.trys.push([2,5,,7]),t={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(E.Debug,"Sending handshake request."),[4,this.sendMessage(this.handshakeProtocol.writeHandshakeRequest(t))];case 3:return r.sent(),this.logger.log(E.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.resetTimeoutPeriod(),this.resetKeepAliveInterval(),[4,e];case 4:if(r.sent(),this.stopDuringStartError)throw this.stopDuringStartError;return[3,7];case 5:return i=r.sent(),this.logger.log(E.Debug,"Hub handshake failed with error '"+i+"' during start(). Stopping HubConnection."),this.cleanupTimeout(),this.cleanupPingTimer(),[4,this.connection.stop(i)];case 6:throw r.sent(),i;case 7:return[2]}}))}))},e.prototype.stop=function(){return ue(this,void 0,void 0,(function(){var e;return pe(this,(function(t){switch(t.label){case 0:return e=this.startPromise,this.stopPromise=this.stopInternal(),[4,this.stopPromise];case 1:t.sent(),t.label=2;case 2:return t.trys.push([2,4,,5]),[4,e];case 3:return t.sent(),[3,5];case 4:return t.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.stopInternal=function(e){return this.connectionState===ce.Disconnected?(this.logger.log(E.Debug,"Call to HubConnection.stop("+e+") ignored because it is already in the disconnected state."),Promise.resolve()):this.connectionState===ce.Disconnecting?(this.logger.log(E.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnecting state."),this.stopPromise):(this.connectionState=ce.Disconnecting,this.logger.log(E.Debug,"Stopping HubConnection."),this.reconnectDelayHandle?(this.logger.log(E.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this.reconnectDelayHandle),this.reconnectDelayHandle=void 0,this.completeClose(),Promise.resolve()):(this.cleanupTimeout(),this.cleanupPingTimer(),this.stopDuringStartError=e||new Error("The connection was stopped before the hub handshake could complete."),this.connection.stop(e)))},e.prototype.stream=function(e){for(var t=this,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];var r,o=this.replaceStreamingParams(i),s=o[0],a=o[1],l=this.createStreamInvocation(e,i,a),c=new he;return c.cancelCallback=function(){var e=t.createCancelInvocation(l.invocationId);return delete t.callbacks[l.invocationId],r.then((function(){return t.sendWithProtocol(e)}))},this.callbacks[l.invocationId]=function(e,t){t?c.error(t):e&&(e.type===ie.Completion?e.error?c.error(new Error(e.error)):c.complete():c.next(e.item))},r=this.sendWithProtocol(l).catch((function(e){c.error(e),delete t.callbacks[l.invocationId]})),this.launchStreams(s,r),c},e.prototype.sendMessage=function(e){return this.resetKeepAliveInterval(),this.connection.send(e)},e.prototype.sendWithProtocol=function(e){return this.sendMessage(this.protocol.writeMessage(e))},e.prototype.send=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var n=this.replaceStreamingParams(t),r=n[0],o=n[1],s=this.sendWithProtocol(this.createInvocation(e,t,!0,o));return this.launchStreams(r,s),s},e.prototype.invoke=function(e){for(var t=this,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];var r=this.replaceStreamingParams(i),o=r[0],s=r[1],a=this.createInvocation(e,i,!1,s),l=new Promise((function(e,i){t.callbacks[a.invocationId]=function(t,n){n?i(n):t&&(t.type===ie.Completion?t.error?i(new Error(t.error)):e(t.result):i(new Error("Unexpected message type: "+t.type)))};var n=t.sendWithProtocol(a).catch((function(e){i(e),delete t.callbacks[a.invocationId]}));t.launchStreams(o,n)}));return l},e.prototype.on=function(e,t){e&&t&&(e=e.toLowerCase(),this.methods[e]||(this.methods[e]=[]),-1===this.methods[e].indexOf(t)&&this.methods[e].push(t))},e.prototype.off=function(e,t){if(e){e=e.toLowerCase();var i=this.methods[e];if(i)if(t){var n=i.indexOf(t);-1!==n&&(i.splice(n,1),0===i.length&&delete this.methods[e])}else delete this.methods[e]}},e.prototype.onclose=function(e){e&&this.closedCallbacks.push(e)},e.prototype.onreconnecting=function(e){e&&this.reconnectingCallbacks.push(e)},e.prototype.onreconnected=function(e){e&&this.reconnectedCallbacks.push(e)},e.prototype.processIncomingData=function(e){if(this.cleanupTimeout(),this.receivedHandshakeResponse||(e=this.processHandshakeResponse(e),this.receivedHandshakeResponse=!0),e)for(var t=0,i=this.protocol.parseMessages(e,this.logger);t<i.length;t++){var n=i[t];switch(n.type){case ie.Invocation:this.invokeClientMethod(n);break;case ie.StreamItem:case ie.Completion:var r=this.callbacks[n.invocationId];r&&(n.type===ie.Completion&&delete this.callbacks[n.invocationId],r(n));break;case ie.Ping:break;case ie.Close:this.logger.log(E.Information,"Close message received from server.");var o=n.error?new Error("Server returned an error on close: "+n.error):void 0;!0===n.allowReconnect?this.connection.stop(o):this.stopPromise=this.stopInternal(o);break;default:this.logger.log(E.Warning,"Invalid message type: "+n.type+".")}}this.resetTimeoutPeriod()},e.prototype.processHandshakeResponse=function(e){var t,i,n;try{n=(t=this.handshakeProtocol.parseHandshakeResponse(e))[0],i=t[1]}catch(e){var r="Error parsing handshake response: "+e;this.logger.log(E.Error,r);var o=new Error(r);throw this.handshakeRejecter(o),o}if(i.error){r="Server returned handshake error: "+i.error;this.logger.log(E.Error,r);o=new Error(r);throw this.handshakeRejecter(o),o}return this.logger.log(E.Debug,"Server handshake complete."),this.handshakeResolver(),n},e.prototype.resetKeepAliveInterval=function(){var e=this;this.connection.features.inherentKeepAlive||(this.cleanupPingTimer(),this.pingServerHandle=setTimeout((function(){return ue(e,void 0,void 0,(function(){return pe(this,(function(e){switch(e.label){case 0:if(this.connectionState!==ce.Connected)return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.sendMessage(this.cachedPingMessage)];case 2:return e.sent(),[3,4];case 3:return e.sent(),this.cleanupPingTimer(),[3,4];case 4:return[2]}}))}))}),this.keepAliveIntervalInMilliseconds))},e.prototype.resetTimeoutPeriod=function(){var e=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout((function(){return e.serverTimeout()}),this.serverTimeoutInMilliseconds))},e.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},e.prototype.invokeClientMethod=function(e){var t=this,i=this.methods[e.target.toLowerCase()];if(i){try{i.forEach((function(i){return i.apply(t,e.arguments)}))}catch(t){this.logger.log(E.Error,"A callback for the method "+e.target.toLowerCase()+" threw error '"+t+"'.")}if(e.invocationId){var n="Server requested a response, which is not supported in this version of the client.";this.logger.log(E.Error,n),this.stopPromise=this.stopInternal(new Error(n))}}else this.logger.log(E.Warning,"No client method with the name '"+e.target+"' found.")},e.prototype.connectionClosed=function(e){this.logger.log(E.Debug,"HubConnection.connectionClosed("+e+") called while in state "+this.connectionState+"."),this.stopDuringStartError=this.stopDuringStartError||e||new Error("The underlying connection was closed before the hub handshake could complete."),this.handshakeResolver&&this.handshakeResolver(),this.cancelCallbacksWithError(e||new Error("Invocation canceled due to the underlying connection being closed.")),this.cleanupTimeout(),this.cleanupPingTimer(),this.connectionState===ce.Disconnecting?this.completeClose(e):this.connectionState===ce.Connected&&this.reconnectPolicy?this.reconnect(e):this.connectionState===ce.Connected&&this.completeClose(e)},e.prototype.completeClose=function(e){var t=this;if(this.connectionStarted){this.connectionState=ce.Disconnected,this.connectionStarted=!1;try{this.closedCallbacks.forEach((function(i){return i.apply(t,[e])}))}catch(t){this.logger.log(E.Error,"An onclose callback called with error '"+e+"' threw error '"+t+"'.")}}},e.prototype.reconnect=function(e){return ue(this,void 0,void 0,(function(){var t,i,n,r,o,s=this;return pe(this,(function(a){switch(a.label){case 0:if(t=Date.now(),i=0,n=void 0!==e?e:new Error("Attempting to reconnect due to a unknown error."),null===(r=this.getNextRetryDelay(i++,0,n)))return this.logger.log(E.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this.completeClose(e),[2];if(this.connectionState=ce.Reconnecting,e?this.logger.log(E.Information,"Connection reconnecting because of error '"+e+"'."):this.logger.log(E.Information,"Connection reconnecting."),this.onreconnecting){try{this.reconnectingCallbacks.forEach((function(t){return t.apply(s,[e])}))}catch(t){this.logger.log(E.Error,"An onreconnecting callback called with error '"+e+"' threw error '"+t+"'.")}if(this.connectionState!==ce.Reconnecting)return this.logger.log(E.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting."),[2]}a.label=1;case 1:return null===r?[3,7]:(this.logger.log(E.Information,"Reconnect attempt number "+i+" will start in "+r+" ms."),[4,new Promise((function(e){s.reconnectDelayHandle=setTimeout(e,r)}))]);case 2:if(a.sent(),this.reconnectDelayHandle=void 0,this.connectionState!==ce.Reconnecting)return this.logger.log(E.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting."),[2];a.label=3;case 3:return a.trys.push([3,5,,6]),[4,this.startInternal()];case 4:if(a.sent(),this.connectionState=ce.Connected,this.logger.log(E.Information,"HubConnection reconnected successfully."),this.onreconnected)try{this.reconnectedCallbacks.forEach((function(e){return e.apply(s,[s.connection.connectionId])}))}catch(e){this.logger.log(E.Error,"An onreconnected callback called with connectionId '"+this.connection.connectionId+"; threw error '"+e+"'.")}return[2];case 5:return o=a.sent(),this.logger.log(E.Information,"Reconnect attempt failed because of error '"+o+"'."),this.connectionState!==ce.Reconnecting?(this.logger.log(E.Debug,"Connection left the reconnecting state during reconnect attempt. Done reconnecting."),[2]):(n=o instanceof Error?o:new Error(o.toString()),r=this.getNextRetryDelay(i++,Date.now()-t,n),[3,6]);case 6:return[3,1];case 7:return this.logger.log(E.Information,"Reconnect retries have been exhausted after "+(Date.now()-t)+" ms and "+i+" failed attempts. Connection disconnecting."),this.completeClose(),[2]}}))}))},e.prototype.getNextRetryDelay=function(e,t,i){try{return this.reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:e,retryReason:i})}catch(i){return this.logger.log(E.Error,"IRetryPolicy.nextRetryDelayInMilliseconds("+e+", "+t+") threw error '"+i+"'."),null}},e.prototype.cancelCallbacksWithError=function(e){var t=this.callbacks;this.callbacks={},Object.keys(t).forEach((function(i){(0,t[i])(null,e)}))},e.prototype.cleanupPingTimer=function(){this.pingServerHandle&&clearTimeout(this.pingServerHandle)},e.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},e.prototype.createInvocation=function(e,t,i,n){if(i)return 0!==n.length?{arguments:t,streamIds:n,target:e,type:ie.Invocation}:{arguments:t,target:e,type:ie.Invocation};var r=this.invocationId;return this.invocationId++,0!==n.length?{arguments:t,invocationId:r.toString(),streamIds:n,target:e,type:ie.Invocation}:{arguments:t,invocationId:r.toString(),target:e,type:ie.Invocation}},e.prototype.launchStreams=function(e,t){var i=this;if(0!==e.length){t||(t=Promise.resolve());var n=function(n){e[n].subscribe({complete:function(){t=t.then((function(){return i.sendWithProtocol(i.createCompletionMessage(n))}))},error:function(e){var r;r=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",t=t.then((function(){return i.sendWithProtocol(i.createCompletionMessage(n,r))}))},next:function(e){t=t.then((function(){return i.sendWithProtocol(i.createStreamItemMessage(n,e))}))}})};for(var r in e)n(r)}},e.prototype.replaceStreamingParams=function(e){for(var t=[],i=[],n=0;n<e.length;n++){var r=e[n];if(this.isObservable(r)){var o=this.invocationId;this.invocationId++,t[o]=r,i.push(o.toString()),e.splice(n,1)}}return[t,i]},e.prototype.isObservable=function(e){return e&&e.subscribe&&"function"==typeof e.subscribe},e.prototype.createStreamInvocation=function(e,t,i){var n=this.invocationId;return this.invocationId++,0!==i.length?{arguments:t,invocationId:n.toString(),streamIds:i,target:e,type:ie.StreamInvocation}:{arguments:t,invocationId:n.toString(),target:e,type:ie.StreamInvocation}},e.prototype.createCancelInvocation=function(e){return{invocationId:e,type:ie.CancelInvocation}},e.prototype.createStreamItemMessage=function(e,t){return{invocationId:e,item:t,type:ie.StreamItem}},e.prototype.createCompletionMessage=function(e,t,i){return t?{error:t,invocationId:e,type:ie.Completion}:{invocationId:e,result:i,type:ie.Completion}},e}(),ye=[0,2e3,1e4,3e4,null],me=function(){function e(e){this.retryDelays=void 0!==e?e.concat([null]):ye}return e.prototype.nextRetryDelayInMilliseconds=function(e){return this.retryDelays[e.previousRetryCount]},e}();!function(e){e[e.None=0]="None",e[e.WebSockets=1]="WebSockets",e[e.ServerSentEvents=2]="ServerSentEvents",e[e.LongPolling=4]="LongPolling"}(de||(de={})),function(e){e[e.Text=1]="Text",e[e.Binary=2]="Binary"}(fe||(fe={}));var be=function(){function e(){this.isAborted=!1,this.onabort=null}return e.prototype.abort=function(){this.isAborted||(this.isAborted=!0,this.onabort&&this.onabort())},Object.defineProperty(e.prototype,"signal",{get:function(){return this},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aborted",{get:function(){return this.isAborted},enumerable:!0,configurable:!0}),e}(),we=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},ve=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},Se=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},ke=function(){function e(e,t,i,n,r,o){this.httpClient=e,this.accessTokenFactory=t,this.logger=i,this.pollAbort=new be,this.logMessageContent=n,this.withCredentials=r,this.headers=o,this.running=!1,this.onreceive=null,this.onclose=null}return Object.defineProperty(e.prototype,"pollAborted",{get:function(){return this.pollAbort.aborted},enumerable:!0,configurable:!0}),e.prototype.connect=function(e,t){return ve(this,void 0,void 0,(function(){var i,n,r,o,s,a,l,c,h;return Se(this,(function(u){switch(u.label){case 0:if(z.isRequired(e,"url"),z.isRequired(t,"transferFormat"),z.isIn(t,fe,"transferFormat"),this.url=e,this.logger.log(E.Trace,"(LongPolling transport) Connecting."),t===fe.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");return n=Y(),r=n[0],o=n[1],s=we(((i={})[r]=o,i),this.headers),a={abortSignal:this.pollAbort.signal,headers:s,timeout:1e5,withCredentials:this.withCredentials},t===fe.Binary&&(a.responseType="arraybuffer"),[4,this.getAccessToken()];case 1:return l=u.sent(),this.updateHeaderToken(a,l),c=e+"&_="+Date.now(),this.logger.log(E.Trace,"(LongPolling transport) polling: "+c+"."),[4,this.httpClient.get(c,a)];case 2:return 200!==(h=u.sent()).statusCode?(this.logger.log(E.Error,"(LongPolling transport) Unexpected response code: "+h.statusCode+"."),this.closeError=new x(h.statusText||"",h.statusCode),this.running=!1):this.running=!0,this.receiving=this.poll(this.url,a),[2]}}))}))},e.prototype.getAccessToken=function(){return ve(this,void 0,void 0,(function(){return Se(this,(function(e){switch(e.label){case 0:return this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:return[2,e.sent()];case 2:return[2,null]}}))}))},e.prototype.updateHeaderToken=function(e,t){e.headers||(e.headers={}),t?e.headers.Authorization="Bearer "+t:e.headers.Authorization&&delete e.headers.Authorization},e.prototype.poll=function(e,t){return ve(this,void 0,void 0,(function(){var i,n,r,o;return Se(this,(function(s){switch(s.label){case 0:s.trys.push([0,,8,9]),s.label=1;case 1:return this.running?[4,this.getAccessToken()]:[3,7];case 2:i=s.sent(),this.updateHeaderToken(t,i),s.label=3;case 3:return s.trys.push([3,5,,6]),n=e+"&_="+Date.now(),this.logger.log(E.Trace,"(LongPolling transport) polling: "+n+"."),[4,this.httpClient.get(n,t)];case 4:return 204===(r=s.sent()).statusCode?(this.logger.log(E.Information,"(LongPolling transport) Poll terminated by server."),this.running=!1):200!==r.statusCode?(this.logger.log(E.Error,"(LongPolling transport) Unexpected response code: "+r.statusCode+"."),this.closeError=new x(r.statusText||"",r.statusCode),this.running=!1):r.content?(this.logger.log(E.Trace,"(LongPolling transport) data received. "+V(r.content,this.logMessageContent)+"."),this.onreceive&&this.onreceive(r.content)):this.logger.log(E.Trace,"(LongPolling transport) Poll timed out, reissuing."),[3,6];case 5:return o=s.sent(),this.running?o instanceof R?this.logger.log(E.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this.closeError=o,this.running=!1):this.logger.log(E.Trace,"(LongPolling transport) Poll errored after shutdown: "+o.message),[3,6];case 6:return[3,1];case 7:return[3,9];case 8:return this.logger.log(E.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this.raiseOnClose(),[7];case 9:return[2]}}))}))},e.prototype.send=function(e){return ve(this,void 0,void 0,(function(){return Se(this,(function(t){return this.running?[2,$(this.logger,"LongPolling",this.httpClient,this.url,this.accessTokenFactory,e,this.logMessageContent,this.withCredentials,this.headers)]:[2,Promise.reject(new Error("Cannot send until the transport is connected"))]}))}))},e.prototype.stop=function(){return ve(this,void 0,void 0,(function(){var e,t,i,n,r,o;return Se(this,(function(s){switch(s.label){case 0:this.logger.log(E.Trace,"(LongPolling transport) Stopping polling."),this.running=!1,this.pollAbort.abort(),s.label=1;case 1:return s.trys.push([1,,5,6]),[4,this.receiving];case 2:return s.sent(),this.logger.log(E.Trace,"(LongPolling transport) sending DELETE request to "+this.url+"."),e={},t=Y(),i=t[0],n=t[1],e[i]=n,r={headers:we({},e,this.headers),withCredentials:this.withCredentials},[4,this.getAccessToken()];case 3:return o=s.sent(),this.updateHeaderToken(r,o),[4,this.httpClient.delete(this.url,r)];case 4:return s.sent(),this.logger.log(E.Trace,"(LongPolling transport) DELETE request sent."),[3,6];case 5:return this.logger.log(E.Trace,"(LongPolling transport) Stop finished."),this.raiseOnClose(),[7];case 6:return[2]}}))}))},e.prototype.raiseOnClose=function(){if(this.onclose){var e="(LongPolling transport) Firing onclose event.";this.closeError&&(e+=" Error: "+this.closeError),this.logger.log(E.Trace,e),this.onclose(this.closeError)}},e}(),_e=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Te=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},Ce=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},De=function(){function e(e,t,i,n,r,o,s){this.httpClient=e,this.accessTokenFactory=t,this.logger=i,this.logMessageContent=n,this.withCredentials=o,this.eventSourceConstructor=r,this.headers=s,this.onreceive=null,this.onclose=null}return e.prototype.connect=function(e,t){return Te(this,void 0,void 0,(function(){var i,n=this;return Ce(this,(function(r){switch(r.label){case 0:return z.isRequired(e,"url"),z.isRequired(t,"transferFormat"),z.isIn(t,fe,"transferFormat"),this.logger.log(E.Trace,"(SSE transport) Connecting."),this.url=e,this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(i=r.sent())&&(e+=(e.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(i)),r.label=2;case 2:return[2,new Promise((function(i,r){var o=!1;if(t===fe.Text){var s;if(A.isBrowser||A.isWebWorker)s=new n.eventSourceConstructor(e,{withCredentials:n.withCredentials});else{var a=n.httpClient.getCookieString(e),l={};l.Cookie=a;var c=Y(),h=c[0],u=c[1];l[h]=u,s=new n.eventSourceConstructor(e,{withCredentials:n.withCredentials,headers:_e({},l,n.headers)})}try{s.onmessage=function(e){if(n.onreceive)try{n.logger.log(E.Trace,"(SSE transport) data received. "+V(e.data,n.logMessageContent)+"."),n.onreceive(e.data)}catch(e){return void n.close(e)}},s.onerror=function(e){var t=new Error(e.data||"Error occurred");o?n.close(t):r(t)},s.onopen=function(){n.logger.log(E.Information,"SSE connected to "+n.url),n.eventSource=s,o=!0,i()}}catch(e){return void r(e)}}else r(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"))}))]}}))}))},e.prototype.send=function(e){return Te(this,void 0,void 0,(function(){return Ce(this,(function(t){return this.eventSource?[2,$(this.logger,"SSE",this.httpClient,this.url,this.accessTokenFactory,e,this.logMessageContent,this.withCredentials,this.headers)]:[2,Promise.reject(new Error("Cannot send until the transport is connected"))]}))}))},e.prototype.stop=function(){return this.close(),Promise.resolve()},e.prototype.close=function(e){this.eventSource&&(this.eventSource.close(),this.eventSource=void 0,this.onclose&&this.onclose(e))},e}(),Ee=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Pe=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},xe=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Re=function(){function e(e,t,i,n,r,o){this.logger=i,this.accessTokenFactory=t,this.logMessageContent=n,this.webSocketConstructor=r,this.httpClient=e,this.onreceive=null,this.onclose=null,this.headers=o}return e.prototype.connect=function(e,t){return Pe(this,void 0,void 0,(function(){var i,n=this;return xe(this,(function(r){switch(r.label){case 0:return z.isRequired(e,"url"),z.isRequired(t,"transferFormat"),z.isIn(t,fe,"transferFormat"),this.logger.log(E.Trace,"(WebSockets transport) Connecting."),this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(i=r.sent())&&(e+=(e.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(i)),r.label=2;case 2:return[2,new Promise((function(i,r){var o;e=e.replace(/^http/,"ws");var s=n.httpClient.getCookieString(e),a=!1;if(A.isNode){var l={},c=Y(),h=c[0],u=c[1];l[h]=u,s&&(l.Cookie=""+s),o=new n.webSocketConstructor(e,void 0,{headers:Ee({},l,n.headers)})}o||(o=new n.webSocketConstructor(e)),t===fe.Binary&&(o.binaryType="arraybuffer"),o.onopen=function(t){n.logger.log(E.Information,"WebSocket connected to "+e+"."),n.webSocket=o,a=!0,i()},o.onerror=function(e){var t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:new Error("There was an error with the transport."),r(t)},o.onmessage=function(e){if(n.logger.log(E.Trace,"(WebSockets transport) data received. "+V(e.data,n.logMessageContent)+"."),n.onreceive)try{n.onreceive(e.data)}catch(e){return void n.close(e)}},o.onclose=function(e){if(a)n.close(e);else{var t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:new Error("There was an error with the transport."),r(t)}}}))]}}))}))},e.prototype.send=function(e){return this.webSocket&&this.webSocket.readyState===this.webSocketConstructor.OPEN?(this.logger.log(E.Trace,"(WebSockets transport) sending data. "+V(e,this.logMessageContent)+"."),this.webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")},e.prototype.stop=function(){return this.webSocket&&this.close(void 0),Promise.resolve()},e.prototype.close=function(e){this.webSocket&&(this.webSocket.onclose=function(){},this.webSocket.onmessage=function(){},this.webSocket.onerror=function(){},this.webSocket.close(),this.webSocket=void 0),this.logger.log(E.Trace,"(WebSockets transport) socket closed."),this.onclose&&(!this.isCloseEvent(e)||!1!==e.wasClean&&1e3===e.code?e instanceof Error?this.onclose(e):this.onclose():this.onclose(new Error("WebSocket closed with status code: "+e.code+" ("+e.reason+").")))},e.prototype.isCloseEvent=function(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code},e}(),Le=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Ie=function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){e.done?r(e.value):new i((function(t){t(e.value)})).then(s,a)}l((n=n.apply(e,t||[])).next())}))},He=function(e,t){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Oe=function(){function e(e,t){var i;if(void 0===t&&(t={}),this.features={},this.negotiateVersion=1,z.isRequired(e,"url"),this.logger=void 0===(i=t.logger)?new W(E.Information):null===i?F.instance:i.log?i:new W(i),this.baseUrl=this.resolveUrl(e),(t=t||{}).logMessageContent=void 0!==t.logMessageContent&&t.logMessageContent,"boolean"!=typeof t.withCredentials&&void 0!==t.withCredentials)throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");t.withCredentials=void 0===t.withCredentials||t.withCredentials;var n=null,r=null;if(A.isNode&&"undefined"!=typeof require){var o="function"==typeof __webpack_require__?__non_webpack_require__:require;n=o("ws"),r=o("eventsource")}A.isNode||"undefined"==typeof WebSocket||t.WebSocket?A.isNode&&!t.WebSocket&&n&&(t.WebSocket=n):t.WebSocket=WebSocket,A.isNode||"undefined"==typeof EventSource||t.EventSource?A.isNode&&!t.EventSource&&void 0!==r&&(t.EventSource=r):t.EventSource=EventSource,this.httpClient=t.httpClient||new se(this.logger),this.connectionState="Disconnected",this.connectionStarted=!1,this.options=t,this.onreceive=null,this.onclose=null}return e.prototype.start=function(e){return Ie(this,void 0,void 0,(function(){var t;return He(this,(function(i){switch(i.label){case 0:return e=e||fe.Binary,z.isIn(e,fe,"transferFormat"),this.logger.log(E.Debug,"Starting connection with transfer format '"+fe[e]+"'."),"Disconnected"!==this.connectionState?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting",this.startInternalPromise=this.startInternal(e),[4,this.startInternalPromise]);case 1:return i.sent(),"Disconnecting"!==this.connectionState?[3,3]:(t="Failed to start the HttpConnection before stop() was called.",this.logger.log(E.Error,t),[4,this.stopPromise]);case 2:return i.sent(),[2,Promise.reject(new Error(t))];case 3:if("Connected"!==this.connectionState)return t="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(E.Error,t),[2,Promise.reject(new Error(t))];i.label=4;case 4:return this.connectionStarted=!0,[2]}}))}))},e.prototype.send=function(e){return"Connected"!==this.connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new Fe(this.transport)),this.sendQueue.send(e))},e.prototype.stop=function(e){return Ie(this,void 0,void 0,(function(){var t=this;return He(this,(function(i){switch(i.label){case 0:return"Disconnected"===this.connectionState?(this.logger.log(E.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):"Disconnecting"===this.connectionState?(this.logger.log(E.Debug,"Call to HttpConnection.stop("+e+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise((function(e){t.stopPromiseResolver=e})),[4,this.stopInternal(e)]);case 1:return i.sent(),[4,this.stopPromise];case 2:return i.sent(),[2]}}))}))},e.prototype.stopInternal=function(e){return Ie(this,void 0,void 0,(function(){var t;return He(this,(function(i){switch(i.label){case 0:this.stopError=e,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:return i.sent(),[3,4];case 3:return i.sent(),[3,4];case 4:if(!this.transport)return[3,9];i.label=5;case 5:return i.trys.push([5,7,,8]),[4,this.transport.stop()];case 6:return i.sent(),[3,8];case 7:return t=i.sent(),this.logger.log(E.Error,"HttpConnection.transport.stop() threw error '"+t+"'."),this.stopConnection(),[3,8];case 8:return this.transport=void 0,[3,10];case 9:this.logger.log(E.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed."),this.stopConnection(),i.label=10;case 10:return[2]}}))}))},e.prototype.startInternal=function(e){return Ie(this,void 0,void 0,(function(){var t,i,n,r,o,s;return He(this,(function(a){switch(a.label){case 0:t=this.baseUrl,this.accessTokenFactory=this.options.accessTokenFactory,a.label=1;case 1:return a.trys.push([1,12,,13]),this.options.skipNegotiation?this.options.transport!==de.WebSockets?[3,3]:(this.transport=this.constructTransport(de.WebSockets),[4,this.startTransport(t,e)]):[3,5];case 2:return a.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:i=null,n=0,r=function(){var e;return He(this,(function(r){switch(r.label){case 0:return[4,o.getNegotiationResponse(t)];case 1:if(i=r.sent(),"Disconnecting"===o.connectionState||"Disconnected"===o.connectionState)throw new Error("The connection was stopped during negotiation.");if(i.error)throw new Error(i.error);if(i.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return i.url&&(t=i.url),i.accessToken&&(e=i.accessToken,o.accessTokenFactory=function(){return e}),n++,[2]}}))},o=this,a.label=6;case 6:return[5,r()];case 7:a.sent(),a.label=8;case 8:if(i.url&&n<100)return[3,6];a.label=9;case 9:if(100===n&&i.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(t,this.options.transport,i,e)];case 10:a.sent(),a.label=11;case 11:return this.transport instanceof ke&&(this.features.inherentKeepAlive=!0),"Connecting"===this.connectionState&&(this.logger.log(E.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return s=a.sent(),this.logger.log(E.Error,"Failed to start the connection: "+s),this.connectionState="Disconnected",this.transport=void 0,[2,Promise.reject(s)];case 13:return[2]}}))}))},e.prototype.getNegotiationResponse=function(e){return Ie(this,void 0,void 0,(function(){var t,i,n,r,o,s,a,l,c;return He(this,(function(h){switch(h.label){case 0:return t={},this.accessTokenFactory?[4,this.accessTokenFactory()]:[3,2];case 1:(i=h.sent())&&(t.Authorization="Bearer "+i),h.label=2;case 2:n=Y(),r=n[0],o=n[1],t[r]=o,s=this.resolveNegotiateUrl(e),this.logger.log(E.Debug,"Sending negotiation request: "+s+"."),h.label=3;case 3:return h.trys.push([3,5,,6]),[4,this.httpClient.post(s,{content:"",headers:Le({},t,this.options.headers),withCredentials:this.options.withCredentials})];case 4:return 200!==(a=h.sent()).statusCode?[2,Promise.reject(new Error("Unexpected status code returned from negotiate '"+a.statusCode+"'"))]:((!(l=JSON.parse(a.content)).negotiateVersion||l.negotiateVersion<1)&&(l.connectionToken=l.connectionId),[2,l]);case 5:return c=h.sent(),this.logger.log(E.Error,"Failed to complete negotiation with the server: "+c),[2,Promise.reject(c)];case 6:return[2]}}))}))},e.prototype.createConnectUrl=function(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+"id="+t:e},e.prototype.createTransport=function(e,t,i,n){return Ie(this,void 0,void 0,(function(){var r,o,s,a,l,c,h,u,p,d,f;return He(this,(function(g){switch(g.label){case 0:return r=this.createConnectUrl(e,i.connectionToken),this.isITransport(t)?(this.logger.log(E.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,[4,this.startTransport(r,n)]):[3,2];case 1:return g.sent(),this.connectionId=i.connectionId,[2];case 2:o=[],s=i.availableTransports||[],a=i,l=0,c=s,g.label=3;case 3:return l<c.length?(h=c[l],(u=this.resolveTransportOrError(h,t,n))instanceof Error?(o.push(h.transport+" failed: "+u),[3,12]):[3,4]):[3,13];case 4:if(!this.isITransport(u))return[3,12];if(this.transport=u,a)return[3,9];g.label=5;case 5:return g.trys.push([5,7,,8]),[4,this.getNegotiationResponse(e)];case 6:return a=g.sent(),[3,8];case 7:return p=g.sent(),[2,Promise.reject(p)];case 8:r=this.createConnectUrl(e,a.connectionToken),g.label=9;case 9:return g.trys.push([9,11,,12]),[4,this.startTransport(r,n)];case 10:return g.sent(),this.connectionId=a.connectionId,[2];case 11:return d=g.sent(),this.logger.log(E.Error,"Failed to start the transport '"+h.transport+"': "+d),a=void 0,o.push(h.transport+" failed: "+d),"Connecting"!==this.connectionState?(f="Failed to select transport before stop() was called.",this.logger.log(E.Debug,f),[2,Promise.reject(new Error(f))]):[3,12];case 12:return l++,[3,3];case 13:return o.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+o.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}}))}))},e.prototype.constructTransport=function(e){switch(e){case de.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new Re(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket,this.options.headers||{});case de.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new De(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource,this.options.withCredentials,this.options.headers||{});case de.LongPolling:return new ke(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.withCredentials,this.options.headers||{});default:throw new Error("Unknown transport: "+e+".")}},e.prototype.startTransport=function(e,t){var i=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(e){return i.stopConnection(e)},this.transport.connect(e,t)},e.prototype.resolveTransportOrError=function(e,t,i){var n=de[e.transport];if(null==n)return this.logger.log(E.Debug,"Skipping transport '"+e.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+e.transport+"' because it is not supported by this client.");if(!function(e,t){return!e||0!=(t&e)}(t,n))return this.logger.log(E.Debug,"Skipping transport '"+de[n]+"' because it was disabled by the client."),new Error("'"+de[n]+"' is disabled by the client.");if(!(e.transferFormats.map((function(e){return fe[e]})).indexOf(i)>=0))return this.logger.log(E.Debug,"Skipping transport '"+de[n]+"' because it does not support the requested transfer format '"+fe[i]+"'."),new Error("'"+de[n]+"' does not support "+fe[i]+".");if(n===de.WebSockets&&!this.options.WebSocket||n===de.ServerSentEvents&&!this.options.EventSource)return this.logger.log(E.Debug,"Skipping transport '"+de[n]+"' because it is not supported in your environment.'"),new Error("'"+de[n]+"' is not supported in your environment.");this.logger.log(E.Debug,"Selecting transport '"+de[n]+"'.");try{return this.constructTransport(n)}catch(e){return e}},e.prototype.isITransport=function(e){return e&&"object"==typeof e&&"connect"in e},e.prototype.stopConnection=function(e){var t=this;if(this.logger.log(E.Debug,"HttpConnection.stopConnection("+e+") called while in state "+this.connectionState+"."),this.transport=void 0,e=this.stopError||e,this.stopError=void 0,"Disconnected"!==this.connectionState){if("Connecting"===this.connectionState)throw this.logger.log(E.Warning,"Call to HttpConnection.stopConnection("+e+") was ignored because the connection is still in the connecting state."),new Error("HttpConnection.stopConnection("+e+") was called while the connection is still in the connecting state.");if("Disconnecting"===this.connectionState&&this.stopPromiseResolver(),e?this.logger.log(E.Error,"Connection disconnected with error '"+e+"'."):this.logger.log(E.Information,"Connection disconnected."),this.sendQueue&&(this.sendQueue.stop().catch((function(e){t.logger.log(E.Error,"TransportSendQueue.stop() threw error '"+e+"'.")})),this.sendQueue=void 0),this.connectionId=void 0,this.connectionState="Disconnected",this.connectionStarted){this.connectionStarted=!1;try{this.onclose&&this.onclose(e)}catch(t){this.logger.log(E.Error,"HttpConnection.onclose("+e+") threw error '"+t+"'.")}}}else this.logger.log(E.Debug,"Call to HttpConnection.stopConnection("+e+") was ignored because the connection is already in the disconnected state.")},e.prototype.resolveUrl=function(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;if(!A.isBrowser||!window.document)throw new Error("Cannot resolve '"+e+"'.");var t=window.document.createElement("a");return t.href=e,this.logger.log(E.Information,"Normalizing '"+e+"' to '"+t.href+"'."),t.href},e.prototype.resolveNegotiateUrl=function(e){var t=e.indexOf("?"),i=e.substring(0,-1===t?e.length:t);return"/"!==i[i.length-1]&&(i+="/"),i+="negotiate",-1===(i+=-1===t?"":e.substring(t)).indexOf("negotiateVersion")&&(i+=-1===t?"?":"&",i+="negotiateVersion="+this.negotiateVersion),i},e}();var Fe=function(){function e(e){this.transport=e,this.buffer=[],this.executing=!0,this.sendBufferedData=new Me,this.transportResult=new Me,this.sendLoopPromise=this.sendLoop()}return e.prototype.send=function(e){return this.bufferData(e),this.transportResult||(this.transportResult=new Me),this.transportResult.promise},e.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},e.prototype.bufferData=function(e){if(this.buffer.length&&typeof this.buffer[0]!=typeof e)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof e);this.buffer.push(e),this.sendBufferedData.resolve()},e.prototype.sendLoop=function(){return Ie(this,void 0,void 0,(function(){var t,i,n;return He(this,(function(r){switch(r.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(r.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new Me,t=this.transportResult,this.transportResult=void 0,i="string"==typeof this.buffer[0]?this.buffer.join(""):e.concatBuffers(this.buffer),this.buffer.length=0,r.label=2;case 2:return r.trys.push([2,4,,5]),[4,this.transport.send(i)];case 3:return r.sent(),t.resolve(),[3,5];case 4:return n=r.sent(),t.reject(n),[3,5];case 5:return[3,0];case 6:return[2]}}))}))},e.concatBuffers=function(e){for(var t=e.map((function(e){return e.byteLength})).reduce((function(e,t){return e+t})),i=new Uint8Array(t),n=0,r=0,o=e;r<o.length;r++){var s=o[r];i.set(new Uint8Array(s),n),n+=s.byteLength}return i.buffer},e}(),Me=function(){function e(){var e=this;this.promise=new Promise((function(t,i){var n;return n=[t,i],e.resolver=n[0],e.rejecter=n[1],n}))}return e.prototype.resolve=function(){this.resolver()},e.prototype.reject=function(e){this.rejecter(e)},e}(),Ne=function(){function e(){this.name="json",this.version=1,this.transferFormat=fe.Text}return e.prototype.parseMessages=function(e,t){if("string"!=typeof e)throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=F.instance);for(var i=[],n=0,r=ae.parse(e);n<r.length;n++){var o=r[n],s=JSON.parse(o);if("number"!=typeof s.type)throw new Error("Invalid payload.");switch(s.type){case ie.Invocation:this.isInvocationMessage(s);break;case ie.StreamItem:this.isStreamItemMessage(s);break;case ie.Completion:this.isCompletionMessage(s);break;case ie.Ping:case ie.Close:break;default:t.log(E.Information,"Unknown message type '"+s.type+"' ignored.");continue}i.push(s)}return i},e.prototype.writeMessage=function(e){return ae.write(JSON.stringify(e))},e.prototype.isInvocationMessage=function(e){this.assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this.assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")},e.prototype.isStreamItemMessage=function(e){if(this.assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw new Error("Invalid payload for StreamItem message.")},e.prototype.isCompletionMessage=function(e){if(e.result&&e.error)throw new Error("Invalid payload for Completion message.");!e.result&&e.error&&this.assertNotEmptyString(e.error,"Invalid payload for Completion message."),this.assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")},e.prototype.assertNotEmptyString=function(e,t){if("string"!=typeof e||""===e)throw new Error(t)},e}(),qe=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},ze={trace:E.Trace,debug:E.Debug,info:E.Information,information:E.Information,warn:E.Warning,warning:E.Warning,error:E.Error,critical:E.Critical,none:E.None};var Ae=function(){function e(){}return e.prototype.configureLogging=function(e){if(z.isRequired(e,"logging"),void 0!==e.log)this.logger=e;else if("string"==typeof e){var t=function(e){var t=ze[e.toLowerCase()];if(void 0!==t)return t;throw new Error("Unknown log level: "+e)}(e);this.logger=new W(t)}else this.logger=new W(e);return this},e.prototype.withUrl=function(e,t){return z.isRequired(e,"url"),z.isNotEmpty(e,"url"),this.url=e,this.httpConnectionOptions=qe({},this.httpConnectionOptions,"object"==typeof t?t:{transport:t}),this},e.prototype.withHubProtocol=function(e){return z.isRequired(e,"protocol"),this.protocol=e,this},e.prototype.withAutomaticReconnect=function(e){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new me(e):this.reconnectPolicy=e:this.reconnectPolicy=new me,this},e.prototype.build=function(){var e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),!this.url)throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");var t=new Oe(this.url,e);return ge.create(t,this.logger||F.instance,this.protocol||new Ne,this.reconnectPolicy)},e}();!function(e,t){void 0===t&&(t={});var i=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===i&&n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}(".avw-loader {\r\n  box-sizing: border-box;\r\n  display: flex;\r\n  flex: 0 1 auto;\r\n  flex-direction: column;\r\n  flex-grow: 1;\r\n  flex-shrink: 0;\r\n  flex-basis: 25%;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n@-webkit-keyframes line-scale {\r\n  0% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n\r\n  50% {\r\n    -webkit-transform: scaley(0.4);\r\n    transform: scaley(0.4);\r\n  }\r\n\r\n  100% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n}\r\n@keyframes line-scale {\r\n  0% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n\r\n  50% {\r\n    -webkit-transform: scaley(0.4);\r\n    transform: scaley(0.4);\r\n  }\r\n\r\n  100% {\r\n    -webkit-transform: scaley(1);\r\n    transform: scaley(1);\r\n  }\r\n}\r\n\r\n.line-scale > div:nth-child(1) {\r\n  -webkit-animation: line-scale 1s 0.1s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.1s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(2) {\r\n  -webkit-animation: line-scale 1s 0.2s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.2s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(3) {\r\n  -webkit-animation: line-scale 1s 0.3s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.3s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(4) {\r\n  -webkit-animation: line-scale 1s 0.4s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.4s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div:nth-child(5) {\r\n  -webkit-animation: line-scale 1s 0.5s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n  animation: line-scale 1s 0.5s infinite cubic-bezier(0.2, 0.68, 0.18, 1.08);\r\n}\r\n.line-scale > div {\r\n  background-color: #fff;\r\n  width: 4px;\r\n  height: 35px;\r\n  border-radius: 2px;\r\n  margin: 2px;\r\n  -webkit-animation-fill-mode: both;\r\n  animation-fill-mode: both;\r\n  display: inline-block;\r\n}\r\n");class Ve{constructor(e){this._progress=.01,this._dom=document.createElement("div"),this._dom.style.position="relative",this._dom.style.width="100%",this._dom.style.height="100%",this._dom.style.backgroundColor="#000000FF",this._dom.className="avw-loader",this._loadingDom=document.createElement("div"),this._loadingDom.className="loader-inner line-scale",this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._loadingDom.appendChild(document.createElement("div")),this._dom.appendChild(this._loadingDom),this._container=e.container||document.body,this._container.insertBefore(this._dom,this._container.firstChild)}get progress(){return this._progress}set progress(e){NaN!==(e=Number(e))&&(e>=1&&(e=1),e<.01&&(e=.01),this._progress=e)}destroy(){this._container.removeChild(this._dom)}hide(){}show(){}}var Be=1e-6,$e="undefined"!=typeof Float32Array?Float32Array:Array;function Xe(){var e=new $e(16);return $e!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function We(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],p=t[9],d=t[10],f=t[11],g=t[12],y=t[13],m=t[14],b=t[15],w=i[0],v=i[1],S=i[2],k=i[3];return e[0]=w*n+v*a+S*u+k*g,e[1]=w*r+v*l+S*p+k*y,e[2]=w*o+v*c+S*d+k*m,e[3]=w*s+v*h+S*f+k*b,w=i[4],v=i[5],S=i[6],k=i[7],e[4]=w*n+v*a+S*u+k*g,e[5]=w*r+v*l+S*p+k*y,e[6]=w*o+v*c+S*d+k*m,e[7]=w*s+v*h+S*f+k*b,w=i[8],v=i[9],S=i[10],k=i[11],e[8]=w*n+v*a+S*u+k*g,e[9]=w*r+v*l+S*p+k*y,e[10]=w*o+v*c+S*d+k*m,e[11]=w*s+v*h+S*f+k*b,w=i[12],v=i[13],S=i[14],k=i[15],e[12]=w*n+v*a+S*u+k*g,e[13]=w*r+v*l+S*p+k*y,e[14]=w*o+v*c+S*d+k*m,e[15]=w*s+v*h+S*f+k*b,e}function Ye(e,t,i){var n=new $e(3);return n[0]=e,n[1]=t,n[2]=i,n}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Je,je;Je=new $e(3),$e!=Float32Array&&(Je[0]=0,Je[1]=0,Je[2]=0),je=Je;function Ue(){var e=new $e(4);return $e!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}!function(){var e=Ue()}();var Ge=[],Ze=[],Ke=[],Qe={},et={},tt=null;function it(e){for(let t=Ze.length-1;t>-1;t--)if(Ze[t].name===e)return void Ze.splice(t,1)}function nt(e){let t=e.name;for(let i=Ze.length-1;i>-1;i--)if(Ze[i].name===t)return void(Ze[i]=e)}function rt(e){let t=JSON.parse(JSON.stringify(e));if("link"===e.type){let i=[e.startPosition,e.endPosition],n=[t.startPosition,t.endPosition];for(let e=0;e<i.length;e++){let t=i[e],r=n[e];switch(r.srs=i[e].type,t.type.toLowerCase()){case"lla":case"surface":r.coords=[t.lon,t.lat,t.alt];break;case"default":default:r.coords=[t.x,t.y,t.z]}}}else{if("area"===e.type||"electricfence"===e.type||"TrafficJam"===e.type)return t;{let i=e.position||e,n=t.position||t;switch(n.srs=e.position?e.position.type:t.type,i.type.toLowerCase()){case"lla":case"surface":n.coords=[i.lon,i.lat,i.alt];break;case"default":default:n.coords=[i.x,i.y,i.z]}}}return t}var ot=100,st=400,at=!0,lt=null;const ct="_sys_layer_info_panel_",ht="_sys_layer_cluster_",ut=4194304,pt={cameramove:{default:void 0},camerazoom:{default:void 0},click:{default:void 0,byType:{landmark:void 0,building:void 0,scene:void 0}},dblclick:{default:void 0,byType:{landmark:void 0,building:void 0,scene:void 0}},mousedown:{default:void 0,byType:{landmark:void 0,building:void 0,scene:void 0}},mousehover:{default:void 0,byType:{landmark:void 0,building:void 0,scene:void 0}},mouseup:{default:void 0,byType:{landmark:void 0,building:void 0,scene:void 0}}};var dt=null,ft=null,gt=null;const yt="mousedown",mt="mouseup",bt="mouseover",wt="click",vt="dblclick",St="cameramove",kt="camerazoom";var _t=[],Tt=null,Ct=1800,Dt=!1,Et=30;class Pt{constructor(e){e?(this._appId=e.appId,this._codeRate="number"==typeof e.codeRate?e.codeRate:5e4,this.container=void 0,this._feedbackUrl=this._url=e.serverUrl?e.serverUrl:e.serveUrl,this._frameRate="number"==typeof e.frameRate?e.frameRate:30,this._groupId=e.groupId,this.isMaster="boolean"==typeof e.isMaster&&e.isMaster,this.mouseClickSceneCallback=null,this._model=e.model||0,this.name=e.name,this._network=0,this._playerMode=e.playerMode||1,this._port=e.port||8126,this._recordMenu="",this._rotateStatus=!1,this._roatatetDelayTime=0,this._roomCode=e.roomCode||"FlMcxFZc",this._status=e.status||0,this._soeLoadMaxTime=void 0!==e.soeLoadMaxTime&&"number"==typeof parseInt(e.soeLoadMaxTime)?1e3*parseInt(e.soeLoadMaxTime):18e4,this._screenSelectCallback=null,this._screenSelectFlag=!1,this._setTooltipMovementDelay="number"==typeof e.setTooltipMovementDelay?e.setTooltipMovementDelay:220,this.token="string"==typeof e.token&&e.token,this._url=this._url=e.serverUrl?e.serverUrl:e.serveUrl):console.warn("Streaming 构造失败，未提供参数。")}addArea(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="area",this.addDrawable(e,t,i)}addAreas(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="area";this.addDrawables(e,t,i)}addBar(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="bar",this.addDrawable(e,t,i)}addBars(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="bar";this.addDrawables(e,t,i)}addBubble(e,t,i){if(t)return t.type="bubble",t.layer=e,this.addDrawable(e,t,i);this.errors(i,0,"addBubble(layerName, bubbleInfo, callback) 传入参数有误。")}addBubbles(e,t,i){if(t){if(t instanceof Array)for(let i of t)i.layer=e,i.type="bubble";return this.addDrawables(e,t,i)}this.errors(i,0,"addBubble(layerName, bubbleInfo, callback) 传入参数有误。")}addCluster(e,t,i){if(t&&t.name&&t.data)return t.type="cluster",this.addDrawable(e,t,i);i?i(0,"Streaming.addLandmark(layerName, clusterInfo, callback) 传入参数有误。"):this.errors(i,0,"Streaming.addLandmarks(layerName, clusterInfos) 传入参数有误。")}addControlPanel(e){if(e.panel){this.panel=this.ctrlView.appendChild(document.createElement("div")),this.panel.setAttribute("id","ctrl-panel"),this.panel.style.position="fixed",this.panel.style.top=e.panel.top||"unset",this.panel.style.left=e.panel.left||"unset",this.panel.style.bottom=e.panel.bottom||"unset",this.panel.style.right=e.panel.right||"unset",this.panel.style.width=e.panel.width||"40px",this.panel.style.height=e.panel.height||"100px";let t=document.createElement("div");t.innerHTML=e.panel.resetContainer,t.onclick=()=>{this.selectMenu(this._recordMenu,!1)},this.panel.appendChild(t);let i=document.createElement("div");i.innerHTML=e.panel.rotateContainer,i.onclick=e=>{e.target.classList.toString().indexOf("active")>-1?e.target.className=e.target.className.split("active")[0]:e.target.className+=" active",this._rotateStatus=!this._rotateStatus,this.setCameraRotate({isStart:this._rotateStatus,speed:.1}),this.refreshPanelsPos(this._rotateStatus)},this.panel.appendChild(i)}}addDrawable(e,t,i){e&&"string"==typeof e&&""!==e||(e=n.randomString(4));let r,s=this.getLayer(e);if(s){if("Heat"===t.type)return this.errors(i,0,"Streaming.addDrawable(layerName, drawableInfo, callback) 热图已存在指定图层。");"del"===s.status&&(s.status="");let e=s._drawables;if(e[0]&&e[0].type!==t.type)return i(0,"不同类型不能添加到同一个图层内！");let n=t.type;if("bubble"===t.type){let e=s.getDrawable(t.name);e&&(t.guid=e.guid)}if("area"===n||"bar"===n||"trail"===n||"link"===n||"trailplayback"===n||"bubble"===n||"electricfence"===n||"TrafficJam"===n||"fireWorks"===n||"informationrain"===n){let i=e.length>0?e[0].guid:this.guid();t.guid=i}t.guid?t.guid:t.guid=this.guid()}else s=this.addLayer({name:e}),t.guid=this.guid();if(s.getDrawable(t.name)&&"bubble"!==t.type)return this.errors(i,0,"Streaming.addDrawable(layerName, drawableInfo, callback) 已存在指定图层和名称的绘制物。");switch(t.parent=e,t.type.toLowerCase()){case"infopanel":let e=this.getPanelContainer();r=new l(t,e),Ze.push(r);break;case"landmark":r=new o(t);break;case"bubble":r=new u(t,!1,!0);break;case"cluster":r=new p(t),Ke.push(r),Qe[t.parent+t.name]=r.viewLevel.length-1;break;case"bar":r=new f(t);break;case"link":r=new g(t);break;case"trailplayback":t.guidName=this.guid(),r=new y(t);break;case"trail":r=new m(t);break;case"area":r=new b(t);break;case"electricfence":r=new v(t);break;case"trafficjam":r=new S(t);break;case"heat":r=new k(t);break;case"fireworks":r=new _(t);break;case"fireflyeffect":r=new T(t);break;case"informationrain":r=new C(t)}if(!r)return this.errors(i,0,"Streaming.addDrawable(layerName, drawableInfo, callback) 传入参数有误。");var a=this;return this.getLayer(e).addDrawable(r,((n,o)=>{if(1===n||"bubble"===t.type)switch(r.type.toLowerCase()){case"infopanel":let t=r.infoPanel;_t=[];let n=this._getAttrEle(t,"data-close");if(n)for(let t=0;t<n.length;t++){let i=n[t];i.style.pointerEvents="auto",i.style.cursor="pointer",i.onclick=t=>{let i=this._getParentId(t.target);for(let e of Ze){let e=document.querySelectorAll("._sys_layer_info_panel_");for(let t=e.length-1;t>=0;t--)if(e[t].getAttribute("id")===i){e[t].remove(),it(i);break}}let n=a.getLayer(e).getDrawables(),r=i.split(ct)[1];for(let e=n.length-1;e>=0;e--)if(n[e].name===r)return void n.splice(e,1)}}r.exclusive&&(s._drawables=[r]),Ze.panelMove||(Ze.panelMove=a.panelMove),Ze.panelMove.bind(a)(),i&&i(1,"成功！");break;case"landmark":let o=rt(r.getRequsetParams());this.sendHttpRequest("addMarker",o,((t,n)=>{if(t){r.show?this.showLayer(e):this.hideLayer(e),i&&i(1,"成功");let t=JSON.parse(n);r.xyzPos={srs:"xyz",coords:[t.x,t.y,t.z]},r.tooltipEnabled&&r.initShowTooltip&&(r.tooltip=!0,a.initShowTipPanelLazy([r]))}else c(t,n)}));break;case"bubble":let l=[],h=a.getLayer(e)._drawables;for(let e=0;e<h.length;e++)console.log(h[e]),l.push(rt(h[e].getRequsetParams()));this.sendHttpRequest("addBubble",l,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"cluster":let u=r;this.sendHttpRequest("pickGetCameraInfo",{},((e,t)=>{if(e)try{this.setClusterDataOnMap(JSON.parse(t),u,i)}catch(i){c(e,t)}else c(e,t)}));break;case"bar":let p=[],d=a.getLayer(e)._drawables;for(let e=0;e<d.length;e++)!1!==d[e].show&&p.push(rt(d[e].getRequsetParams()));p.length>1?this.sendHttpRequest("updateHistogram",p,i):this.sendHttpRequest("addHistogram",p,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"link":let f=[],g=a.getLayer(e)._drawables;for(let e=0;e<g.length;e++)!1!==g[e].show&&f.push(rt(g[e].getRequsetParams()));f.length>1?this.sendHttpRequest("updateLink",f,i):this.sendHttpRequest("addLink",f,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"trailplayback":let y=[],m=a.getLayer(e)._drawables;for(let e=0;e<m.length;e++)!1!==m[e].show&&y.push(rt(m[e].getRequsetParams()));y.length>1?this.sendHttpRequest("updateHistory",y,i):this.sendHttpRequest("addHistory",y,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"trail":let b=[],w=a.getLayer(e)._drawables;for(let e=0;e<w.length;e++)!1!==w[e].show&&b.push(rt(w[e].getRequsetParams()));let v="";v=b.length>1?"updatePlayback":"addPlayback",this.sendHttpRequest(v,b,((e,t)=>{if(e){t=JSON.parse(t);let n=[];for(let e=0;e<t.length;e++){let i=w[e],r=t[e];i.xyzPos={srs:"xyz",coords:[r.x,r.y,r.z]},i.tooltipEnabled&&i.initShowTooltip&&!i.tooltip&&(n.push(i),i.tooltip=!0)}n.length&&a.initShowTipPanelLazy(n),i&&i(e,"成功！")}else"addPlayback"===v&&c(e,t)}));break;case"area":let S=[],k=a.getLayer(e)._drawables;for(let e=0;e<k.length;e++)!1!==k[e].show&&S.push(k[e].getRequsetParams());S.length>1?this.sendHttpRequest("updateRange",S,i):this.sendHttpRequest("addRange",S,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"electricfence":let _=[],T=a.getLayer(e)._drawables;for(let e=0;e<T.length;e++)!1!==T[e].show&&_.push(T[e].getRequsetParams());_.length>1?this.sendHttpRequest("updateElectricFence",_,((e,t)=>{e?i&&i(e,t):c(e,t)})):this.sendHttpRequest("addElectricFence",_,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"trafficjam":let C=[],D=a.getLayer(e)._drawables;for(let e=0;e<D.length;e++)!1!==D[e].show&&C.push(D[e].getRequsetParams());C.length>1?this.sendHttpRequest("updateTrafficJam",C,((e,t)=>{e?i&&i(e,t):c(e,t)})):this.sendHttpRequest("addTrafficJam",C,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"heat":a.getLayer(e)._drawables;let E=r.getRequsetParams();this.sendHttpRequest("addHeatMap",E,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"fireworks":let P=[],x=a.getLayer(e)._drawables;for(let e=0;e<x.length;e++)!1!==x[e].show&&P.push(x[e].getRequsetParams());this.sendHttpRequest("addFireWorksEffect",P[0],((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"fireflyeffect":let R=r.getRequsetParams();this.sendHttpRequest("addFireflyEffect",R,((e,t)=>{e?i&&i(e,t):c(e,t)}));break;case"informationrain":let L=r.getRequsetParams();this.sendHttpRequest("addInformationRainEffect",L,((e,t)=>{e?i&&i(e,t):c(e,t)}))}else i&&i(0,o)})),r;function c(t,n){i?i(t,n):console.warn(n),a.getLayer(e).removeDrawable(r.name)}}addHeatLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="Heat",this.addDrawable(e,t,i)}addInfoPanel(e,t){if(e)return e.exclusive&&this.getLayer(ct)&&this.getLayer(ct).clearDrawables(),e.type="infopanel",this.addDrawable(ct,e,t);this.errors(t,0,"Streaming.addInfoPanel(infoPanelInfo, callback) 传入参数有误。")}addInformationRain(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="informationrain",this.addDrawable(e,t,i)}addLandmark(e,t,i){if(t)return t.type="landmark",t.layer=e,this.addDrawable(e,t,i);i?i(0,"Streaming.addLandmark(layerName, landmarkInfo, callback) 传入参数有误。"):console.warn(0,"Streaming.addLandmarks(layerName, landmarkInfos) 传入参数有误。")}addLandmarkTip(e){let t=e.type;try{if("del"===this.getLayer(e.parent).status)return}catch(e){console.log(e)}let i,n=`_sys_layer_info_panel__${e.layer}_${e.name}_${t}`;i=document.createElement("div"),i.setAttribute("id",n),i.className=ct,this.getPanelContainer().appendChild(i),i.innerHTML=e.tooltipText.substring(0,ut);let r=e;i.style=`position:absolute;margin-bottom:${-1*r.tooltipVerOffset}px; margin-left:${r.tooltipHorOffset}px;\n        width:auto; pointer-events:none; font-size:${r.tooltipFontSize}px; height:auto; background:${r.tooltipBackground};\n        color:${r.tooltipForeground}; font-weight:${r.tooltipFontBold}; font-style:${r.tooltipFontItalic};\n        border:${r.tooltipBackgroundBorderThickness}px solid ${r.tooltipBackgroundBorderColor};\n        box-shadow:${r.tooltipShadowEnabled?"2px 3px 2px "+r.tooltipBackground+" ;":"none;"};buttom:-9999px;left:-9999px`,e.tooltip=!0,Ze.push(r),_t=[];let o=this._getAttrEle(i,"data-close");for(let t=0;t<o.length;t++){let i=o[t];i&&(i.style.pointerEvents="auto",i.style.cursor="pointer",i.onclick=t=>{this._closeButEvent(i,this,e);let n=this.getLayer(e.parent)._drawables;for(let t=0;t<n.length;t++)n[t].name===e.name&&(n[t].tooltip=!1)})}Ze.panelMove||(Ze.panelMove=this.panelMove),this.requsetPosSetPanel(e.xyzPos,i)}addLandmarkTip_new(e){let t=[];if(e){try{let t=this.getLayer(e[0].parent);if(0===e.length||"del"===t.status||!1===t.show)return}catch(e){console.log(e)}for(let i=0;i<e.length;i++){let n,r=e[i],o=r.type,s=`_sys_layer_info_panel__${r.layer}_${r.name}_${o}`;n=document.createElement("div"),n.setAttribute("id",s),n.className=ct,this.getPanelContainer().appendChild(n),n.innerHTML=r.tooltipText.substring(0,ut);let a=r;n.style=`position:absolute;margin-bottom:${-1*a.tooltipVerOffset}px; margin-left:${a.tooltipHorOffset}px;\n          width:auto; pointer-events:none; font-size:${a.tooltipFontSize}px; height:auto; background:${a.tooltipBackground};\n          color:${a.tooltipForeground}; font-weight:${a.tooltipFontBold}; font-style:${a.tooltipFontItalic};\n          border:${a.tooltipBackgroundBorderThickness}px solid ${a.tooltipBackgroundBorderColor};\n          box-shadow:${a.tooltipShadowEnabled?"2px 3px 2px "+a.tooltipBackground+" ;":"none;"};buttom:-9999px;left:-9999px`,r.tooltip=!0,Ze.push(a),_t=[];let l=this._getAttrEle(n,"data-close");for(let e=0;e<l.length;e++){let t=l[e];t&&(t.style.pointerEvents="auto",t.style.cursor="pointer",t.onclick=e=>{this._closeButEvent(t,this,r);let i=this.getLayer(r.parent)._drawables;for(let e=0;e<i.length;e++)i[e].name===r.name&&(i[e].tooltip=!1)})}Ze.panelMove||(Ze.panelMove=this.panelMove),t.push([r,n])}this.changeArrayPanelsPos(t)}}addLandmarks(e,t,i){if(t&&t[0].icon){if(t instanceof Array){for(let i of t)i.type="landmark",i.layer=e;this.addDrawables(e,t,i)}}else console.warn(0,"Streaming.addLandmarks(layerName, landmarkInfos) 传入参数有误。")}addLayer(e,t){return e.name&&""!==e.name||(e.name=n.randomString(8)),this.getLayer(e.name)?(t(0,`已存在同名图层（${e.name}) 。`),this):(Ge.push(new r(e,t)),this)}addMarker(e,t){var i=new Marker(e);this.sendHttpRequest("addMarker",i,t)}addMarkers(e,t){var i=[];for(const t of e){var n=new Marker(t);i.push(n)}this.sendHttpRequest("addMarkers",i,t)}addODLine(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="link",this.addDrawable(e,t,i)}addODLines(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="link";this.addDrawables(e,t,i)}addSoeSelfModelInfo(e,t,i,n){if("string"!=typeof i)return console.warn("type类型有误！");for(let n of t)n.type=i,n.layer=e;let r=this.getLayer(e);r||(r=this.addLayer({name:e})),this.getLayer(e).addDrawables(t,((e,i)=>{if(e){let e=[];for(let i of t)i.tooltipEnabled&&i.initShowTooltip&&e.push(i);e.length&&this.initShowTipPanelLazy(e),n&&n(1,"添加成功！")}else this.errors(0,"添加失败！")}))}addTrafficJam(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="TrafficJam",this.addDrawable(e,t,i)}addTrafficJams(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="TrafficJam";this.addDrawables(e,t,i)}addTrail(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="trail",this.addDrawable(e,t,i)}addTrailPlayback(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length){for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="trailplayback";this.addDrawables(e,t,i)}else t.layer=e,t.type="trailplayback",this.addDrawable(e,t,i)}addTrails(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="trail";this.addDrawables(e,t,i)}applyRainEffect(e){this.sendHttpRequest("applyRainEffect",{},e)}applySnowEffect(e){this.sendHttpRequest("applySnowEffect",{},e)}addDrawables(e,t,r){e&&"string"==typeof e&&""!==e||(e=n.randomString(4));let s=this.getLayer(e);if(s){"del"===s.status&&(s.status="");let e=s._drawables;if(e[0]&&e[0].type!==t[0].type)return r(0,"不同类型不能添加到同一个图层内！");let i=t[0].type;if("bubble"===t[0].type)for(let e=0;e<t.length;e++){let i=s.getDrawable(t[e].name);i&&(t[e].guid=i.guid)}if("area"===i||"trail"===i||"bar"===i||"link"===i||"trailplayback"===i||"bubble"===i||"electricfence"===i||"TrafficJam"===i){let i=e.length>0?e[0].guid:this.guid();for(let e=0;e<t.length;e++)t[e].guid=i}}else{s=this.addLayer({name:e});let i=this.guid();for(const e of t)"landmark"!==e.type&&(e.guid=i)}for(let e=0;e<t.length;e++){let i=t[e];if(s.getDrawable(i.name)&&"bubble"!==i.type)return this.errors(r,0,"Streaming.addDrawables(layerName, drawableInfos, callback) 已存在指定图层和名称的绘制物。")}for(const i of t)"landmark"===i.type&&(i.guid=this.guid()),i.parent=e;let a=[];switch(t[0].type.toLowerCase()){case"infopanel":_drawable=new l(drawableInfo);break;case"landmark":for(let e=0;e<t.length;e++)a[e]=new o(t[e]);break;case"bubble":for(let e=0;e<t.length;e++)a[e]=new u(t[e],!1,!0);break;case"bar":for(let e=0;e<t.length;e++)a[e]=new f(t[e]);break;case"link":for(let e=0;e<t.length;e++)a[e]=new g(t[e]);break;case"trailplayback":for(let e=0;e<t.length;e++)t[e].guidName=this.guid(),a[e]=new y(t[e]);break;case"trail":for(let e=0;e<t.length;e++)a[e]=new m(t[e]);break;case"area":for(let e=0;e<t.length;e++)a[e]=new b(t[e]);break;case"electricfence":for(let e=0;e<t.length;e++)a[e]=new v(t[e]);break;case"trafficjam":for(let e=0;e<t.length;e++)a[e]=new S(t[e])}if(0===!a.length)return this.errors(r,0,"Streaming.addDrawables(layerName, drawableInfos, callback) 传入参数有误。");var c=this;let h=this.getPanelContainer();return this.getLayer(e).addDrawables(a,((n,o)=>{if(1===n)switch(a[0].type.toLowerCase()){case"infopanel":let n=document.createElement("div");if(n.setAttribute("id","_sys_layer_info_panel__"+drawableInfo.name),n.className=ct,n.innerHTML=drawableInfo.content.substring(0,ut),n.style=`position: absolute; overflow: auto; \n                                width: ${drawableInfo.width}px; \n                                height: ${drawableInfo.height}${"auto"===drawableInfo.height?"":"px"}; \n                                left: ${ot-drawableInfo.width/2}px; \n                                top: ${st-drawableInfo.height}px; `,drawableInfo.exclusive)for(let e=h.childNodes.length-1;e>=0;e--)h.childNodes[e].className===ct&&(h.removeChild(h.childNodes[e]),Ze.splice(i,1));if(this.getPanelContainer().appendChild(n),Ze.push(drawableInfo),!Ze.movePanel)return;break;case"landmark":let o=[],s=null;for(let e=0;e<a.length;e++){let t=rt(a[e].getRequsetParams());s=a[e].show,o.push(t)}this.sendHttpRequest("addMarkers",o,((t,i)=>{if(t){s?this.showLayer(e):this.hideLayer(e),i=JSON.parse(i);let n=[];for(let e=0;e<a.length;e++){let t=a[e],r=i[e];t.xyzPos={srs:"xyz",coords:[r.x,r.y,r.z]},t.tooltipEnabled&&t.initShowTooltip&&!t.tooltip&&(n.push(t),t.tooltip=!0)}n.length&&this.initShowTipPanelLazy(n),r&&r(t,"成功！")}else p(t,i)}));break;case"bubble":let l=[],u=c.getLayer(e)._drawables;for(let e=0;e<u.length;e++)!1!==u[e].show&&l.push(u[e].getRequsetParams());this.sendHttpRequest("addBubble",l,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"bar":let d=[],f=c.getLayer(e)._drawables;for(let e=0;e<f.length;e++){if(!1===f[e].show)continue;let t=rt(f[e].getRequsetParams());d.push(t)}d.length>t.length?this.sendHttpRequest("updateHistogram",d,r):this.sendHttpRequest("addHistogram",d,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"link":let g=[],y=c.getLayer(e)._drawables;for(let e=0;e<y.length;e++){if(!1===y[e].show)continue;let t=rt(y[e].getRequsetParams());g.push(t)}g.length>t.length?this.sendHttpRequest("updateLink",g,r):this.sendHttpRequest("addLink",g,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"trailplayback":let m=[],b=c.getLayer(e)._drawables;for(let e=0;e<b.length;e++)!1!==b[e].show&&m.push(rt(b[e].getRequsetParams()));m.length>t.length?this.sendHttpRequest("updateHistory",m,r):this.sendHttpRequest("addHistory",m,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"trail":let w=[],v=c.getLayer(e)._drawables;for(let e=0;e<v.length;e++){if(!1===v[e].show)continue;let t=rt(v[e].getRequsetParams());w.push(t)}let S="";S=w.length>t.length?"updatePlayback":"addPlayback",this.sendHttpRequest(S,w,((e,t)=>{if(e){t=JSON.parse(t);let i=[];for(let e=0;e<a.length;e++){let n=a[e],r=t[e];n.xyzPos={srs:"xyz",coords:[r.x,r.y,r.z]},n.tooltipEnabled&&n.initShowTooltip&&!n.tooltip&&(i.push(n),n.tooltip=!0)}i.length&&this.initShowTipPanelLazy(i),r&&r(e,"成功！")}else"addPlayback"===S?p(e,t):c.errors(r,e,t)}));break;case"area":let k=[],_=c.getLayer(e)._drawables;for(let e=0;e<_.length;e++){if(!1===_[e].show)continue;let t=_[e].getRequsetParams();k.push(t)}_.length>t.length?this.sendHttpRequest("updateRange",k,r):this.sendHttpRequest("addRange",k,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"electricfence":let T=[],C=c.getLayer(e)._drawables;for(let e=0;e<C.length;e++){if(!1===C[e].show)continue;let t=C[e].getRequsetParams();T.push(t)}C.length>t.length?this.sendHttpRequest("updateElectricFence",T,r):this.sendHttpRequest("addElectricFence",T,((e,t)=>{e?r&&r(e,t):p(e,t)}));break;case"trafficjam":let D=[],E=c.getLayer(e)._drawables;for(let e=0;e<E.length;e++){if(!1===E[e].show)continue;let t=E[e].getRequsetParams();D.push(t)}E.length>t.length?this.sendHttpRequest("updateTrafficJam",D,r):this.sendHttpRequest("addTrafficJam",D,((e,t)=>{e?r&&r(e,t):p(e,t)}))}else c.errors(r,0,o)})),a;function p(t,i){r?r(t,i):console.warn(i);for(let t of a)c.getLayer(e).removeDrawable(t.name)}}addElectricFence(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="electricfence",this.addDrawable(e,t,i)}addElectricFences(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");for(let i=0;i<t.length;i++)t[i].layer=e,t[i].type="electricfence";this.addDrawables(e,t,i)}addFireWorks(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="fireWorks",this.addDrawable(e,t,i)}addFireflyEffect(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="fireflyeffect",this.addDrawable(e,t,i)}addHeatLayerData(e,t,i){let n=this.getLayer(e)._drawables[0].guid,r=[];for(let e=0;e<t.length;e++)r.push({LayerID:n,X:t[e].points.x,Y:t[e].points.y,Count:t[e].value,ID:t[e].id});this.sendHttpRequest("updateHeatMapData",r,i)}ControlHammer(){var e=new Hammer.Manager(ctrlView),t=new Hammer.Pan({pointers:1}),i=new Hammer.Pinch;t.recognizeWith(i);var n={panValueX:0,panValueY:0,panOffsetX:0,panOffsetY:0,panSize:3,orbitValueX:0,orbitValueY:0,orbitOffsetX:0,orbitOffsetY:0,orbitSize:2,zoomValue:0,zoomOffset:0,zoomSize:2,deltaTimeValue:5e3};e.add([t,i]),e.on("hammer.input",(e=>(console.log("触发hammer.input",e),1===e.pointers.length?(console.log("单指平移，场景平移"),e.deltaTime<n.deltaTimeValue&&(n.panValueX=e.center.x,n.panValueY=e.center.y),n.panOffsetX=e.center.x-n.panValueX,n.panOffsetY=e.center.y-n.panValueY,(0!==n.panOffsetX||0!==n.panOffsetY)&&n.panOffsetX<30&&n.panOffsetY<30&&this.mouseAndPanelMove("pan",n.panOffsetX*n.panSize,n.panOffsetY*n.panSize),n.panValueX=e.center.x,n.panValueY=e.center.y,void(n.deltaTimeValue=e.deltaTime)):2===e.pointers.length?(console.log("两指缩放，场景缩放（zoom）"),e.deltaTime<n.deltaTimeValue&&(n.zoomValue=e.scale),n.zoomOffset=e.scale-n.zoomValue,0!==n.zoomOffset&&n.zoomOffset<30&&this.mouseAndPanelMove("pushPull",0,n.zoomOffset>0?n.zoomSize:0-n.zoomSize),n.zoomValue=e.scale,void(n.deltaTimeValue=e.deltaTime)):3===e.pointers.length?(console.log("多指平移，场景旋转（orbit），与缩放一同处理"),(e.deltaTime<=50||e.deltaTime<n.deltaTimeValue)&&(n.orbitValueX=e.center.x,n.orbitValueY=e.center.y),n.orbitOffsetX=e.center.x-n.orbitValueX,n.orbitOffsetY=e.center.y-n.orbitValueY,(0!==n.orbitOffsetX||0!==n.orbitOffsetY)&&n.orbitOffsetX<30&&n.orbitOffsetY<30&&this.mouseAndPanelMove("orbit",n.orbitOffsetX*n.orbitSize,n.orbitOffsetY*n.orbitSize),n.orbitValueX=e.center.x,n.orbitValueY=e.center.y,void(n.deltaTimeValue=e.deltaTime)):void 0)))}ControlLandmarkTooltip(e,t){let i=this;this.throttle(40,(function(){let t=e.offsetX/et.width,n=e.offsetY/et.height;i.pick(t,n,((t,n)=>{let r=JSON.parse(n);var o;r.length&&(o=r[r.length-1],i.sendHttpRequest("pickGetEntityName",{name:o},((t,n)=>{if(1===t){let t=JSON.parse(n).guid,r=i.getLayers();for(let n of r){let r=n.getDrawables();for(let n=r.length-1;n>=0;n--){let o=r[n],s=null;if(s="trail"===o.type?o.guid+"_"+o.name:o.guid,o&&s===t&&"landmark"===o.type&&gt&&gt(o),o&&s===t&&o.tooltipEnabled&&!o.tooltip)return void("click"===o.tooltipTriggerEvent&&"mouseup"===e.type?i.addLandmarkTip(o):"hover"===o.tooltipTriggerEvent&&e.type)}}}})))}))}))}calcScrennScale(){let e=this.getPanelContainer();this.sendHttpRequest("pickGetScreenResolution",{},((t,i)=>{t&&(console.log("获取soe分辨率："+i),i=JSON.parse(i),et={height:parseInt(e.style.height)/(i.height||1080),width:parseInt(e.style.width)/(i.width||1920)})}))}_closeButEvent(e,t,i,n){let r=t._getParentId(e);for(let e of Ze){let e=document.querySelectorAll("._sys_layer_info_panel_");for(let t=e.length-1;t>=0;t--)if(e[t].getAttribute("id")===r){e[t].remove(),it(i.name);break}}}changeArrayPanelsPos(e){let t=this.getPanelContainer(),i=[];for(let t=0;t<e.length;t++)i.push({position:e[t][0].xyzPos});this.sendHttpRequest("pickGetPosition2DList",i,((i,n)=>{if(1===i){let i=this.getLayer(e[0][0].parent);if(0===e.length||"del"===i.status||!1===i.show)return;let r=JSON.parse(n);for(let i=0;i<r.length;i++){let n=this.setInfopanelPos(e[i][1],t,JSON.stringify(r[i]));e[i][1].style.bottom=n.y,e[i][1].style.left=n.x}}}))}changePositon(e){switch(e.srs=e.type,e.type.toLowerCase()){case"lla":case"surface":e.coords=[e.lon,e.lat,e.alt];break;case"default":default:e.coords=[e.x,e.y,e.z]}return e}clearAllDomPanel(){let e=this.getLayers();for(let t=0;t<e.length;t++){let i=e[t].getDrawables();for(let e=0;e<i.length;e++){let t=i[e];if(t.tooltip){let e=`_sys_layer_info_panel__${t.name}_${t.name}_${t.type}`;document.getElementById(e)&&document.getElementById(e).remove(),t.tooltip=!1,it(t.name)}}}let t=document.querySelectorAll("._sys_layer_info_panel_");for(let e=t.length-1;e>=0;e--)t[e].remove();Ze=[]}clearAllLayer(e){this.clearAllDomPanel(),Ge=[],Ke=[],this.sendHttpRequest("resetAll",{},e)}clearInfoPanels(e){let t=this.getPanelContainer();this.getLayer(ct)&&this.getLayer(ct).clearDrawables((function(i,n){if(1===i){for(let e=t.childNodes.length-1;e>=0;e--)t.childNodes[e].className===ct&&t.removeChild(t.childNodes[e]);e&&e(1,"成功。")}else e&&e(0,n)})),e&&e(1,"成功")}closeAllTooltip(e){try{for(let e of Ze)if(e.tooltipEnabled&&e.tooltip){e.tooltip=!1;let t=document.getElementById(`_sys_layer_info_panel__${e.layer}_${e.name}_${e.type}`);t&&t.remove()}Ze=[],e&&e(1,"清除图层成功！")}catch(t){this.errors(e,0,"清除图层失败："+t)}}cluseterContorler(){Ke.length&&this.sendHttpRequest("pickGetCameraInfo",{},((e,t)=>{if(e){let e=JSON.parse(t);for(let t=0;t<Ke.length;t++){if(!1===Ke[t].show)return;let i=Ke[t].getCurViewLevel(e.distance||e.viewDistance);if(Qe[Ke[t].parent+Ke[t].name]===i&&i!==Ke[t].viewLevel.length-1)return;let n=ht+Ke[t].name;this.getLayer(n)?(console.log("删除——————————————!"),this.removeDrawableLayer(n,"landmark",((i,r)=>{if(i){0===this.getLayer(n)._drawables.length&&this.setClusterDataOnMap(e,Ke[t])}}))):this.setClusterDataOnMap(e,Ke[t])}}else this.errors(callback,e,t)}))}controlSOEStatus(){setTimeout((()=>{0===this.SOEStatus&&(this.sendSOEServerStatus(0,(()=>{this.destroy((()=>{alert("SOE服务启动失败！")}))})),this.SOEStatus=2),this.isMaster&&this._progressBar.destroy(),console.log("请求结束获取SOE状态！",this.SOEStatus)}),this.SOETestTime),this.getSOEStatus()}creartCanvas(){let e=this.container;var t=document.createElement("canvas");t.setAttribute("id","canvasDom"),t.style.zIndex=1,t.style.position="fixed",t.width=parseInt(this.ctrlView.style.width),t.height=parseInt(this.ctrlView.style.height);var i=t.getContext("2d");let n,r,o,s;i.fillStyle="rgba(0,0,0,0.6)",i.strokeStyle="green",e.appendChild(t),this.canvasDom=t,this.clipCtx=i,this.canvasDown=!1,this._screenSelectStartX=0,this._screenSelectStartY=0,this._screenSelectEndX=0,this._screenSelectEndY=0,this._screenSelectMovingX,this._screenSelectMovingY,t.onmousedown=e=>{this.canvasDown=!0,this._screenSelectStartX=o=e.offsetX,this._screenSelectStartY=s=e.offsetY,n=e.offsetX,r=e.offsetY,1===e.button&&e.preventDefault()},t.onmousemove=e=>{if(this.canvasDown){let t="orbit";switch(e.button){case 0:t="pan";break;case 1:t="orbit";break;case 2:t="pushPull"}this._screenSelectFlag&&"pan"===t&&(this._screenSelectMovingX=e.offsetX,this._screenSelectMovingY=e.offsetY,this.drawingCanvas()),o=e.offsetX,s=e.offsetY}},t.onmouseup=e=>{if(this._screenSelectFlag){0===e.button&&(this._screenSelectEndX=e.offsetX,this._screenSelectEndY=e.offsetY);let t=parseInt(this.ctrlView.style.height);this.getScreenLandmark({startPosition:{x:this._screenSelectStartX/et.width,y:(t-this._screenSelectStartY)/et.height},endPosition:{x:this._screenSelectEndX/et.width,y:(t-this._screenSelectEndY)/et.height}},this._screenSelectCallback),this.canvasDown=!1,o=0,s=0}}}drawingCanvas(){let e=this._screenSelectMovingX-this._screenSelectStartX,t=this._screenSelectMovingY-this._screenSelectStartY,i=this._screenSelectStartX,n=this._screenSelectStartY;this.clipCtx.clearRect(0,0,this.canvasDom.width,this.canvasDom.height),this.clipCtx.beginPath(),this.clipCtx.fillRect(i,n,e,t),this.clipCtx.fillStyle="rgba(0,0,0,0.2)",this.clipCtx.strokeStyle="white",this.clipCtx.lineWidth=3,this.clipCtx.moveTo(i,n),this.clipCtx.lineTo(i+e,n),this.clipCtx.lineTo(i+e,n+t),this.clipCtx.lineTo(i,n+t),this.clipCtx.lineTo(i,n),this.clipCtx.stroke(),this.clipCtx.closePath()}debounce(e,t){return function(){null!==lt&&clearInterval(lt),lt=setInterval((()=>{t(),lt=null}),e)}}destroy(e){if(this.options&&this.options.container&&this.options.container.children){for(let e=this.options.container.children.length-1;e>=0;e--)this.options.container.removeChild(this.options.container.children[e]);this.options=null,this.clearAllLayer(),this._feedbackUrl="",this.serverSocket&&this.serverSocket.stop(),e&&e(1)}}electricStreamline(e,t){let i={category:e.name,groupName:e.groupName,UVS:e.uvs||.2,width:e.width||1};this.sendHttpRequest("updateElectricStreamline",i,t)}errors(e,t,i){e?e(t,i):console.warn({status:t,mess:i})}flyRoam(e,t){try{let i=this,n=0;this.refreshPanelsPos(!0),e.map((async e=>{let r={position:{srs:e.type||"xyz",coords:e.center},duration:e.duration||3,distance:e.distance};setTimeout((()=>{i.sendHttpRequest("setCameraZoomToByPosition",r,((n,r)=>{n?console.log(e):i.errors(t)}))}),n),n+=e.duration?1e3*e.duration:3e3})),setTimeout((()=>{this.refreshPanelsPos(!1)}),n)}catch(e){this.errors(t)}}flyTo(e,t){let i={position:{srs:e.type||"xyz",coords:e.center},duration:e.duration,distance:e.distance};this.sendHttpRequest("setCameraZoomToByPosition",i,t),this.refreshPanelsPos(!0),setTimeout((()=>{this.refreshPanelsPos(!1)}),1e3*e.duration)}flytoDetail(e,t){e.cameraName=e.cameraName||"Default",e.position=this.changePositon(e.position),e.target=this.changePositon(e.target),e.viewDistance=e.viewDistance||500,e.azimuth=e.azimuth||45,e.inclination=e.inclination||-35,e.far=e.far||3e3,e.near=e.near||10,e.maxViewDistance=e.maxViewDistance||1e3,e.minViewDistance=e.minViewDistance||100,e.fieldOfView=e.fieldOfView||20,e.maxInclination=e.maxInclination||90,e.minInclination=e.minInclination||-90,e.duration="number"==typeof e.duration?e.duration:2,this.sendHttpRequest("applyCameraByDetails",e,t),this.panelPosControl(2e3)}getCameraInfo(e){this.sendHttpRequest("pickGetCameraInfo",{},((t,i)=>{if(t)try{e&&e(t,JSON.parse(i))}catch(n){e&&e(t,i)}else e&&e(t,i)}))}getCameraList(e){this.sendHttpRequest("pickGetCameraNameList",{},e)}getLayers(){return Ge}getLayer(e){if(Ge instanceof Array)for(let t of Ge)if(t.name===e)return t}getDrawables(){return Ge}getDrawable(e,t){return this.getLayer(e)?this.getLayer(e).getDrawable(t):void 0}getGlMatrixVal(e,t){e.position[0]===e.target[0]&&e.position[2]==e.target[2]&&(e.target[2]=e.target[2]+10);let i=Ye(e.position[0],e.position[1],e.position[2]),n=Ye(e.target[0],e.target[1],e.target[2]),r=Ye(0,1,0),o=Xe(),s=function(e,t,i,n){var r=new $e(4);return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r}(t[0],0,t[1],1),a=Xe(),l=Xe(),c=Xe(),h=parseInt(this.ctrlView.style.width)/parseInt(this.ctrlView.style.height),u=parseInt(this.ctrlView.style.width),p=parseInt(this.ctrlView.style.height),d=e.near,f=e.far;!function(e,t,i){var n,r,o,s,a,l,c,h,u,p,d,f,g=i[0],y=i[1],m=i[2];t===e?(e[12]=t[0]*g+t[4]*y+t[8]*m+t[12],e[13]=t[1]*g+t[5]*y+t[9]*m+t[13],e[14]=t[2]*g+t[6]*y+t[10]*m+t[14],e[15]=t[3]*g+t[7]*y+t[11]*m+t[15]):(n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],p=t[9],d=t[10],f=t[11],e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=c,e[7]=h,e[8]=u,e[9]=p,e[10]=d,e[11]=f,e[12]=n*g+a*y+u*m+t[12],e[13]=r*g+l*y+p*m+t[13],e[14]=o*g+c*y+d*m+t[14],e[15]=s*g+h*y+f*m+t[15])}(a,a,s),function(e,t,i,n){var r,o,s,a,l,c,h,u,p,d,f=t[0],g=t[1],y=t[2],m=n[0],b=n[1],w=n[2],v=i[0],S=i[1],k=i[2];Math.abs(f-v)<Be&&Math.abs(g-S)<Be&&Math.abs(y-k)<Be?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(h=f-v,u=g-S,p=y-k,r=b*(p*=d=1/Math.hypot(h,u,p))-w*(u*=d),o=w*(h*=d)-m*p,s=m*u-b*h,(d=Math.hypot(r,o,s))?(r*=d=1/d,o*=d,s*=d):(r=0,o=0,s=0),a=u*s-p*o,l=p*r-h*s,c=h*o-u*r,(d=Math.hypot(a,l,c))?(a*=d=1/d,l*=d,c*=d):(a=0,l=0,c=0),e[0]=r,e[1]=a,e[2]=h,e[3]=0,e[4]=o,e[5]=l,e[6]=u,e[7]=0,e[8]=s,e[9]=c,e[10]=p,e[11]=0,e[12]=-(r*f+o*g+s*y),e[13]=-(a*f+l*g+c*y),e[14]=-(h*f+u*g+p*y),e[15]=1)}(l,i,n,r),function(e,t,i,n,r){var o,s=1/Math.tan(t/2);e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(o=1/(n-r),e[10]=(r+n)*o,e[14]=2*r*n*o):(e[10]=-1,e[14]=-2*n)}(c,51,h,d,f),We(o,c,l),We(o,o,a);let g=Ue();return g[0]=o[12],g[1]=o[13],g[2]=o[14],g[3]=o[15],g[0]=g[0]/g[3],g[1]=g[1]/g[3],g[2]=g[2]/g[3],g[0]=(1+g[0])*u/2,g[1]=(1+g[1])*p/2,g}getIconUrls(e){this.sendHttpRequest("getIconUrls","",e)}getDrawables(e,t){this.sendHttpRequest("getDrawables",e,t)}getHttpRequest(e,t){const i=new XMLHttpRequest;i.onreadystatechange=function(){if(void 0!==t&&4===i.readyState&&null!==i.responseText){var e=JSON.parse(i.responseText);t(e.code,e)}},i.open("GET",this._url+e,!0),i.send()}getLandmarkParam(e){"function"==typeof e?gt=e:console.warn("参数有误！")}getPanelContainer(){return this.panelContainer?this.panelContainer:this.ctrlView}getSOEModelName(e,t){if(!ft)return;let i=e.offsetX/et.width,n=e.offsetY/et.height;this.pick(i,n,((e,t)=>{let i=JSON.parse(t),n=i[i.length-1].split("|")[0];ft(n)}))}getSOEPickGuid(e,t){if(!dt)return;let i=this,n=e.offsetX/et.width,r=e.offsetY/et.height;i.pick(n,r,((e,t)=>{let n=JSON.parse(t);n.length?i.sendHttpRequest("pickGetEntityName",{name:n[n.length-1]},((e,t)=>{if(1===e){let e=JSON.parse(t).guid;dt(e)}})):dt(n)}))}getViewConfigParams(e){_viewconfig.buildingIndex.forEach((t=>{t.id===e&&console.log(t)}))}getPanels(){let e=this.getPanelContainer(),t=[];for(let i of Ze){let n=i.xyzPos||i.position;if(!n)return;n.coords||(n.coords=[n.x,n.y,n.z]);for(let r=0;r<e.childNodes.length;r++){let o=e.childNodes[r];if(o.getAttribute&&o.getAttribute("id")==="_sys_layer_info_panel_"+i.name||o.getAttribute&&o.getAttribute("id")===`_sys_layer_info_panel__${i.layer}_${i.name}_landmark`||o.getAttribute&&o.getAttribute("id")===`_sys_layer_info_panel__${i.layer}_${i.name}_trail`||o.getAttribute&&o.getAttribute("id")===`_sys_layer_info_panel__${i.layer}_${i.name}_model`){t.push([n,o]);break}}}return t}getSOEBreak(){if(this.isMaster){(new Date).getTime();this.SOEBreakTimer=setTimeout((()=>{this.getSOEBreak(),this.getXmlHttpLog("getSceneLoaded",{},((e,t)=>{"True"===t&&(this.sendSOEReqtime=(new Date).getTime(),this.errorTimes=0)}))}),2e3)}}getXmlHttpLog(e,t,i){var n=this,r=(new Date).toLocaleString();const o=new XMLHttpRequest;o.onreadystatechange=function(){var e;void 0!==i&&4===o.readyState&&null!==o.responseText&&(""!==o.responseText?(e=JSON.parse(o.responseText),i(e.code,e.message)):i(o.responseText,o.responseText))},o.open("POST",this._feedbackUrl+e,!0),o.onerror=function(){console.log("onerror",r),n.errorTimes++,console.log(n.errorTimes),4===n.errorTimes&&(console.log("发送soe断开信息！"),n.sendSOEServerStatus(5),clearTimeout(n.SOEBreakTimer))},o.ontimeout=function(){console.log("ontimeout",r)},o.send(t)}getSOEParam(e){"function"==typeof e?dt=e:console.warn("参数有误！")}getModelName(e){"function"==typeof e?ft=e:console.warn("参数有误！")}getSOEPoss(e){let t=[];for(let i=0;i<e.length;i++){let n=e[i][0],r={};switch(r.srs=n.srs||n.type,(n.srs||n.type).toLowerCase()){case"lla":case"surface":r.coords=[n.lon,n.lat,n.alt];break;case"default":default:r.coords=[n.coords[0],n.coords[1],n.coords[2]]}t.push(r)}return[e,t]}getSOEStatus(){let e=this;setTimeout((()=>{0===e.SOEStatus&&(e.getSOEStatus(),console.log("多次请求SOE是否启动！",e.SOEStatus),this.sendHttpRequest("getSceneLoaded",{},((t,i)=>{e.isMaster&&0===e.SOENetOpen&&(e.SOENetOpen=3,this.sendSOEServerStatus(3),this._progressBar.destroy()),"True"===i&&0===e.SOEStatus&&(e.SOEStatus=1,console.log("获得SOE启动状态！",e.SOEStatus),this.sendSOEServerStatus(1),this.sendSOEReqtime=(new Date).getTime(),this.errorTimes=0,this.SOEBreakTimer=null,this.getSOEBreak())})))}),2e3)}_getDrawablesFromLayers(){var e=this.getLayers(),t=[];return e&&e.length&&e.length>0&&e.forEach((e=>{e.getDrawables().forEach((e=>{t.push(e)}))})),t}getScreenLandmark(e,t){let i=this;var n=i._getDrawablesFromLayers(),r=[];this.sendHttpRequest("pickGetEntitiesFromScreen",e,((e,o)=>{if(e){var s=JSON.parse(o);for(let e=0;e<s.length;e++)if("Scene_Root"!==s[e]){let t=i.getLayerLandmark(n,s[e]);t&&r.push(t)}t(1,r)}}))}getLayerLandmark(e,t){var i=null;return e.forEach((e=>{e.guid==t&&"landmark"==e.type&&(i=e)})),i}getXyzForLla(e,t){let i={position:{srs:"lla",coords:[e.lon,e.lat,e.alt]}};this.sendHttpRequest("getPositionByLLA",i,t)}getScenePosInformation(e,t){let i=e.flag;if("boolean"==typeof i){if(i){if("function"!=typeof e.mouseClickSceneCallback)return this.errors(t,0,"传参有误！");this.mouseClickSceneCallback=e.mouseClickSceneCallback}else this.mouseClickSceneCallback=null;t&&t(1,"成功！")}else this.errors(t,0,"传参有误！")}guid(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}_getParentId(e){let t=e.parentElement.getAttribute("id");return t&&t.indexOf(ct)>-1?t:this._getParentId(e.parentElement)}_getAttrEleSingle(e,t){for(let i=0;i<e.childNodes.length;i++)if(e.childNodes[i].getAttribute){if("popup"===e.childNodes[i].getAttribute(t)||!e.childNodes)return e.childNodes[i];{let n=this._getAttrEle(e.childNodes[i],t);if(n)return n}}return!1}_getAttrEle(e,t){for(let i=0;i<e.childNodes.length;i++)e.childNodes[i].getAttribute&&("popup"===e.childNodes[i].getAttribute(t)?_t.push(e.childNodes[i]):this._getAttrEle(e.childNodes[i],t));return _t}hideInfoPanel(e,t){if(this.getLayer(ct)){let i=ct+e;for(let e of Ze){let e=document.querySelectorAll("._sys_layer_info_panel_");for(let n=e.length-1;n>=0;n--)if(e[n].getAttribute("id")===i)return e[n].style.display="none",t(1,"隐藏成功!")}this.errors(t,0,"隐藏失败!")}}hideLayer(e,t){let i=this.getLayer(e);if(i&&i._drawables.length){i.show=!1;let n=i.getDrawables();for(let e=0;e<n.length;e++){let t=n[e];if(t.tooltip){let e=`_sys_layer_info_panel__${t.layer}_${t.name}_landmark`;document.getElementById(e)&&document.getElementById(e).remove(),it(t.name)}}this.sendHttpRequest("setMarkerLayerVisible",{layer:e,isVisible:!1},t)}else this.errors(t,0,"未找到图层或图层内绘制物")}init(e,t){var i=this;if(this.serverSocketType="",this.SOEStatus=0,this.SOENetOpen=0,this.SOETestTime=this._soeLoadMaxTime,this.ipPath=null,(e=e||{}).container||(e.container=document.body.appendChild(document.createElement("div")),i._fillWindow=!0),i.container=e.container,i.ctrlView=i.container.appendChild(document.createElement("div")),i.ctrlView.setAttribute("id","ctrlView"),i.appFrame=i.container.appendChild(document.createElement("iframe")),i.appFrame.setAttribute("id","appFrame"),e.fillWindow||i._fillWindow)i._fillWindow=!0,e.width=window.innerWidth,e.height=window.innerHeight,i.container.style.position="absolute",i.container.style.top="0px",i.container.style.right="0px",i.container.style.bottom="0px",i.container.style.left="0px",i.container.style.borderWidth="0px";else try{e.width=e.width||e.container.scrollWidth,e.height=e.height||e.container.scrollHeight}catch(e){console.log(e)}if(i.ctrlView.style.width=i.appFrame.style.width=e.width+"px",i.ctrlView.style.height=i.appFrame.style.height=e.height+"px",i.ctrlView.style.position=i.appFrame.style.position="fixed",i.ctrlView.style.zIndex=1,i.appFrame.style.border="none",e.panelContainer&&(i.panelContainer=e.panelContainer,i.panelContainer.style.width=i.appFrame.style.width=e.width+"px",i.panelContainer.style.height=i.appFrame.style.height=e.height+"px",i.panelContainer.style.position=i.appFrame.style.position="fixed",i.panelContainer.style.overflow="hidden"),i.setResolution(e.width,e.height),i._resolution||i.setResolution(1024,768),i.options=e,i.addControlPanel(e),i.controlSOETimer=null,i.SOETimer=null,this.token){"/"===this._url.slice(-1)&&(this._url=this._url.slice(0,-1));var r=this._url+"/standAlone/app/Channel/GetStreamingEnterInfo/"+this.token;"boolean"==typeof i.isMaster&&i.isMaster&&(r=r+"?isMaster="+i.isMaster,i.ctrlView.remove(),i.ctrlView=null,i._progressBar=new Ve({container:this.options.container}),i._progressBar.progress=0);const o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&null!==o.responseText){var r=JSON.parse(o.responseText);if(0===r.status){i.appFrame.src=r.data.enterUrl;let o=r.data.enterUrl.split(":");if(i._feedbackUrl=o[0]+":"+o[1]+":"+r.data.soePort+"/",n._feedbackUrl=i._feedbackUrl,i.ipPath=o[0]+":"+o[1]+":",i.calcScrennScale(),i.clearAllLayer(),t&&t(1,r.message),i.soeSocketPort=r.data.soePort,i.initServerSocket(e),e.view){let t=e.view,n={position:{srs:t.type||"xyz",coords:t.center},duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else if(e.camera){let t=e.camera,n={position:rt(t.target),duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else console.log("未设置相机，加载默认视角！")}else t&&t(0,r.message),alert(r.message)}};try{o.open("GET",r,!0),o.send()}catch(e){console.log(e),t&&t(0,"启动失败")}}else try{if(1===i._model?i._playerMode=2:0===i._model&&(i._playerMode=1),i._groupId){const e=new XMLHttpRequest;e.onload=()=>{const r=JSON.parse(e.responseText);if(1e3===r.code&&r.result)if(i._feedbackUrl="http://"+r.result.split("appServer=")[1].split("&")[0]+":"+i._port+"/",n._feedbackUrl=i._feedbackUrl,i.calcScrennScale(),i.clearAllLayer(),t&&t(1,r.message),i.appFrame){let e=r.result.replace(/frameRate=30/,"frameRate="+i._frameRate).replace(/codeRate=8000/,"codeRate="+i._codeRate);i.appFrame.src=e}else t?t(0,"Streaming.init(): Container is not available."):console.warn("Streaming.init(): Container is not available.");else t?(console.log(r.message),t(0,"Streaming.init(): Streaming Web API call failed.")):console.warn("Streaming.init(): Streaming Web API call failed.")};let r=`${i._url}/getEnterAppliURL?appliId=${i._appId}&codeRate=${i._codeRate}&frameRate=${i._frameRate}&network=${i._network}&playerMode=${i._playerMode}&userType=0&roomCode=${i._roomCode}&nickname=2`;"string"==typeof i._groupId&&i._groupId.length>1&&(r+="&groupId="+i._groupId),e.open("GET",r),e.send(null)}else{let e=`${i._url}/enterAppli?appliId=${i._appId}&codeRate=${i._codeRate}&frameRate=${i._frameRate}&network=${i._network}&playerMode=${i._playerMode}&userType=0&roomCode=${i._roomCode}&nickname=2`;i.appFrame.src=e,i._feedbackUrl=i._url.split(":")[0]+":"+i._url.split(":")[1]+":"+i._port+"/",n._feedbackUrl=i._feedbackUrl,i.calcScrennScale(),i.clearAllLayer(),t(1,"Streaming.init(): Loading succeeded.")}if(e.view){let t=e.view,n={position:{srs:"xyz",coords:t.center},duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else if(e.camera){let t=e.camera,n={position:rt(t.target),duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else console.log("未设置相机，加载默认视角！")}catch(e){t?t(0,e):console.warn("Streaming.init(): Streaming Web API call failed.",e)}if(!i.ctrlView)return;window.onbeforeunload=()=>{let e={token:this.token,isMaster:this.isMaster,state:2,type:this.serverSocketType?this.serverSocketType:""};this.sendServerSocketMess("ReportChannelState",e)};let o=!1,s=0,a=0,l=0,c=0,h=-1;const u=i.ctrlView;let p=!1;u.onmousedown=e=>{o=!0,e.target.id&&"ctrlView"===e.target.id?(h=e.button,s=e.offsetX,a=e.offsetY,l=e.offsetX,c=e.offsetY,1===e.button&&e.preventDefault()):p=!0},u.onmousemove=e=>{if(o){if(!e.target.id||"ctrlView"!==e.target.id)return;p&&(h=e.button,s=e.offsetX,a=e.offsetY,l=e.offsetX,c=e.offsetY,p=!1);let t=e.offsetX-s,n=e.offsetY-a,r="orbit";switch(h){case 0:r=d?"orbit":"pan";break;case 1:r="orbit";break;case 2:r="pushPull"}i.mouseAndPanelMove(r,t,n),s=e.offsetX,a=e.offsetY}},u.onmouseup=e=>{if(o=!1,p=!1,s=0,a=0,e.offsetX!==l||e.offsetY!==c||0!==h)i.cluseterContorler();else if(e.target.getAttribute("id")===i.ctrlView.getAttribute("id")&&i.ControlLandmarkTooltip(e,"click"),i.mouseClickSceneCallback){let t={x:e.offsetX/et.width,y:e.offsetY/et.height};i.sendHttpRequest("getMousePositionOnScene",t,((e,t)=>{"function"==typeof i.mouseClickSceneCallback?i.mouseClickSceneCallback(e,JSON.parse(t)):console.warn("参数有误！")}))}},u.onmousewheel=e=>{e.wheelDelta>0?i.mouseAndPanelMove("pushPull",0,10):i.mouseAndPanelMove("pushPull",0,-10),i.cluseterContorler(),e.preventDefault()},u.ondblclick=e=>{i.getSOEModelName(e,"dbclick"),i.getSOEPickGuid(e,"dbclick")},u.oncontextmenu=function(e){e.preventDefault()};let d=!1;return window.document.onkeydown=e=>{18===e.keyCode&&(d=!0),"\t"===String.fromCharCode(window.event?e.keyCode:e.which).toLowerCase()&&d&&(d=!1)},window.document.onkeyup=e=>{18===e.keyCode&&(d=!1)},i.ControlHammer(),i}getUrlAndToken(e){if(this._isCluster){var t=new XMLHttpRequest,i="";null!=this._groupName?i=this._url+"/Channel/StreamingInitParameter?groupName="+this._groupName:(i=this._url+"/Channel/StreamingInitParameter",this.token&&(i=i+"?token="+this.token)),t.open("GET",i,!1),t.send();var n=JSON.parse(t.responseText);return null!=n&&0==n.code?(this._url=n.data.serverUrl,this.token=n.data.token,this._feedbackUrl=this._url,!0):(null!=e&&e&&e(0,n.message),alert(n.message),!1)}return!0}initFromStreamingServer(e,t){let i=this;var r=this._url+"/standAlone/app/Channel/GetStreamingEnterInfo/"+this.token;"boolean"==typeof i.isMaster&&i.isMaster&&(r=r+"?isMaster="+i.isMaster,i.ctrlView.remove(),i.ctrlView=null,i._progressBar=new Ve({container:this.options.container}),i._progressBar.progress=0);const o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&null!==o.responseText){var r=JSON.parse(o.responseText);if(0===r.status){i.appFrame.src=r.data.enterUrl;let o=r.data.enterUrl.split(":");if(i._feedbackUrl=o[0]+":"+o[1]+":"+r.data.soePort+"/",n._feedbackUrl=i._feedbackUrl,i.ipPath=o[0]+":"+o[1]+":",i.calcScrennScale(),i.clearAllLayer(),t&&t(1,r.message),i.soeSocketPort=r.data.soePort,i.initServerSocket(e),e.view){let t=e.view,n={position:{srs:t.type||"xyz",coords:t.center},duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else if(e.camera){let t=e.camera,n={position:rt(t.target),duration:t.duration,distance:t.distance};i.sendHttpRequest("setCameraZoomToByPosition",n,((e,t)=>{console.log(e,t)}))}else console.log("未设置相机，加载默认视角！")}else t&&t(0,r.message),alert(r.message)}};try{o.open("GET",r,!0),o.send()}catch(e){console.log(e),t&&t(0,"启动失败")}}initServerSocket(e){let t=this._url.split("//")[1].split(":")[1];this.serverSocket=(new Ae).withUrl(this.ipPath+t+"/chatHub").build(),this.serverSocket.on("StopChannelVisiting",(e=>{console.log("监听到断开视频消息！");let t={token:this.token,isMaster:this.isMaster,state:2,type:this.serverSocketType?this.serverSocketType:""};this.sendServerSocketMess("ReportChannelState",t),this.destroy()})),this.serverSocket.on("ShowMessage",(e=>{alert(e.message),this.serverSocketType=e.type})),this.serverSocket.on("UpdateMasterToken",(e=>{console.log(e),this.token=e})),this.serverSocket.start().then((e=>{console.log("服务器socket连接成功！",e),this.controlSOEStatus();let t={Nodeld:"dddd",IP:"http://127.0.0.1",Token:this.token,Status:this._status,isMaster:this.isMaster};this.serverSocket.invoke("UpChannelData",t)})).catch((function(e){console.log(e)}))}initShowTipPanelLazy(e,t=!0){let i=[];if(t)Tt=setTimeout((()=>{for(let t=0;t<e.length;t++)e[t].tooltip&&i.push(e[t]);i.length&&this.addLandmarkTip_new(i)}),Ct);else{for(let t=0;t<e.length;t++){let n=document.getElementById(`_sys_layer_info_panel__${e[t].layer}_${e[t].name}_${e[t].type}`);n&&i.push([e[t],n])}this.changeArrayPanelsPos(i)}}mouseAndPanelMove(e,t,i){if(Dt)this.throttle(Et,(e=>{let t=this.getPanels(),[i,n]=this.getSOEPoss(t),r={mouseType:e.type,x:e.deltaX,y:e.deltaY};n.length>0&&(r.positions=n),this.sendHttpRequest("mouseEvent",r,((e,t)=>{if(1===e&&t){let e=JSON.parse(t);if(e)for(let t=0;t<e.length;t++){let n=this.setInfopanelPos(i[t][1],this.ctrlView,JSON.stringify(e[t]));i[t][1].style.bottom=n.y,i[t][1].style.left=n.x}}}))}),{type:e,deltaX:t,deltaY:i});else{let n=this.getPanels(),[r,o]=this.getSOEPoss(n),s={mouseType:e,x:t,y:i};o.length>0&&(s.positions=o),this.sendHttpRequest("mouseEvent",s,((e,t)=>{if(1===e&&t){let e=JSON.parse(t);setTimeout((()=>{if(e)for(let t=0;t<e.length;t++){let i=this.setInfopanelPos(r[t][1],this.ctrlView,JSON.stringify(e[t]));r[t][1].style.bottom=i.y,r[t][1].style.left=i.x}}),this._setTooltipMovementDelay)}}))}}newChangeArrayPanelsPos(e){let t=this.getPanelContainer(),i=[];for(let t=0;t<e.length;t++)i.push({position:e[t][0].xyzPos});this.sendHttpRequest("pickGetPosition2DList",i,((i,n)=>{if(1===i){let i=this.getLayer(e[0][0].parent);if(0===e.length||"del"===i.status||!1===i.show)return;let r=JSON.parse(n);for(let i=0;i<r.length;i++){let n=this.setInfopanelPos(e[i][1],t,JSON.stringify(r[i]));e[i][1].style.bottom=n.y,e[i][1].style.left=n.x;let o=`_sys_layer_info_panel__${e[i][0].layer}_${e[i][0].name}_${e[i][0].type}`,s=document.getElementById(o);s.innerHTML=e[i][0].tooltipText.substring(0,ut),_t=[];let a=this._getAttrEle(s,"data-close");for(let t=0;t<a.length;t++){let i=a[t];i&&(i.style.pointerEvents="auto",i.style.cursor="pointer",i.onclick=n=>{this._closeButEvent(i,this,e[t][0]);let r=this.getLayer(e[t][0].parent)._drawables;for(let t=0;t<r.length;t++)r[t].name===e[t][0].name&&(r[t].tooltip=!1)})}}}}))}on(e,t,i){if(e&&i)switch(e){case wt:"building"!==t.toLowerCase()&&"scene"!==t.toLowerCase()||(pt[e].byType[t]=i),"landmark"===t.toLowerCase()&&(pt[e].byType[t.toLowerCase()]=i);break;case vt:case yt:case bt:case mt:case St:case kt:_core.on(e,t,i);break;default:console.warn("注册事件处理函数参数有误。")}else console.warn("注册事件处理函数参数有误。")}orbit(e,t){this.sendHttpRequest("orbit",{x:e,y:t})}pan(e,t){this.sendHttpRequest("pan",{x:e,y:t})}pushPull(e,t){this.sendHttpRequest("pushPull",{x:e,y:t})}pick(e,t,i){this.sendHttpRequest("pick",{x:e,y:t},i)}panelPosControl(e=1500){tt&&(clearTimeout(tt),tt=null),this.refreshPanelsPos(!0),tt=setTimeout((()=>{this.refreshPanelsPos(!1)}),e)}panelMove(){let e=this.getPanelContainer();for(let t of Ze){let i=t.xyzPos||t.position;if(!i)return;for(let n=0;n<e.childNodes.length;n++){let r=e.childNodes[n];if(r.getAttribute&&r.getAttribute("id")==="_sys_layer_info_panel_"+t.name||r.getAttribute&&r.getAttribute("id")===`_sys_layer_info_panel__${t.layer}_${t.name}_landmark`||r.getAttribute&&r.getAttribute("id")===`_sys_layer_info_panel__${t.layer}_${t.name}_trail`){this.requsetPosSetPanel(i,r,t);break}}}}refreshPanelsPos(e){let t=this.getPanelContainer(),i=this.getPanels();if(e)for(let e=0;e<i.length;e++)i[e][1].style.display="none";else{let[e,n]=this.getSOEPoss(i),r=n.map((function(e){return{position:e}}));this._roatatetDelayTime?setTimeout((()=>{this.sendHttpRequest("pickGetPosition2DList",r,((r,o)=>{if(1===r){let r=JSON.parse(o);for(let i=0;i<r.length;i++){let n=this.setInfopanelPos(e[i][1],t,JSON.stringify(r[i]));e[i][1].style.bottom=n.y,e[i][1].style.left=n.x}for(let e=0;e<i.length;e++)i[e][1].style.display="block",n[e]={position:n[e]}}}))}),this._roatatetDelayTime):this.sendHttpRequest("pickGetPosition2DList",r,((r,o)=>{if(1===r){let r=JSON.parse(o);for(let i=0;i<r.length;i++){let n=this.setInfopanelPos(e[i][1],t,JSON.stringify(r[i]));e[i][1].style.bottom=n.y,e[i][1].style.left=n.x}for(let e=0;e<i.length;e++)i[e][1].style.display="block",n[e]={position:n[e]}}}))}}removeAreaLayer(e,t){this.removeDrawableLayer(e,"area",t)}removeBar(e,t,i){this.removeDrawable(e,t,i)}removeBarLayer(e,t){this.removeDrawableLayer(e,"bar",t)}removeBubble(e,t,i){return this.removeDrawable(e,t,i)}removeBubbleLayer(e,t){this.removeDrawableLayer(e,"bubble",t)}removeCluster(e,t,i){e&&t||this.errors(i,0,"图层参数或聚簇名称有误！");let n=ht+t,r=this.getLayer(n);if(!r)return this.errors(i,0,"未找到指定名称的聚簇");let o=r.getDrawables().slice(0);for(let e of o)this.removeDrawable(n,e.name);this.removeDrawable(e,t);for(let e=Ke.length-1;e>-1;e--)Ke[e].name===t&&Ke.splice(e,1)}removeDrawable(e,t,i){if(!this.getLayer(e))return void(i&&i(0,`未找到名为 ${e} 的图层。`));let n=this.getLayer(e)._drawables;for(let o=n.length-1;o>-1;o--)switch(n[o].type){case"bubble":let s,a=[];n[o].name===t?s=n.splice(o,1):a.push(rt(n[o].getRequsetParams())),this.sendHttpRequest("addBubble",a,r(n,s[0]));break;case"infopanel":n[o].name===t&&(n.splice(o,1),i&&i(1,"成功移除绘制物。"));break;case"landmark":if(n[o].name===t){let r=n[o].guid;n[o].tooltip&&document.getElementById(`_sys_layer_info_panel__${n[o].layer}_${t}_landmark`)&&(document.getElementById(`_sys_layer_info_panel__${n[o].layer}_${t}_landmark`).remove(),it(t)),n.splice(o,1);let s=[e,r];this.sendHttpRequest("removeMarker",s,i)}break;case"cluster":n[o].name===t&&n.splice(o,1);break;case"bar":let l=[];n[o].name===t?n.splice(o,1):l.push(rt(n[o].getRequsetParams())),this.sendHttpRequest("addHistogram",l,i);break;case"link":if(n[o].name===t){let e=n[o].guid;return void this.sendHttpRequest("removeLink",{layer:e},i)}break;case"trailplayback":if(n[o].name===t){let e=n[o].guid;return void this.sendHttpRequest("removeHistory",{layer:e},i)}break;case"trail":if(n[o].name===t){let e=n[o].guid;return n[o].tooltip&&document.getElementById(`_sys_layer_info_panel__${n[o].layer}_${t}_trail`)&&(document.getElementById(`_sys_layer_info_panel__${n[o].layer}_${t}_trail`).remove(),it(t)),n.splice(o,1),void this.sendHttpRequest("removePlayback",{layer:e},i)}break;case"range":if(n[o].name===t){let e=n[o].guid;return n.splice(o,1),void this.sendHttpRequest("removeRange",{layer:e},i)}break;case"fireflyeffect":if(n[o].name===t){let e=n[o].guid;return n.splice(o,1),void this.sendHttpRequest("removeFireflyEffect",{name:e},i)}break;case"informationrain":if(n[o].name===t){let e=n[o].guid;return n.splice(o,1),void this.sendHttpRequest("removeInformationRainEffect",{name:e},i)}}return this;function r(e,t){return(n,r)=>{1===n?i&&i(1,"成功移除绘制物。"):i&&(e.push(t),i(0,r))}}}removeDrawableLayer(e,t,i){let n=this.getLayer(e);if(!n)return void this.errors(i,0,"未找到"+e+"图层信息");let r=n._drawables;if(r.length<1)return void(i?i(1,"未找到绘制物"):console.warn("未找到绘制物"));if("landmark"===t||"trail"===t||"model"===t){for(let e=0;e<r.length;e++){let t=document.getElementById(`_sys_layer_info_panel__${r[e].layer}_${r[e].name}_${r[e].type}`);t&&r[e].tooltip&&(t.remove(),it(r[e].name))}if("model"===t)return n._drawables=[],void(i&&i("1","成功！"))}let o,s=n._drawables[0].guid;switch(t){case"landmark":o="removeLayer";break;case"bubble":o="removeBubble";break;case"bar":o="removeHistogram";break;case"area":o="removeRange";break;case"trail":o="removePlayback";break;case"link":o="removeLink";break;case"trailplayback":o="removeHistory";break;case"electricfence":o="removeElectricFence";break;case"TrafficJam":o="removeTrafficJam";break;case"Heat":o="removeHeatMap";break;case"fireWorks":o="removeFireWorksEffect";break;default:i&&i(0,"未找到"+t+"后端接口！")}if("landmark"===t)n._drawables=[],this.sendHttpRequest(o,{name:e},((e,t)=>{i&&i(e,t)}));else if("bubble"===t){let t=this.getLayer(e)._drawables,n=null;for(let e=t.length-1;e>-1;e--){let r=t[e].guid;n!==r&&(n=r,r&&this.sendHttpRequest("removeBubble",{name:r},i))}this.getLayer(e)._drawables=[]}else"Heat"===t?this.sendHttpRequest(o,{ID:s},((e,t)=>{e&&(n._drawables=[]),i&&i(e,t)})):"fireWorks"===t?this.sendHttpRequest(o,{name:s},((e,t)=>{e&&(n._drawables=[]),i&&i(e,t)})):(n._drawables=[],n.status="del",this.sendHttpRequest(o,{layer:s},((e,t)=>{i&&i(e,t)})))}removeLayer(e,t){let i=this.getLayer(e);if(!i)return void this.errors(t,0,"未找到"+e+"图层信息");let n=i._drawables,r=n[0].type;if(n.length<1)return void(t||console.warn("未找到绘制物"));if("landmark"===r||"trail"===r)for(let e=0;e<n.length;e++){let t=document.getElementById(`_sys_layer_info_panel__${n[e].layer}_${n[e].name}_${n[e].type}`);t&&n[e].tooltip&&(t.remove(),it(n[e].name))}let o,s=i._drawables[0].guid;switch(r){case"landmark":o="removeLayer";break;case"bubble":o="removeBubble";break;case"bar":o="removeHistogram";break;case"area":o="removeRange";break;case"trail":o="removePlayback";break;case"link":o="removeLink";break;case"trail":o="removeHistory";break;default:t&&t(0,"未找到"+r+"后端接口！")}if("landmark"===r)this.sendHttpRequest(o,{name:e},((e,n)=>{e&&(i._drawables=[]),t(e,n)}));else if("bubble"===r){let i=this.getLayer(e)._drawables,n=null;for(let e=i.length-1;e>-1;e--){let r=i[e].guid;n!==r&&(n=r,r&&this.sendHttpRequest("removeBubble",{name:r},t))}this.getLayer(e)._drawables=[]}else this.sendHttpRequest(o,{layer:s},((e,n)=>{e&&(i._drawables=[]),t(e,n)}))}removeElectricFence(e,t){this.removeDrawableLayer(e,"electricfence",t)}removeFireWorksLayer(e,t){this.removeDrawableLayer(e,"fireWorks",t)}removeFireflyEffect(e,t,i){this.removeDrawable(e,t,i)}removeHeat(e,t){this.removeDrawableLayer(e,"Heat",t)}removeInfoPanel(e,t){var i=this;let n=this.getPanelContainer();this.removeDrawable(ct,e,((r,o)=>{if(1===r){for(let t=n.childNodes.length-1;t>=0;t--)n.childNodes[t].getAttribute("id")==="_sys_layer_info_panel_"+e&&(n.removeChild(n.childNodes[t]),it(e));i.getLayer(ct).getDrawables()&&i.getLayer(ct).getDrawables().length,t&&t(1,"成功")}else this.errors(t,0,o)}))}removeInformationRain(e,t,i){this.removeDrawable(e,t,i)}removeLandmark(e,t,i){this.removeDrawable(e,t,i)}removeLandmarks(e,t){let i=this.getLayers();if(i)for(let n of i)if(n.name===e){let i=n.getDrawables();for(let n=i.length-1;n>=0;n--){let r=i[n];r&&"landmark"===r.type.toLowerCase()&&this.removeLandmark(e,r.name,t)}}}removeMarker(e,t,i){var n=[e,t];this.sendHttpRequest("removeMarker",n,i)}removeLandmarkLayer(e,t){this.removeDrawableLayer(e,"landmark",t)}removeODLine(e,t,i){this.removeDrawable(e,t,i)}removeODLineLayer(e,t){this.removeDrawableLayer(e,"link",t)}removeRainEffect(e){this.sendHttpRequest("cancelRainEffect",{},e)}removeSnowEffect(e){this.sendHttpRequest("cancelSnowEffect",{},e)}removeSoeSelModelInfo(e,t){this.removeDrawableLayer(e,"model",t)}removeTrafficJam(e,t){this.removeDrawableLayer(e,"TrafficJam",t)}removeTrail(e,t,i){this.removeDrawable(e,t,i)}removeTrailLayer(e,t){this.removeDrawableLayer(e,"trail",t)}removeTrailPlayback(e,t,i){this.removeDrawable(e,t,i)}removeTrailPlaybackLayer(e,t){this.removeDrawableLayer(e,"trailplayback",t)}requsetPosSetPanel(e,t){let i=this.getPanelContainer();this.sendHttpRequest("pickGetPosition2D",{position:e},((e,n)=>{if(1===e){let e=this.setInfopanelPos(t,i,n);t.style.bottom=e.y,t.style.left=e.x}}))}screenSelect(e,t){if(e&&this._screenSelectFlag)return console.warn("已开启绘制功能");"boolean"==typeof e?(this._screenSelectFlag=e,e?("function"==typeof t&&(this._screenSelectCallback=t),this.creartCanvas()):(this.canvasDom.remove(),this._screenSelectCallback=null,t&&t(1,"取消框选成功！"))):console.warn("参数有误！")}selectLandmark(e,t,i,n){if(!this.getLayer(e))return this.errors(n,0,"未找到地标图层！");{let r=this.getLayer(e).getDrawable(t);if(!r||"landmark"!==r.type.toLowerCase())return this.errors(n,0,"未找到地标！");i.name=r.guid,this.sendHttpRequest("pickSetAnimation",i,n)}}setVisibleLandmark(e,t){let i=this.getLayer(e.layerName);if(!i.show)return this.errors(t,0,"图层已隐藏！");if(i&&i._drawables.length){let n="",r=i.getDrawables();for(let t=0;t<r.length;t++)if(e.name===r[t].name){if(n=r[t].guid,r[t].show=e.isVisible,r[t].tooltip)if(e.isVisible);else{let e=`_sys_layer_info_panel__${r[t].layer}_${r[t].name}_landmark`;document.getElementById(e)&&document.getElementById(e).remove(),it(r[t].name)}break}this.sendHttpRequest("setMarkerVisible",{name:n,isVisible:e.isVisible},((e,i)=>{t(e,i)}))}else this.errors(t,0,"未找到图层绘制物！")}sendHttpRequest(e,t,i){const n=new XMLHttpRequest;n.onreadystatechange=function(){var e;void 0!==i&&4===n.readyState&&null!==n.responseText&&(""!==n.responseText&&(e=JSON.parse(n.responseText)),i(e.code,e.message))},n.open("POST",this._feedbackUrl+e,!0);let r="";void 0!==t&&(r=t instanceof Object?JSON.stringify(t):t),n.send(r)}sendServerSocketMess(e,t,i,n){t?this.serverSocket.invoke(e,t).then((function(e){void 0!==i&&i(1,e)})).catch((function(e){void 0!==i&&i(0,e)})):this.serverSocket.invoke(e).then((function(e){void 0!==i&&i(1,e)})).catch((function(e){void 0!==i&&i(0,e)}))}selectMenu(e=this._recordMenu,t=!1,i){Tt&&(clearTimeout(Tt),Tt=null),this._recordMenu=e,this.sendHttpRequest("selectMenu",{name:e},i),this.panelPosControl(2e3),"boolean"==typeof t&&t&&this.clearAllLayer()}setMenuViewDefault(){if(!this._recordMenu)return console.warn("菜单为："+this._recordMenu);this.selectMenu(this._recordMenu,!1)}setInfopanelPos(e,t,i){if(i=JSON.parse(i),!e)return{x:"0px",y:"0px"};if(e.initWidth)var n=e.initWidth;else(n=parseInt(!(!e.style.width||"auto"===e.style.width)&&e.style.width||e.offsetWidth))||(n=e.firstElementChild&&"number"==typeof parseInt(e.firstElementChild.style.width)?parseInt(e.firstElementChild.style.width):0),e.initWidth=n;let r=parseInt(t.style.width),o=parseInt(t.style.height);return{x:r*i.ratioX-n/2+"px",y:o-o*i.ratioY+"px"}}setRotateDelazyTime(e){"number"==typeof e?this._roatatetDelayTime=e:console.warn("setRotateDelazyTime：参数有误！")}setResolution(e,t){"number"!=typeof e||e<0||e>8192||"number"!=typeof t||t<0||t>4608||(this._resolution={width:e,height:t})}showInfoPanel(e,t){if(this.getLayer(ct)){let i=ct+e;for(let e of Ze){let e=document.querySelectorAll("._sys_layer_info_panel_");for(let n=e.length-1;n>=0;n--)if(e[n].getAttribute("id")===i)return e[n].style.display="block",t(1,"显示成功！")}t(0,"显示失败！")}}setTooltipDelay(e,t){"NaN"===parseFloat(e).toString()?t?t(0,"请传值为Number类型！"):console.warn("请传值为Number类型！"):(Ct=parseFloat(e),t&&t(1,"更改成功！"))}setVisibleDrawable(e,t,i){let n=this.getLayer(e.layerName);if(n._drawables){let o=n.getDrawable(e.name);if(!o)return void(i?i(0,"未找到绘制物！"):console.warn("未找到绘制物！"));if(o.show=e.visible,"trail"===t)if(o.tooltip&&e.visible)this.addLandmarkTip(o);else if(o.tooltip&&!e.visible){let e=`_sys_layer_info_panel__${o.layer}_${o.name}_trail`;document.getElementById(e)&&document.getElementById(e).remove()}var r=[];for(let e=0;e<n._drawables.length;e++)!1!==n._drawables[e].show&&r.push(rt(n._drawables[e].getRequsetParams()));let s;switch(t.toLowerCase()){case"bubble":r.length?s="addBubble":(s="removeBubble",r={name:o.guid});break;case"bar":r.length?s=1===r.length&&e.visible?"addHistogram":"updateHistogram":(s="removeHistogram",r={layer:o.guid});break;case"area":r.length?s=1===r.length&&e.visible?"addRange":"updateRange":(s="removeRange",r={layer:o.guid});break;case"trail":r.length?s=1===r.length&&e.visible?"addPlayback":"updatePlayback":(s="removePlayback",r={layer:o.guid});break;case"link":r.length?s=1===r.length&&e.visible?"addLink":"updateLink":(s="removeLink",r={layer:o.guid});break;case"trailplayback":r.length?s=1===r.length&&e.visible?"addHistory":"updateHistory":(s="removeHistory",r={layer:o.guid});break;case"electricfence":r.length?s=1===r.length&&e.visible?"addElectricFence":"updateElectricFence":(s="removeElectricFence",r={layer:o.guid});break;case"trafficjam":r.length?s=1===r.length&&e.visible?"addTrafficJam":"updateTrafficJam":(s="removeTrafficJam",r={layer:o.guid});break;default:i&&i(0,"未找到"+t+"后端接口！")}this.sendHttpRequest(s,r,i)}else i?i(0,"未找到绘制物！"):console.warn("未找到绘制物！")}sendSOEServerStatus(e,t){this.sendServerSocketMess("ReportChannelState",{token:this.token,isMaster:this.isMaster,state:e},t)}showLayer(e,t){let i=this.getLayer(e);if(i&&i._drawables.length){i.show=!0;let n=i.getDrawables(),r=[];for(let e=0;e<n.length;e++){let t=n[e];t.tooltip&&!document.getElementById(`_sys_layer_info_panel__${t.layer}_${t.name}_${t.type}`)&&r.push(t)}this.addLandmarkTip_new(r),this.sendHttpRequest("setMarkerLayerVisible",{layer:e,isVisible:!0},t)}else this.errors(t,0,"未找到图层或图层内绘制物")}switchDrawableTooltip(e,t,i,n,r=!1){let o=this.getLayer(e);if(r&&"number"!=typeof r)return void this.errors(n,0,"参数有误！");let s=o._drawables;if(o&&s.length){let e=o.getDrawable(t);if(i)e.tooltipEnabled&&!e.tooltip&&(r?setTimeout((()=>{this.addLandmarkTip(e)}),r):this.addLandmarkTip(e),e.tooltip=!0);else if(e.tooltipEnabled&&e.tooltip){e.tooltip=!1;let t=document.getElementById(`_sys_layer_info_panel__${e.layer}_${e.name}_${e.type}`);t&&(t.remove(),it(e.name))}n&&n(1,"成功！")}else this.errors(n,0,"未找到图层内绘制物！")}switchLayerTooltip(e,t,i){let n=this.getLayer(e),r=n._drawables;if(n&&r.length){for(let e of r)if(t)e.tooltipEnabled&&!e.tooltip&&(this.addLandmarkTip(e),e.tooltip=!0);else if(e.tooltipEnabled&&e.tooltip){e.tooltip=!1;let t=document.getElementById(`_sys_layer_info_panel__${e.layer}_${e.name}_${e.type}`);t&&(t.remove(),it(e.name))}i&&i(1,"成功！")}else this.errors(i,0,"未找到图层或图层绘制物！")}setBubbleVisible(e,t){let i=this.getLayer(e.layerName);if(i&&i._drawables.length){let n=i._drawables;e.layer=n[0].guid,e.isShowLayer=e.visible;let r=[];for(let t of n)t.show=e.visible,r.push(rt(t.getRequsetParams()));e.visible?this.sendHttpRequest("addBubble",r,t):this.sendHttpRequest("removeBubble",{name:e.layer},t)}else this.errors(t,0,"未找到图层或图层内绘制物！")}setBubbleVisibleName(e,t){this.setVisibleDrawable(e,"bubble",t)}setClusterDataOnMap(e,t,i){e.x||e.target[3],e.y||e.target[4],t.step;let n=e.distance||e.viewDistance,r=t.getCurViewLevel(n);Qe[t.parent+t.name]=r;let o=[],s=t.viewLevel[r],a=ht+t.name;if(r<t.viewLevel.length-1){for(let e in s.grids){let t=s.grids[e],i=new avw.Position("lla").set(t.centerXY.x,t.centerXY.y,200);o.push({name:e,layer:a,position:i,type:"landmark",markerType:"all",icon:t.innerData[0].icon||"Defaulet.png",labelYOffset:t.innerData[0].labelYOffset||0,labelXOffset:t.innerData[0].labelXOffset||0,labelFontSize:t.innerData[0].labelFontSize||2,iconScale:t.innerData[0].iconScale||1,textInfo:t.count,pointSize:t.innerData[0].pointSize||10,pointColor:t.innerData[0].pointColor||"#FFFFFF",pointMaxDistance:t.innerData[0].pointMaxDistance||1e5,pointMinDistance:t.innerData[0].pointMinDistance||1e4,smallIconMinDistance:t.innerData[0].smallIconMinDistance||3e3,middleIconMinDistance:t.innerData[0].middleIconMinDistance||1e3,largeIconMinDistance:t.innerData[0].largeIconMinDistance||0,farFactor:t.innerData[0].farFactor||.5,nearFactor:t.innerData[0].nearFactor||1})}if(o.length)return l.bind(this)(o)}else{Qe[t.parent+t.name]=t.viewLevel.length-1;let i=s.grids,n=[],r=parseInt(this.ctrlView.style.width)/2,a=parseInt(this.ctrlView.style.height)/2;for(let t in i){let o=i[t],s=o.centerScreen,l=this.getGlMatrixVal(e,s);l[0]=(-1*l[0]+r)*et.width,l[1]=(-1*l[1]+a)*et.height,-r<l[0]&&l[0]<r&&-a<l[1]&&l[1]<a&&(n=[...n,...o.innerData])}n.length&&function(e){o=[];for(let i in e){let n=e[i],r=ht+t.name;o.push({name:n.name+"_"+i,layer:r,icon:n.icon,position:n.position,type:"landmark",iconScale:n.iconScale||1,pointSize:n.pointSize||10,pointColor:n.pointColor||"#FFFFFF",pointMaxDistance:n.pointMaxDistance||1e5,pointMinDistance:n.pointMinDistance||1e4,smallIconMinDistance:n.smallIconMinDistance||3e3,middleIconMinDistance:n.middleIconMinDistance||1e3,largeIconMinDistance:n.largeIconMinDistance||0,farFactor:n.farFactor||.5,nearFactor:n.nearFactor||1})}o.length&&l.bind(this)(o)}.bind(this)(n)}function l(e){if(e.length>0)return this.addDrawables(a,e,i)}}setVisibleCluster(e,t){if(!e.name||void 0===e.visible)return this.errors(t,0,"传参数有误！");let i=ht+e.name;for(let t=0;t<Ke.length;t++){Ke[t].show=e.visible;break}this.sendHttpRequest("setMarkerLayerVisible",{layer:i,isVisible:e.visible},t)}setBarVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setHistogramVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setBarVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"bar",t)}setODLineVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setLinkVisible",e,t)):this.errors(t,0,"未找到图层或未找到图层内绘制物！")}setODLineVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"link",t)}setTrailPlaybackVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setHistoryVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setTrailPlaybackVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"trailplayback",t)}setTrailVisible(e,t){let i=this.getLayer(e.layerName);if(!i||!i._drawables.length)return this.errors(t,0,"未找到图层或图层绘制物！");if(e.layer=i._drawables[0].guid,e.showLayer=e.visible,i.show=i.status=e.visible,i){let t=i.getDrawables();for(let i=0;i<t.length;i++){let n=t[i];if(n.tooltip&&e.showLayer){let e=`_sys_layer_info_panel__${n.layer}_${n.name}_trail`;if(document.getElementById(e))continue;this.addLandmarkTip(n)}else if(n.tooltip&&!e.showLayer){let e=`_sys_layer_info_panel__${n.layer}_${n.name}_trail`;document.getElementById(e)&&document.getElementById(e).remove()}}}this.sendHttpRequest("setPlaybackVisible",e,t)}setTrailVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"trail",t)}setAreaVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setRangeVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setAreaVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"area",t)}setElectricFenceVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setElectricFenceVisible",e,t)):this.errors(t,0,"未找到图层"+e.layerName+"或图层内绘制物！")}setElectricFenceVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"electricfence",t)}setTrafficJamVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.layer=i._drawables[0].guid,e.isShowLayer=e.visible,i.show=e.visible,this.sendHttpRequest("setTrafficJamVisible",e,t)):this.errors(t,0,"未找到图层"+e.layerName+"或图层内绘制物！")}setTrafficJamVisibleName(e,t){let i=this.getLayer(e.layerName);if(!i)return this.errors(t,0,"未找到"+e.layerName+"图层信息！");if(!1===i.show)return this.errors(t,0,"图层已隐藏！");this.setVisibleDrawable(e,"TrafficJam",t)}setHeatVisible(e,t){let i=this.getLayer(e.layerName);if(i&&i._drawables.length)for(let n=0;n<i._drawables.length;n++){let r=i._drawables[n];r.guid=i._drawables[n].guid,r.isShow=e.visible;let o=r.getRequsetParams();this.sendHttpRequest("updateHeatMap",o,((e,i)=>{t&&t(e,i)}))}else this.errors(t,0,"未找到图层或图层内绘制物！")}setFireWorksVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.name=i._drawables[0].guid,e.isShowLayer=e.visible,e.isVisible=e.visible,this.sendHttpRequest("setFireWorksEffectVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setFireflyEffectVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.name=i._drawables[0].guid,e.isVisible=e.visible,i.show=e.visible,this.sendHttpRequest("setFireflyEffectVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setInformationRainVisible(e,t){let i=this.getLayer(e.layerName);i&&i._drawables.length?(e.name=i._drawables[0].guid,e.isVisible=e.visible,this.sendHttpRequest("setInformationRainEffectVisible",e,t)):this.errors(t,0,"未找到图层或图层内绘制物！")}setSkyBox(e,t){if(!e.name||e.enabled)return this.errors(t,0,"参数有误！");let i={Name:e.name};e.enabled?i.Name=e.name:i.Name=!1,this.sendHttpRequest("applySkySeEffect",i,t)}setCameraRotate(e,t){this._rotateStatus=e.isStart,this.refreshPanelsPos(this._rotateStatus),this.sendHttpRequest("setCameraAutoRotate",e,t)}setCameraView(e,t){this.sendHttpRequest("applyCameraByName",{Name:e},t),this.refreshPanelsPos(!0),setTimeout((()=>{this.refreshPanelsPos(!1)}),1e3)}setModelVisible(e,t){this.sendHttpRequest("setModelVisible",{layer:e.name,isVisible:e.show},t)}setModelvisable(e,t){this.setModelVisible(e,t)}setSOEObjVisible(e,t){this.sendHttpRequest("setSOEObjectVisible",{name:e.name,isVisible:e.show},t)}updateLandmark(e,t,i,n){if(i){if(i.length)for(let t=0;t<i.length;t++)i[t].type="landmark",i[t].layer=e;else i.type="landmark",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}else n?n(0,"Streaming.addLandmark(layerName, landmarkInfo, callback) 传入参数有误。"):console.warn(0,"Streaming.addLandmarks(layerName, landmarkInfos) 传入参数有误。")}updateLandmarkLayer(e,t,i){if(t){if(t.length)for(let i=0;i<t.length;i++)t[i].type="landmark",t[i].layer=e;else t.type="landmark",t.layer=e,t=[t];this.updateLayer(e,t,i)}else i?i(0,"Streaming.addLandmark(layerName, landmarkInfo, callback) 传入参数有误。"):console.warn(0,"Streaming.addLandmarks(layerName, landmarkInfos) 传入参数有误。")}updateLayer(e,t,i){try{t.length||(t=[t]);let n=this.getLayer(e);if(!n||0===n._drawables.length)return this.errors(i,0,"未找到"+e+"图层信息！");if("del"===n.status)return void console.log("图层已删除！");let r=n._drawables[0].guid,o=n._drawables[0].type;JSON.parse(JSON.stringify(n._drawables));n._drawables=[];for(let i=0;i<t.length;i++){let n=t[i];n.guid=r,n.parent=e,n.type=o}let s=[];switch(t[0].type.toLowerCase()){case"infopanel":_drawable=new l(drawableInfo);break;case"bubble":for(let e=0;e<t.length;e++)s[e]=new u(t[e],!1,!0);break;case"bar":for(let e=0;e<t.length;e++)s[e]=new f(t[e]);break;case"link":for(let e=0;e<t.length;e++)s[e]=new g(t[e]);break;case"trailplayback":for(let e=0;e<t.length;e++)t[e].guidName=this.guid(),s[e]=new y(t[e]);break;case"trail":for(let e=0;e<t.length;e++)s[e]=new m(t[e]);break;case"area":for(let e=0;e<t.length;e++)s[e]=new b(t[e]);break;case"electricfence":for(let e=0;e<t.length;e++)s[e]=new v(t[e]);break;case"trafficjam":for(let e=0;e<t.length;e++)s[e]=new S(t[e]);break;case"heat":s[0]=new k(t[0]);break;case"fireworks":s[0]=new _(t[0]);break;case"fireflyeffect":s[0]=new T(t[0]);break;case"informationrain":s[0]=new C(t[0])}this.getLayer(e).addDrawables(s,((e,n)=>{if(1===e)switch(t[0].type.toLowerCase()){case"bubble":let e=[];for(let t=0;t<s.length;t++){let i=s[t];i.guid=r;let n=rt(i.getRequsetParams());e.push(n)}this.sendHttpRequest("addBubble",e,((e,t)=>{i&&i(e,t)}));break;case"bar":let t=[];for(let e=0;e<s.length;e++){let i=s[e];i.guid=r;let n=rt(i.getRequsetParams());t.push(n)}this.sendHttpRequest("updateHistogram",t,((e,t)=>{i&&i(e,t)}));break;case"link":let n=[];for(let e=0;e<s.length;e++){let t=s[e];t.guid=r;let i=rt(t.getRequsetParams());n.push(i)}this.sendHttpRequest("updateLink",n,((e,t)=>{i&&i(e,t)}));break;case"trailplayback":let a=[];for(let e=0;e<s.length;e++){let t=s[e];t.guid=r,t.guidName=this.guid();let i=rt(t.getRequsetParams());a.push(i)}this.sendHttpRequest("updateHistory",a,((e,t)=>{i&&i(e,t)}));break;case"trail":var o=[];for(let e=0;e<s.length;e++){let t=rt(s[e].getRequsetParams());o.push(t)}this.sendHttpRequest("updatePlayback",o,((e,t)=>{if(e){i&&i(1,"成功");let e=[],n=JSON.parse(t);for(let t=0;t<n.length;t++){let i=n[t];s[t].xyzPos={srs:"xyz",coords:[i.x,i.y,i.z]};let r=document.getElementById(`_sys_layer_info_panel__${s[t].layer}_${s[t].name}_${s[t].type}`);s[t].tooltipEnabled?(nt(s[t]),e.push(s[t]),s[t].tooltip=!!r):r&&(s[t].tooltip=!1,r.remove(),it(s[t].name))}this.initShowTipPanelLazy(e,!1)}}));break;case"area":let l=[];for(let e=0;e<s.length;e++){let t=s[e];t.guid=r,l.push(t.getRequsetParams())}this.sendHttpRequest("updateRange",l,((e,t)=>{i&&i(e,t)}));break;case"electricfence":let c=[];for(let e=0;e<s.length;e++){let t=s[e];t.guid=r,c.push(t.getRequsetParams())}this.sendHttpRequest("updateElectricFence",c,((e,t)=>{i&&i(e,t)}));break;case"trafficjam":let h=[];for(let e=0;e<s.length;e++){let t=s[e];t.guid=r,h.push(t.getRequsetParams())}this.sendHttpRequest("updateTrafficJam",h,((e,t)=>{i&&i(e,t)}));break;case"heat":let u=s[0];u.guid=r;let p=u.getRequsetParams();this.sendHttpRequest("updateHeatMap",p,((e,t)=>{i&&i(e,t)}));break;case"fireworks":let d=s[0];d.guid=r;let f=d.getRequsetParams();this.sendHttpRequest("updateFireWorksEffect",f,((e,t)=>{i&&i(e,t)}));break;case"fireflyeffect":let g=s[0];g.guid=r;let y=g.getRequsetParams();this.sendHttpRequest("updateFireflyEffect",y,((e,t)=>{i&&i(e,t)}));break;case"informationrain":let m=s[0];m.guid=r;let b=m.getRequsetParams();this.sendHttpRequest("updateInformationRainEffect",b,((e,t)=>{i&&i(e,t)}))}else i?i(0,n):console.warn(n)}))}catch(e){i?i(0,"更新失败原因："+e):console.warn(0,"更新失败原因："+e)}}updateBubble(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="bubbble",i[t].layer=e;else i.type="bubble",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateBubbleLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="bubbble",t[i].layer=e;else t.type="bubble",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateBar(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="bar",i[t].layer=e;else i.type="bar",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateBarLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="bar",t[i].layer=e;else t.type="bar",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateODLine(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i.type="link",i[t].layer=e;else i.type="link",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateODLineLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t.type="link",t[i].layer=e;else t.type="link",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateTrailPlayback(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="trailplayback",i[t].layer=e;else i.type="trailplayback",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateTrailPlaybackLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="trailplayback",t[i].layer=e;else t.type="trailplayback",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateTrail(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="trail",i[t].layer=e;else i.type="trail",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateTrailLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="trail",t[i].layer=e;else t.type="trail",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateArea(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="area",i[t].layer=e;else i.type="area",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateAreaLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="area",t[i].layer=e;else t.type="area",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateDrawable(e,t,i,n){let r=this;try{let r=this.getLayer(e);if(!r)return void(n?n(0,"未找到"+t+"绘制物图层！"):console.warn("未找到"+t+"绘制物图层！"));if("del"===r.status)return void console.log("图层已删除！");let a=r.getDrawable(t);if(!a)return void(n?n(0,"未找到"+t+"绘制物！"):console.warn("未找到"+t+"绘制物！"));let l=a.guid;for(let t=0;t<i.length;t++)i[t].parent=a.parent||e;let c="",h=1===r._drawables.length&&!1===a.show;switch(i[0].type.toLowerCase()){case"landmark":for(let e=0;e<i.length;e++){let c=new o(i[e]);if(c.guid=l,c.tooltipEnabled)c.tooltip=a.tooltip;else{c.tooltip=!1;let e=document.getElementById(`_sys_layer_info_panel__${a.layer}_${a.name}_landmark`);e&&(e.remove(),it(a.name))}r.updateDrawable(t,c),s("updateMarker",rt(c.getRequsetParams()),c,t,n)}break;case"bubble":for(let e=0;e<i.length;e++){let n=new u(i[e],!1,!0);n.guid=l,r.updateDrawable(t,n)}let e=r.getDrawables(),p=[];for(let t=0;t<e.length;t++){let i=rt(e[t].getRequsetParams());p.push(i)}this.sendHttpRequest("addBubble",p,((e,t)=>{n&&n(e,t)}));break;case"bar":c=h?"addHistogram":"updateHistogram";for(let e=0;e<i.length;e++){let n=new f(i[e]);n.guid=l,r.updateDrawable(t,n)}let d=r.getDrawables(),w=[];for(let e=0;e<d.length;e++){let t=rt(d[e].getRequsetParams());w.push(t)}this.sendHttpRequest(c,w,((e,t)=>{n&&n(e,t)}));break;case"link":c=h?"addLink":"updateLink";for(let e=0;e<i.length;e++){let n=new g(i[e]);n.guid=l,r.updateDrawable(t,n)}let k=r.getDrawables(),_=[];for(let e=0;e<k.length;e++){let t=rt(k[e].getRequsetParams());_.push(t)}this.sendHttpRequest(c,_,((e,t)=>{n&&n(e,t)}));break;case"trailplayback":c=h?"addHistory":"updateHistory";for(let e=0;e<i.length;e++){let n=new y(i[e]);n.guid=l,n.guidName=r.getDrawable(t).guidName,r.updateDrawable(t,n)}let D=r.getDrawables(),E=[];for(let e=0;e<D.length;e++){let t=rt(D[e].getRequsetParams());E.push(t)}this.sendHttpRequest(c,E,((e,t)=>{n&&n(e,t)}));break;case"trail":c=h?"addPlayback":"updatePlayback";for(let e=0;e<i.length;e++){let n=new m(i[e]);if(n.guid=l,n.tooltipEnabled)n.tooltip=a.tooltip;else{n.tooltip=!1;let e=document.getElementById(`_sys_layer_info_panel__${a.layer}_${a.name}_trail`);e&&(e.remove(),it(a.name))}r.updateDrawable(t,n)}let P=r._drawables,x=[],R=[];for(let e=0;e<P.length;e++)R.push(P[e]),x.push(rt(P[e].getRequsetParams()));s(c,x,P,t,n);break;case"area":c=h?"addRange":"updateRange";for(let e=0;e<i.length;e++){let n=new b(i[e]);n.guid=l,r.updateDrawable(t,n)}let L=r.getDrawables(),I=[];for(let e=0;e<L.length;e++)I.push(L[e].getRequsetParams());this.sendHttpRequest(c,I,((e,t)=>{n&&n(e,t)}));break;case"electricfence":c=h?"addElectricFence":"updateElectricFence";for(let e=0;e<i.length;e++){let n=new v(i[e]);n.guid=l,r.updateDrawable(t,n)}let H=r.getDrawables(),O=[];for(let e=0;e<H.length;e++)O.push(H[e].getRequsetParams());this.sendHttpRequest(c,O,((e,t)=>{n&&n(e,t)}));break;case"trafficjam":c=h?"addTrafficJam":"updateTrafficJam";for(let e=0;e<i.length;e++){let n=new S(i[e]);n.guid=l,r.updateDrawable(t,n)}let F=r.getDrawables(),M=[];for(let e=0;e<F.length;e++)M.push(F[e].getRequsetParams());this.sendHttpRequest(c,M,((e,t)=>{n&&n(e,t)}));break;case"fireflyeffect":let N=new T(i[0]);N.guid=l,r.updateDrawable(t,N);let q=r.getDrawable(t).getRequsetParams();this.sendHttpRequest("updateFireflyEffect",q,((e,t)=>{n&&n(e,t)}));break;case"informationrain":let z=new C(i[0]);z.guid=l,r.updateDrawable(t,z);let A=r.getDrawable(t).getRequsetParams();this.sendHttpRequest("updateInformationRainEffect",A,((e,t)=>{n&&n(e,t)}))}}catch(e){n?n(0,"更新失败原因："+e):console.warn(0,"更新失败原因："+e)}function s(e,t,i,n,o){r.sendHttpRequest(e,t,((e,t)=>{o&&o(e,t);let s=[];if(e)try{let e=JSON.parse(t);e.length||(e=[e],i=[i]);for(let t=0;t<i.length;t++)if(i[t].name===n){document.getElementById(`_sys_layer_info_panel__${i[t].layer}_${i[t].name}_${i[t].type}`)&&i[t].tooltip&&(s.push(i[t]),nt(i[t])),i[t].xyzPos={srs:"xyz",coords:[e[t].x,e[t].y,e[t].z]}}s.length&&r.initShowTipPanelLazy(s,!1)}catch(e){console.log(t)}}))}}updateElectricFence(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="electricfence",i[t].layer=e;else i.type="electricfence",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateElectricFenceLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="electricfence",t[i].layer=e;else t.type="electricfence",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateTrafficJamLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="TrafficJam",t[i].layer=e;else t.type="TrafficJam",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateTrafficJam(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");if(i.length)for(let t=0;t<i.length;t++)i[t].type="TrafficJam",i[t].layer=e;else i.type="TrafficJam",i.layer=e,i=[i];this.updateDrawable(e,t,i,n)}updateHeatLayer(e,t,i){if(!e||!t||!t.percentageModels)return this.errors(i,0,"传参数有误！");t.type="Heat",t.layer=e,t=[t],this.updateLayer(e,t,i)}updateFireWorksLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");if(t.length)for(let i=0;i<t.length;i++)t[i].type="fireWorks",t[i].layer=e;else t.type="fireWorks",t.layer=e,t=[t];this.updateLayer(e,t,i)}updateFireflyEffect(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");i.type="fireflyeffect",i.layer=e,i=[i],this.updateDrawable(e,t,i,n)}updateFireflyEffectLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.type="fireflyEffect",t.layer=e,t=[t],this.updateLayer(e,t,i)}updateInformationRain(e,t,i,n){if(!e||!i)return this.errors(n,0,"传参数有误！");i.layer=e,i.type="informationrain",i=[i],this.updateDrawable(e,t,i,n)}updateInformationRainLayer(e,t,i){if(!e||!t)return this.errors(i,0,"传参数有误！");t.layer=e,t.type="informationrain",t=[t],this.updateLayer(e,t,i)}addScatterModel(e,t){!e instanceof Array?t&&t(void 0,"传入数据格式必须为数组！"):(e.forEach((e=>{e.positionType=e.positionType||"lla",e.x=e.x||0,e.y=e.y||0,e.z=e.z||0,e.rotationX=e.rotationX||0,e.rotationY=e.rotationY||0,e.rotationZ=e.rotationZ||0,e.scalingX=e.scalingX||1,e.scalingY=e.scalingY||1,e.scalingZ=e.scalingZ||1,e.animationSpeed=e.animationSpeed||0,e.maxViewDistance=e.maxViewDistance||1e4,e.minViewDistance=e.minViewDistance||0,e.isShowLayer=null==e.isShowLayer||e.isShowLayer})),this.sendHttpRequest("addScatterModel",e,t))}updateScatterModel(e,t){!e instanceof Array?t&&t(void 0,"传入数据格式必须为数组！"):(e.forEach((e=>{e.positionType=e.positionType||"lla",e.x=e.x||0,e.y=e.y||0,e.z=e.z||0,e.rotationX=e.rotationX||0,e.rotationY=e.rotationY||0,e.rotationZ=e.rotationZ||0,e.scalingX=e.scalingX||1,e.scalingY=e.scalingY||1,e.scalingZ=e.scalingZ||1,e.animationSpeed=e.animationSpeed||0,e.maxViewDistance=e.maxViewDistance||1e4,e.minViewDistance=e.minViewDistance||0,e.isShowLayer=null==e.isShowLayer||e.isShowLayer})),this.sendHttpRequest("updateScatterModel",e,t))}setScatterModelVisible(e,t){null!=e.layer&&null!=e.isShowLayer?this.sendHttpRequest("setScatterModelVisible",e,t):t&&t(void 0,"传入参数有误！")}removeScatterModel(e,t){null!=e.layer?this.sendHttpRequest("removeScatterModel",e,t):t&&t(void 0,"传入参数有误！")}setLightVisibleByName(e,t){null==e.name||e.isVisible?t&&t(void 0,"传入参数有误！"):this.sendHttpRequest("setLightVisibleByName",e,t)}setEffectVisibleByName(e,t){null==e.name||e.isVisible?t&&t(void 0,"传入参数有误！"):this.sendHttpRequest("setEffectVisibleByName",e,t)}view(e,t){e.layerName||e.name||this.errors(t,0,"参数有误！");let i=this.getLayer(e.layerName),n={x:0,y:0,z:0};if(i){let r=i.getDrawable(e.name);if(r.name===e.name){n=r.xyzPos?r.xyzPos:rt(r).position,this.panelPosControl(2e3);let i={position:n,distance:e.distance,duration:e.duration};return this.sendHttpRequest("setCameraZoomToByPosition",i,t)}this.errors(t,0,"未找到对应名称绘制元素!")}else this.errors(t,0,"未找到图层！")}xianLiuControl(e,t){Dt=e,Et=t}throttle(e,t,i){at&&(at=!1,setTimeout((()=>{at=!0,null,t(i)}),e))}}e.Area=b,e.Bar=f,e.Bubble=u,e.Camera=class{constructor(e){this.distance=e.distance||500,this.duration=e.duration||500,this.target=e.target||new s("xyz").set(0,0,0)}setCamera(e){this.target=e.cameraInfo||new s("xyz").set(0,0,0),this.distance=e.distance||500,this.duration=e.duration||500}toString(){return JSON.stringify(this)}},e.Cluster=p,e.ElectricFence=v,e.FireWorks=_,e.FireflyEffect=T,e.Heat=k,e.InfoPanel=l,e.InformationRainEffect=C,e.Landmark=o,e.Layer=r,e.ODLine=g,e.Position=s,e.Streaming=Pt,e.TrafficJam=S,e.Trail=m,e.TrailPlayback=y,e.default=Pt,Object.defineProperty(e,"__esModule",{value:!0})}));
